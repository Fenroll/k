<!DOCTYPE html>
<!-- Right-side overlay for course card click -->
    <div id="rightOverlay" class="right-overlay">
      <button class="mobile-overlay-close" onclick="closeRightOverlay()">✕</button>
      <div class="overlay-content" id="overlayContent">
        <!-- Dynamic content will be injected here -->
      </div>
    </div>

    <style>
    /* Overlay header styling to match main header */
    .overlay-header {
  background: #fff;
  color: #000;
  font-family: 'Open Sans', Arial, sans-serif;
  font-weight: 400;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: 80px;
  min-height: 80px;
  max-height: 80px;
  padding: 0 0 0 0;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #d3cdcd;
  margin: 0;
  box-sizing: border-box;
  z-index: 2101;
    }
    .overlay-header .page-title {
      font-weight: 400 !important;
      font-size: 1.6em;
      margin: 0;
      color: #262626;
    }
    .right-overlay {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 90vw;
      max-width: none;
      min-width: 0;
      background: #fff;
      box-shadow: -4px 0 24px rgba(0,0,0,0.18);
      z-index: 2000;
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(.4,0,.2,1);
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }
    .right-overlay.open {
      transform: translateX(0);
      pointer-events: auto;
    }
    @media (max-width: 900px) {
      html, body {
        height: 100vh !important;
        min-height: 100vh !important;
        overflow-x: hidden;
      }
      #side-menu {
        height: 100vh !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
        overflow-y: auto !important;
        box-shadow: 2px 0 16px rgba(0,0,0,0.18);
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(.4,0,.2,1);
        position: fixed !important;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 3200;
        width: 70vw !important;
        max-width: 260px !important;
        min-width: 200px !important;
        display: block;
      }
      #side-menu.mobile-open {
        transform: translateX(0);
      }
      .mobile-overlay {
        display: none;
      }
      .mobile-overlay.active {
        display: block !important;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100vw;
        height: 100vh;
        min-height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 3100;
      }
    }
    .overlay-ribbon {
      display: none;
      align-items: center;
      justify-content: center;
      background: #c46dd8;
      color: #fff;
      height: 48px;
      position: absolute;
      left: -29px;
      top: 24px;
      width: 48px;
      box-shadow: none;
      z-index: 2200;
      border-radius: 0;
      font-size: 2.1em;
      font-weight: 400;
    }
    .overlay-ribbon::before {
      content: '';
      position: absolute;
      left: 1px;
      top: 100%;
      width: 0;
      height: 0;
      border-left: 28px solid transparent;
      border-top: 22px solid #7c3aed;
      z-index: -1;
    }
    .right-overlay.open .overlay-ribbon {
      display: flex;
    }
    .overlay-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      margin-top: 2px;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .overlay-content {
  padding: 120px 32px 32px 58px;
      margin-top: 0;
      overflow-y: auto;
      flex: 1 1 auto;
    }
    @media (max-width: 600px) {
      .right-overlay {
        width: 100vw;
        min-width: 0;
        left: 0;
        right: 0;
      }
      .overlay-content {
        padding: 100px 12px 20px 12px;
      }
      /* Hide desktop ribbon on phones */
      .overlay-ribbon, .overlay-close { display: none !important; }
      .overlay-header {
        justify-content: center;
        text-align: center;
        padding: 10px 55px 10px 12px;
      }
      .overlay-header .page-title {
        text-align: center;
        width: 100%;
        font-size: 1.2em !important;
        line-height: 1.3 !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
      }
    }
    /* --- EVENT INFO OVERLAY STYLES (DESKTOP AND MOBILE) --- */
    .event-info-overlay {
      padding: 0;
      line-height: 1.7;
      color: #333;
    }
    .event-info-overlay h1 {
      font-size: 22px;
      margin: 0 0 12px 0;
      color: #1565c0;
      font-weight: 600;
      border-bottom: 2px solid #1565c0;
      padding-bottom: 8px;
    }
    .event-info-overlay h2 {
      font-size: 18px;
      margin: 16px 0 8px 0;
      color: #1565c0;
      font-weight: 600;
    }
    .event-info-overlay ul {
      margin: 8px 0;
      padding-left: 24px;
    }
    .event-info-overlay li {
      margin: 4px 0;
      color: #444;
    }
    .event-info-overlay ul ul {
      margin: 4px 0;
      padding-left: 20px;
    }
    .event-info-overlay p {
      margin: 8px 0;
    }
    /* --- MOBILE IMPROVEMENTS --- */
@media (max-width: 768px) {
  #side-menu {
    height: 100vh !important;
    min-height: 100vh !important;
    max-height: 100vh !important;
    overflow-y: auto !important;
  }
  .right-overlay {
    height: 100vh !important;
    min-height: 100vh !important;
    max-height: 100vh !important;
    overflow-y: auto !important;
    width: 100vw;
    left: 0;
    right: 0;
  }
  /* Ensure desktop ribbon button is hidden on mobile (incl. landscape) */
  .overlay-ribbon, .overlay-close { display: none !important; }
  .status-bar {
    display: none !important;
  }
  .element-card {
    border-radius: 12px;
    min-height: 75px;
    padding: 12px 10px !important;
    margin-bottom: 6px !important;
    display: flex;
    align-items: flex-start;
    box-sizing: border-box !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }
  .element-details-content {
    max-width: 100%;
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    padding-top: 2px;
  }
  .course-title {
    font-size: 15px !important;
    line-height: 1.25 !important;
    white-space: normal;
    word-break: normal;
    overflow-wrap: break-word;
    max-width: 100%;
    font-weight: 600 !important;
    margin-bottom: 2px !important;
    display: block;
    color: #262626 !important;
  }
  .course-id {
    font-size: 12px !important;
    opacity: 0.75;
    line-height: 1.2 !important;
    display: block;
    color: #666666 !important;
    font-weight: 500 !important;
  }
  .favorite {
    display: none !important;
  }
  
  .mobile-overlay-close {
    position: fixed;
    top: 18px;
    right: 18px;
    z-index: 3100;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s, visibility 0.3s;
  }
  .right-overlay.open .mobile-overlay-close {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  /* Скрий всички елементи от .filter-bar освен .filter-search-group */
  .filter-bar > *:not(.filter-search-group) {
    display: none !important;
  }
  
  /* Скрий "Others" само на мобилни устройства */
  .others-label {
    display: none !important;
  }
  .main-header {
    justify-content: flex-start !important;
    text-align: left !important;
    padding-left: 75px !important;
    padding-right: 16px !important;
  }
  .main-header .page-title {
    text-align: left !important;
    width: 100%;
  }
  
  /* Елементите (карти) центрирани с еднакво разстояние */
  .course-org-list {
    padding-left: 0 !important;
    padding-right: 0 !important;
    gap: 8px !important;
    overflow-x: hidden;
  }
  #dynamic-course-list {
    width: 100%;
    max-width: 100%;
    padding: 0 8px;
    box-sizing: border-box;
  }
  .archive-separator {
    width: calc(100% - 7px);
    height: 1px;
    background-color: #ddd;
    margin: 20px 0 12px 0;
  }
  .element-card {
    width: 100% !important;
    max-width: none !important;
    margin: 0 0 12px 0 !important;
  }
}
@media (min-width: 769px) {
  .mobile-overlay-close {
    display: none !important;
  }
}

/* Text Cards - Large folder-style cards */
.text-cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.text-card-big {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 24px;
  min-height: 180px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  position: relative;
  overflow: hidden;
}

.text-card-big::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
  pointer-events: none;
}

.text-card-big:hover {
  transform: translateY(-8px) scale(1.03);
  box-shadow: 0 12px 28px rgba(0,0,0,0.25);
}

.text-card-big-title {
  margin: 0 0 12px 0;
  color: white;
  font-size: 1.25em;
  font-weight: 700;
  text-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 1;
  position: relative;
  line-height: 1.3;
}

.text-card-big-preview {
  color: rgba(255, 255, 255, 0.95);
  font-size: 0.9em;
  line-height: 1.6;
  max-height: 90px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  z-index: 1;
  position: relative;
}

.text-card-big-icon {
  position: absolute;
  bottom: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  opacity: 0.25;
}

/* Modal for text content */
.text-modal {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
}

.text-modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 32px;
  border-radius: 16px;
  width: 85%;
  max-width: 800px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.text-modal-close {
  color: #aaa;
  float: right;
  font-size: 32px;
  font-weight: bold;
  line-height: 20px;
  cursor: pointer;
  transition: color 0.2s;
}

.text-modal-close:hover,
.text-modal-close:focus {
  color: #333;
}

.text-modal-title {
  margin: 0 0 24px 0;
  color: #7c3aed;
  font-size: 1.8em;
  font-weight: 700;
}

.text-modal-body {
  color: #333;
  font-size: 1.05em;
  line-height: 1.8;
  white-space: pre-wrap;
}

/* MSG Notes - Full width sticky note style */
.msg-note {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-left: 4px solid #f59e0b;
  border-radius: 8px;
  padding: 10px 14px;
  margin: 8px 0;
  width: 100%;
  box-sizing: border-box;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
}

.msg-note:hover {
  box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
  transform: translateY(-2px);
}

.msg-note-html {
  border-left: 4px solid #7c3aed !important;
  box-shadow: 0 2px 8px rgba(124, 58, 237, 0.15) !important;
}

.msg-note-html:hover {
  box-shadow: 0 4px 16px rgba(124, 58, 237, 0.25) !important;
}

.msg-note-header {
  display: flex;
  align-items: center;
  gap: 10px;
  user-select: none;
}

.msg-note-title {
  /* Title takes only the space needed (overridden inline for .md notes) */
  flex: 0 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 600;
  color: #92400e;
  font-size: 1.05em;
}

.msg-note-arrow {
  transition: transform 0.3s ease;
  flex-shrink: 0;
  margin-left: 8px; /* small gap next to title/eye */
}

.msg-note.open .msg-note-arrow {
  transform: rotate(180deg);
}

.msg-note-content {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid rgba(146, 64, 14, 0.2);
  color: #78350f;
  line-height: 1;
  animation: slideDown 0.3s ease;
}

.msg-note-content pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  font-family: inherit;
  font-size: 1em;
  margin: 0;
  padding: 0;
  background: transparent;
  border-radius: 0;
}

/* Markdown content styling */
.markdown-content {
  font-family: 'Open Sans', Arial, sans-serif;
  font-size: 0.95em;
}

.markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 {
  color: #92400e;
  margin-top: 0.8em;
  margin-bottom: 0.3em;
  font-weight: 600;
}

.markdown-content h1 { font-size: 1.5em; }
.markdown-content h2 { font-size: 1.3em; }
.markdown-content h3 { font-size: 1.1em; }
.markdown-content h4 { font-size: 1.05em; }

.markdown-content p {
  margin: 0.7em 0;
  white-space: pre-wrap;
}

/* Reduce space between paragraph and following list */
.markdown-content p + ul,
.markdown-content p + ol {
  margin-top: -0.5em;
}

/* Reduce space between heading and following content */
.markdown-content h1 + p,
.markdown-content h2 + p,
.markdown-content h3 + p,
.markdown-content h4 + p,
.markdown-content h1 + ul,
.markdown-content h2 + ul,
.markdown-content h3 + ul,
.markdown-content h4 + ul,
.markdown-content h1 + ol,
.markdown-content h2 + ol,
.markdown-content h3 + ol,
.markdown-content h4 + ol {
  margin-top: 0.1em;
}

/* Reduce space between heading and following table */
.markdown-content h1 + .table-scroll,
.markdown-content h2 + .table-scroll,
.markdown-content h3 + .table-scroll {
  margin-top: -0.5em;
}

.markdown-content h4 + .table-scroll {
  margin-top: -0.5em;
}

/* Reduce space between h3 and h4 */
.markdown-content h3 + h4 {
  margin-top: 0.3em;
}

.markdown-content ul, .markdown-content ol {
  margin: 0.3em 0;
  padding-left: 1.5em;
}

.markdown-content li {
  margin: 0.15em 0;
}

.markdown-content strong {
  font-weight: 600;
  color: #92400e;
}

.markdown-content em {
  font-style: italic;
  color: #92400e;
}

.markdown-content code {
  background: rgba(146, 64, 14, 0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.markdown-content pre {
  background: rgba(255, 255, 255, 0.5);
  padding: 12px;
  border-radius: 4px;
  overflow-x: auto;
  margin: 0.5em 0;
}

.markdown-content pre code {
  background: none;
  padding: 0;
}

.markdown-content blockquote {
  border-left: 3px solid #f59e0b;
  padding-left: 1em;
  margin: 0.5em 0;
  font-style: italic;
  color: #78350f;
}

.markdown-content a {
  color: #f59e0b;
  text-decoration: underline;
}

.markdown-content a:hover {
  color: #d97706;
}

/* Responsive images in markdown content */
.markdown-content img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 1em 0;
  border-radius: 4px;
}

/* Scrollable wrapper for wide markdown tables */
.table-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 0.5em 0;
}
.table-scroll table {
  min-width: 560px; /* ensure horizontal scroll for many columns on mobile */
}

/* Mobile tweaks for markdown readability */
@media (max-width: 768px) {
  /* Slightly smaller and lighter text on mobile for better fit */
  .markdown-content { font-size: 0.92em; font-weight: 300; }
  .markdown-content p,
  .markdown-content li,
  .markdown-content td { font-weight: 300; }
  .table-scroll table { font-size: 0.92em; }
}

/* Markdown tables with visible outlines */
.markdown-content table {
  border-collapse: collapse;
  margin: 0.75em 0;
  table-layout: auto;
}
.markdown-content th,
.markdown-content td {
  border: 1px solid rgba(146,64,14,0.35);
  padding: 6px 10px;
  text-align: left;
  vertical-align: top;
}
.markdown-content thead th {
  background: rgba(196, 127, 9, 0.08)
}

.markdown-content tbody tr:nth-child(odd) {
  background: rgba(146, 64, 14, 0.03);
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 1000px;
  }
    </style>
    <script>
    // Function to process table rowspans (convert ^ to rowspan)
    function processTableRowspans(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const tables = doc.querySelectorAll('table');
      
      tables.forEach(table => {
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        // Process each column
        const maxCols = Math.max(...rows.map(row => row.cells.length));
        
        for (let colIndex = 0; colIndex < maxCols; colIndex++) {
          let spanStart = -1;
          let spanCount = 0;
          
          for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
            const cell = rows[rowIndex].cells[colIndex];
            
            if (!cell) continue;
            
            const cellText = cell.textContent.trim();
            
            if (cellText === '^') {
              // Mark cell for deletion and count span
              cell.setAttribute('data-delete', 'true');
              spanCount++;
            } else {
              // If we were counting spans, apply rowspan
              if (spanCount > 0 && spanStart >= 0) {
                const spanCell = rows[spanStart].cells[colIndex];
                if (spanCell) {
                  spanCell.setAttribute('rowspan', spanCount + 1);
                }
              }
              // Reset for next potential span
              spanStart = rowIndex;
              spanCount = 0;
            }
          }
          
          // Handle trailing spans
          if (spanCount > 0 && spanStart >= 0) {
            const spanCell = rows[spanStart].cells[colIndex];
            if (spanCell) {
              spanCell.setAttribute('rowspan', spanCount + 1);
            }
          }
        }
        
        // Remove cells marked for deletion
        table.querySelectorAll('[data-delete="true"]').forEach(cell => cell.remove());
      });
      
      return doc.body.innerHTML;
    }

    // Function to process table colspans (convert < to colspan)
    function processTableColspans(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const tables = doc.querySelectorAll('table');
      
      tables.forEach(table => {
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        // Process each row
        rows.forEach(row => {
          const cells = Array.from(row.cells);
          let spanStart = -1;
          let spanCount = 0;
          
          for (let colIndex = 0; colIndex < cells.length; colIndex++) {
            const cell = cells[colIndex];
            const cellText = cell.innerHTML.trim();
            
            if (cellText === '&lt;') {
              // Mark cell for deletion and count span
              cell.setAttribute('data-delete-colspan', 'true');
              spanCount++;
            } else {
              // If we were counting spans, apply colspan
              if (spanCount > 0 && spanStart >= 0) {
                const spanCell = cells[spanStart];
                if (spanCell) {
                  spanCell.setAttribute('colspan', spanCount + 1);
                }
              }
              // Reset for next potential span
              spanStart = colIndex;
              spanCount = 0;
            }
          }
          
          // Handle trailing spans
          if (spanCount > 0 && spanStart >= 0) {
            const spanCell = cells[spanStart];
            if (spanCell) {
              spanCell.setAttribute('colspan', spanCount + 1);
            }
          }
        });
        
        // Remove cells marked for deletion
        table.querySelectorAll('[data-delete-colspan="true"]').forEach(cell => cell.remove());
      });
      
      return doc.body.innerHTML;
    }

    // Function to process table cell alignment (>>text<<, <<text, text>>)
    function processTableAlignment(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const tables = doc.querySelectorAll('table');
      
      tables.forEach(table => {
        const allCells = table.querySelectorAll('td, th');
        
        allCells.forEach(cell => {
          let content = cell.innerHTML.trim();
          
          // Check for center alignment >>text<<
          if (content.startsWith('&gt;&gt;') && content.endsWith('&lt;&lt;')) {
            cell.style.textAlign = 'center';
            cell.innerHTML = content.slice(8, -8); // Remove &gt;&gt; and &lt;&lt;
          }
          // Check for left alignment <<text
          else if (content.startsWith('&lt;&lt;')) {
            cell.style.textAlign = 'left';
            cell.innerHTML = content.slice(8); // Remove &lt;&lt;
          }
          // Check for right alignment text>>
          else if (content.endsWith('&gt;&gt;')) {
            cell.style.textAlign = 'right';
            cell.innerHTML = content.slice(0, -8); // Remove &gt;&gt;
          }
        });
      });
      
      return doc.body.innerHTML;
    }
    
    // Overlay logic for course cards
    document.addEventListener('DOMContentLoaded', function() {
      // Close overlay when clicking outside overlay-content
      var overlay = document.getElementById('rightOverlay');
      if (overlay) {
        overlay.addEventListener('mousedown', function(e) {
          // Only close if clicking directly on the overlay background, not on content or ribbon/close
          if (e.target === overlay) {
            closeRightOverlay();
          }
        });
      }
      
      var courseList = document.getElementById('course-org-list');
      if (courseList) {
        courseList.querySelectorAll('.element-card').forEach(function(card) {
          card.style.cursor = 'pointer';
          card.addEventListener('click', function(e) {
            openRightOverlayForCard(card);
            e.stopPropagation();
          });
        });
      }
    });
  function openRightOverlayForCard(card) {
  var overlay = document.getElementById('rightOverlay');
  var content = document.getElementById('overlayContent');
  if (overlay && content) {
    var title = card.querySelector('.course-title')?.textContent || 'Course';
    var courseId = card.querySelector('.course-id')?.textContent || '';
    var isArchivedCard = card.style.opacity === '0.75'; // Archived cards have opacity
    
    // Find the course - need to check if it's archived or active
    var courseObj;
    if (isArchivedCard) {
      // For archived cards, find in archived courses only
      courseObj = courses.find(c => c.id === courseId && c.isArchived === true);
    } else {
      // For active cards, find in active courses only
      courseObj = courses.find(c => c.id === courseId && (!c.isArchived || c.isArchived === false));
    }
    
    let customContent = '';
    
    // Check if this is "Актуални събития Event center" course - show event info instead
    if (title.includes('Актуални събит') || title.includes('Event center')) {
      if (typeof eventInfo !== 'undefined' && eventInfo && eventInfo.trim().length > 0) {
        customContent = `<div class="event-info-overlay">` + marked.parse(eventInfo) + `</div>`;
      } else {
        customContent = '<div style="color:#888;">Няма информация за актуални събития.</div>';
      }
    } else {
      // Render text cards if available
      if (courseObj && Array.isArray(courseObj.textCards) && courseObj.textCards.length > 0) {
        customContent += `<div class="text-cards-container">`;
        courseObj.textCards.forEach(card => {
          customContent += renderTextCardBig(card);
        });
        customContent += `</div>`;
      }
      
      if (courseObj && Array.isArray(courseObj.sections) && courseObj.sections.length > 0) {
        customContent += `<div style="display:flex; flex-direction:column; gap:18px;">`;
        courseObj.sections.forEach(section => {
          // Sort files and folders before rendering
          sortFilesAndFolders(section);
          customContent += renderSection(section, 1); // 1 = first level sections (Материали, Колоквиум I, etc.)
        });
        customContent += `</div>`;
      } else if (!courseObj || !courseObj.textCards || courseObj.textCards.length === 0) {
        customContent = '<div style="color:#888;">Няма съдържание за този курс.</div>';
      }
    }
    
    // Function to render big text card (folder-style)
    // Natural sort function for proper number ordering
    function naturalSort(a, b) {
      const regex = /(\d+)|(\D+)/g;
      const aParts = a.match(regex);
      const bParts = b.match(regex);
      
      for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
        const aPart = aParts[i] || '';
        const bPart = bParts[i] || '';
        
        const aNum = parseInt(aPart);
        const bNum = parseInt(bPart);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          if (aNum !== bNum) return aNum - bNum;
        } else {
          if (aPart !== bPart) return aPart.localeCompare(bPart);
        }
      }
      return 0;
    }
    
    // Sort files: folders first, then by file type, then natural sort
    function sortFilesAndFolders(section) {
      if (section.files && section.files.length > 0) {
        section.files.sort((a, b) => {
          // Get file extensions
          const aExt = a.name.split('.').pop().toLowerCase();
          const bExt = b.name.split('.').pop().toLowerCase();
          
          // First sort by extension (file type)
          if (aExt !== bExt) {
            return aExt.localeCompare(bExt);
          }
          
          // Then natural sort by name
          return naturalSort(a.name.toLowerCase(), b.name.toLowerCase());
        });
      }
      
      // Sort subsections (folders) with natural sort
      if (section.subsections && section.subsections.length > 0) {
        section.subsections.sort((a, b) => {
          return naturalSort(a.name.toLowerCase(), b.name.toLowerCase());
        });
        
        // Recursively sort nested sections
        section.subsections.forEach(sub => sortFilesAndFolders(sub));
      }
    }
    
    // Helper function to remove order prefix (1-, 2-, 1.1-, 2.2-, etc.) and "msg-" from filenames for display
    function removeOrderPrefix(fileName) {
      // Remove number prefix (1-, 2-, 1.1-, 2.22-, etc.)
      let cleaned = fileName.replace(/^[\d.]+-/, '');
      // Remove "msg-" prefix (case insensitive)
      cleaned = cleaned.replace(/^msg-/i, '');
      // Remove file extension
      cleaned = cleaned.replace(/\.(txt|md|docx|pdf|doc|xls|xlsx|ppt|pptx|jpg|jpeg|png|gif|bmp|webp|svg|zip|rar|7z|log|one|onetoc2|url)$/i, '');
      return cleaned;
    }
    
    function renderTextCardBig(card) {
      const title = card.title || 'Без заглавие';
      const content = card.content || '';
      const maxLength = 200;
      const preview = content.length > maxLength ? content.substring(0, maxLength) + '...' : content;
      const cardId = 'card-' + Math.random().toString(36).substr(2, 9);
      
      return `
        <div class="text-card-big" onclick="showTextCardModal('${cardId}', '${title.replace(/'/g, "\\'")}', this.getAttribute('data-content'));"
             data-content="${content.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, '&#10;')}">
          <div>
            <h3 class="text-card-big-title">${title}</h3>
            <p class="text-card-big-preview">${preview}</p>
          </div>
          <svg class="text-card-big-icon" viewBox="0 0 24 24" fill="rgba(255,255,255,0.3)">
            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5Z"/>
          </svg>
        </div>
      `;
    }
    
    // Recursive function to render sections and subsections
    function renderSection(section, level) {
      // Level 2 (подпапки в Материали) нямат indent, level 3+ имат indent
      const indent = level === 2 ? 0 : (level > 2 ? (level - 2) * 16 : level * 16);
      const fileCount = Array.isArray(section.files) ? section.files.length : 0;
      const hasFiles = fileCount > 0;
      const hasSubsections = Array.isArray(section.subsections) && section.subsections.length > 0;
      const hasMany = fileCount > 5;
      // Level 1 (Материали, Колоквиум I): БЕЗ collapsible - винаги отворени, БЕЗ стрелка
      // Level 2+ (!!!kolokvium genetika): collapsible - затворени по подразбиране, СЪС стрелка
      const isCollapsible = level > 1;
      const sectionId = section.name.replace(/\s+/g, '').replace(/[^\w]/g, '') + '_' + level + '_' + Math.random().toString(36).substr(2, 9);
      
      let sectionContent = '';
      
      // Level 1 (first sections like "Материали") - card style, БЕЗ collapsible, винаги отворени
      if (level === 1) {
        sectionContent += `<section style="background:#f7f4fa; border-radius:10px; padding:16px 18px 10px 18px; box-shadow:0 1px 6px #e3e3e3; margin-bottom:12px;">`;
        // Title БЕЗ dropdown - винаги отворени
        sectionContent += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; min-width:0;">`;
        sectionContent += `<svg width="20" height="20" viewBox="0 0 24 24" fill="#7c3aed" style="flex-shrink:0;"><path d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/></svg>`;
        sectionContent += `<h3 style="margin:0; color:#7c3aed; font-size:1.1em; font-weight:600; word-break:break-word; overflow-wrap:break-word; min-width:0;">${section.name}</h3>`;
        sectionContent += `</div>`;
      } 
      // Nested levels - simple indent style
      else {
        sectionContent += `<div style="margin-left:${indent}px; margin-top:10px; margin-bottom:6px;">`;
        // Title with dropdown arrow for nested folders
        if (isCollapsible) {
          // Level 2+ (вложени папки) - затворени по подразбиране
          sectionContent += `<div style="display:flex; align-items:center; gap:6px; cursor:pointer; user-select:none; margin-bottom:8px; min-width:0;" onclick="toggleFileDropdown('${sectionId}')">`;
          sectionContent += `<span id="arrow-${sectionId}" style="color:#8b5cf6; font-size:0.9em; min-width:10px; transition:all 0.2s ease; flex-shrink:0;">►</span>`;
          sectionContent += `<svg width="18" height="18" viewBox="0 0 24 24" fill="#8b5cf6" style="flex-shrink:0;"><path d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/></svg>`;
          const label = hasMany ? `${section.name} (${fileCount})` : section.name;
          sectionContent += `<h4 style="margin:0; color:#8b5cf6; font-size:${1.0 - level * 0.05}em; font-weight:500; flex:1; word-break:break-word; overflow-wrap:break-word; min-width:0;">${label}</h4>`;
          sectionContent += `</div>`;
        } else {
          // Level 1 (основни секции) - БЕЗ стрелка, винаги отворени
          sectionContent += `<div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">`;
          sectionContent += `<svg width="18" height="18" viewBox="0 0 24 24" fill="#8b5cf6" style="flex-shrink:0;"><path d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/></svg>`;
          const label = hasMany ? `${section.name} (${fileCount})` : section.name;
          sectionContent += `<h4 style="margin:0; color:#8b5cf6; font-size:${1.0 - level * 0.05}em; font-weight:500;">${label}</h4>`;
          sectionContent += `</div>`;
        }
      }
      
      // Open collapsible container if needed
      if (isCollapsible) {
        // Level 2+ са затворени по подразбиране
        sectionContent += `<div id="files-${sectionId}" style="display:none; margin-top:8px;">`;
      }
      
      // Render msg notes (sticky notes) FIRST
      if (section.msgNotes && section.msgNotes.length > 0) {
        section.msgNotes.forEach((note, idx) => {
          // Skip files with -summary in name
          if (note.name.toLowerCase().includes('-summary')) return;
          
          const noteId = `msg-note-${sectionId}-${idx}`;
          const isHtml = /\.html$/i.test(note.path || '');
          sectionContent += `
            <div class="msg-note ${isHtml ? 'msg-note-html' : ''}" onclick="${isHtml ? `openMdNoteFull('${noteId}', '${note.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'); return false;` : `toggleMsgNote('${noteId}')`}" data-note-path="${note.path}" style="${isHtml ? 'background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); cursor: pointer;' : ''}">
              <div class="msg-note-header">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="${isHtml ? '#7c3aed' : '#f59e0b'}" style="flex-shrink:0;">
                  <path d="M20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20M6,10V8H18V10H6M6,14V12H18V14H6M6,18V16H18V18H6Z"/>
                </svg>
                <span class="msg-note-title" style="${isHtml ? 'color: #6d28d9;' : ''}">${isHtml ? removeOrderPrefix(note.name).replace(/\.html$/i, '') : removeOrderPrefix(note.name)}</span>
                ${!isHtml && /\.md$/i.test(note.path || '') ? `<a href="#" title="Отвори на цял екран" onclick="event.stopPropagation(); openMdNoteFull('${noteId}', '${note.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'); return false;" style="display:inline-flex; align-items:center; justify-content:center; margin-left:auto; margin-right:6px; text-decoration:none; flex-shrink:0;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#6d28d9" style="transition: fill 0.2s;"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
                </a>` : ''}
                ${!isHtml ? `<svg class="msg-note-arrow" width="18" height="18" viewBox="0 0 24 24">
                  <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" fill="#f59e0b"/>
                </svg>` : ''}
              </div>
              <div class="msg-note-content" id="${noteId}" style="display:none;">
                ${note.type === 'text' ? `<pre>${note.content}</pre>` : (note.type === 'markdown' ? (() => {
                  // Configure marked for GFM tables
                  marked.setOptions({
                    gfm: true,
                    breaks: false,
                    tables: true
                  });
                  // Parse markdown and fix relative image paths
                  let html = marked.parse(note.content);
                  
                  // Process tables to support rowspan with ^ syntax (only if needed)
                  if (html.includes('^')) {
                    html = processTableRowspans(html);
                  }
                  
                  // Process tables to support cell alignment with >>text<<, <<text, text>> (BEFORE colspan!)
                  if (html.includes('&gt;&gt;') || html.includes('&lt;&lt;')) {
                    html = processTableAlignment(html);
                  }
                  
                  // Process tables to support colspan with < syntax (only if needed)
                  if (html.includes('&lt;')) {
                    html = processTableColspans(html);
                  }
                  
                  // Get base directory from note path (e.g., "files/Course/Section/")
                  const basePath = note.path.substring(0, note.path.lastIndexOf('/') + 1);
                  // Fix relative image paths: any relative path (not starting with http:// or /) -> prepend basePath
                  let fixedHtml = html.replace(/<img([^>]+)src="(?!https?:\/\/)(?!\/)([^"]+)"/g, 
                    (match, attrs, src) => `<img${attrs}src="${basePath}${src}"`);
                  // Add target="_blank" to all links
                  fixedHtml = fixedHtml.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');
                  return `<div class="markdown-content">${fixedHtml}</div>`;
                })() : '<p><i>Word файл - отвори за да видиш съдържанието</i><br><a href="' + note.path + '" target="_blank" style="color:#f59e0b;">Отвори файла</a></p>')}
              </div>
            </div>
          `;
        });
      }
      
      // Render subsections (folders) BEFORE files
      if (hasSubsections) {
        section.subsections.forEach(subsection => {
          // Skip subsections with hidden- prefix or assets folders
          if (subsection.name.toLowerCase().startsWith('hidden-') || 
              subsection.name.toLowerCase() === 'assets') return;
          sectionContent += renderSection(subsection, level + 1);
        });
      }
      
      // Render files in this section AFTER subsections
      if (hasFiles) {
        // Render file list
        sectionContent += '<ul style="margin:8px 0 4px 0; padding-left:20px; list-style:none;">';
        section.files.forEach(file => {
          // Skip files with hidden- prefix or -summary suffix
          if (file.name.toLowerCase().startsWith('hidden-') || 
              file.name.toLowerCase().includes('-summary')) return;
          
          const fileName = file.name.toLowerCase();
          let fileIcon = '';
          // Determine file icon based on extension
          if (fileName.endsWith('.pdf')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#dc2626" style="flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5Z"/></svg>`;
          } else if (fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#2563eb" style="flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5Z"/></svg>`;
          } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#16a34a" style="flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5Z"/></svg>`;
          } else if (fileName.endsWith('.ppt') || fileName.endsWith('.pptx')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#ea580c" style="flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5Z"/></svg>`;
          } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png') || fileName.endsWith('.gif') || fileName.endsWith('.bmp') || fileName.endsWith('.webp') || fileName.endsWith('.svg')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#ec4899" style="flex-shrink:0;"><path d="M19,19H5V5H19M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M13.96,12.29L11.21,15.83L9.25,13.47L6.5,17H17.5L13.96,12.29Z"/></svg>`;
          } else if (fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.7z')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#f59e0b" style="flex-shrink:0;"><path d="M14,17H12V15H10V13H12V15H14M14,9H12V7H10V9H12V7H14M14,13H12V11H10V13H12V11H14M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/></svg>`;
          } else if (fileName.endsWith('.txt') || fileName.endsWith('.log') || fileName.endsWith('.md')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#6b7280" style="flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5M10,19L12,15H9V10H15V15L13,19H10Z"/></svg>`;
          } else if (fileName.endsWith('.one') || fileName.endsWith('.onetoc2')) {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#7c2d99" style="flex-shrink:0;"><path d="M19,3H5C3.89,3 3,3.89 3,5V19C3,20.11 3.89,21 5,21H19C20.11,21 21,20.11 21,19V5C21,3.89 20.11,3 19,3M12,17C9.79,17 8,15.21 8,13C8,10.79 9.79,9 12,9C14.21,9 16,10.79 16,13C16,15.21 14.21,17 12,17Z"/></svg>`;
          } else if (fileName.endsWith('.url')) {
            // Try to get favicon from the URL if available
            let faviconUrl = '';
            if (file.url) {
              try {
                const urlObj = new URL(file.url);
                const hostname = urlObj.hostname.toLowerCase();
                
                // Special handling for popular services with custom icons
                if (hostname.includes('drive.google.com') || hostname.includes('docs.google.com')) {
                  faviconUrl = 'https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png';
                } else if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
                  faviconUrl = 'https://www.youtube.com/s/desktop/d743f786/img/favicon_32x32.png';
                } else if (hostname.includes('github.com')) {
                  faviconUrl = 'https://github.githubassets.com/favicons/favicon.png';
                } else if (hostname.includes('blackboard.lol')) {
                  // Use blackboard.lol favicon for all blackboard.lol subdomains
                  faviconUrl = 'https://blackboard.lol/favicon.ico';
                } else {
                  // Use Google Favicon Service for other domains
                  faviconUrl = `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`;
                }
              } catch (e) {
                // If URL parsing fails, use default icon
              }
            }
            fileIcon = faviconUrl 
              ? `<img src="${faviconUrl}" width="18" height="18" style="flex-shrink:0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';" /><svg width="18" height="18" viewBox="0 0 24 24" fill="#3b82f6" style="flex-shrink:0;display:none;"><path d="M16.36,14C16.44,13.34 16.5,12.68 16.5,12C16.5,11.32 16.44,10.66 16.36,10H19.74C19.9,10.64 20,11.31 20,12C20,12.69 19.9,13.36 19.74,14M14.59,19.56C15.19,18.45 15.65,17.25 15.97,16H18.92C17.96,17.65 16.43,18.93 14.59,19.56M14.34,14H9.66C9.56,13.34 9.5,12.68 9.5,12C9.5,11.32 9.56,10.65 9.66,10H14.34C14.43,10.65 14.5,11.32 14.5,12C14.5,12.68 14.43,13.34 14.34,14M12,19.96C11.17,18.76 10.5,17.43 10.09,16H13.91C13.5,17.43 12.83,18.76 12,19.96M8,8H5.08C6.03,6.34 7.57,5.06 9.4,4.44C8.8,5.55 8.35,6.75 8,8M5.08,16H8C8.35,17.25 8.8,18.45 9.4,19.56C7.57,18.93 6.03,17.65 5.08,16M4.26,14C4.1,13.36 4,12.69 4,12C4,11.31 4.1,10.64 4.26,10H7.64C7.56,10.66 7.5,11.32 7.5,12C7.5,12.68 7.56,13.34 7.64,14M12,4.03C12.83,5.23 13.5,6.57 13.91,8H10.09C10.5,6.57 11.17,5.23 12,4.03M18.92,8H15.97C15.65,6.75 15.19,5.55 14.59,4.44C16.43,5.07 17.96,6.34 18.92,8M12,2C6.47,2 2,6.5 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>`
              : `<svg width="18" height="18" viewBox="0 0 24 24" fill="#3b82f6" style="flex-shrink:0;"><path d="M16.36,14C16.44,13.34 16.5,12.68 16.5,12C16.5,11.32 16.44,10.66 16.36,10H19.74C19.9,10.64 20,11.31 20,12C20,12.69 19.9,13.36 19.74,14M14.59,19.56C15.19,18.45 15.65,17.25 15.97,16H18.92C17.96,17.65 16.43,18.93 14.59,19.56M14.34,14H9.66C9.56,13.34 9.5,12.68 9.5,12C9.5,11.32 9.56,10.65 9.66,10H14.34C14.43,10.65 14.5,11.32 14.5,12C14.5,12.68 14.43,13.34 14.34,14M12,19.96C11.17,18.76 10.5,17.43 10.09,16H13.91C13.5,17.43 12.83,18.76 12,19.96M8,8H5.08C6.03,6.34 7.57,5.06 9.4,4.44C8.8,5.55 8.35,6.75 8,8M5.08,16H8C8.35,17.25 8.8,18.45 9.4,19.56C7.57,18.93 6.03,17.65 5.08,16M4.26,14C4.1,13.36 4,12.69 4,12C4,11.31 4.1,10.64 4.26,10H7.64C7.56,10.66 7.5,11.32 7.5,12C7.5,12.68 7.56,13.34 7.64,14M12,4.03C12.83,5.23 13.5,6.57 13.91,8H10.09C10.5,6.57 11.17,5.23 12,4.03M18.92,8H15.97C15.65,6.75 15.19,5.55 14.59,4.44C16.43,5.07 17.96,6.34 18.92,8M12,2C6.47,2 2,6.5 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>`;
          } else {
            fileIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#6b7280" style="flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9L13,3.5V9H18.5Z"/></svg>`;
          }

          sectionContent += `<li style="margin-bottom:6px; font-size:0.95em; display:flex; align-items:center; gap:8px; min-width:0;">`;
          sectionContent += fileIcon;

          // Check if it's a .url file
          if (fileName.endsWith('.url') && file.url) {
            // Open the URL directly
            const displayName = file.name.replace('.url', '');
            sectionContent += `<a href="${file.url}" target="_blank" style="color:#6d28d9; text-decoration:none; font-weight:400; transition:color 0.2s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;" onmouseover="this.style.color='#7c3aed'; this.style.textDecoration='underline'" onmouseout="this.style.color='#6d28d9'; this.style.textDecoration='none'">${removeOrderPrefix(displayName)}</a></li>`;
          } 
          // Check if it's a viewable Office file (Word, PowerPoint, Excel)
      else if (fileName.endsWith('.docx') || fileName.endsWith('.pptx') || fileName.endsWith('.ppt') || 
        fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.doc')) {
            // Encode the full URL properly with cache busting
            const timestamp = new Date().getTime();
            const fileUrlWithCacheBust = `https://fenroll.github.io/k/${file.path}?v=${timestamp}`;
            const fullUrl = encodeURIComponent(fileUrlWithCacheBust);
            const viewerUrl = `https://docs.google.com/viewer?url=${fullUrl}&embedded=true`;
            const eyeIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#6d28d9" style="transition: fill 0.2s;"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>`;
            sectionContent += `<a href="${file.path}" download style="color:#6d28d9; text-decoration:none; font-weight:400; transition:color 0.2s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;" onmouseover="this.style.color='#7c3aed'; this.style.textDecoration='underline'" onmouseout="this.style.color='#6d28d9'; this.style.textDecoration='none'">${removeOrderPrefix(file.name)}</a><a href="${viewerUrl}" target="_blank" title="Преглед" style="display:inline-flex; align-items:center; justify-content:center; margin-left:6px; text-decoration:none; flex-shrink:0; position: static !important;" onmouseover="this.querySelector('svg').style.fill='#7c3aed'" onmouseout="this.querySelector('svg').style.fill='#6d28d9'">${eyeIcon}</a></li>`;
          }
          // Markdown files: open in our full-screen viewer; place eye icon next to title
          else if (fileName.endsWith('.md')) {
            const mdViewerUrl = `md-viewer.html?path=${encodeURIComponent(file.path)}`;
            const eyeIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#6d28d9" style="transition: fill 0.2s;"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>`;
            sectionContent += `<a href="${file.path}" download style="color:#6d28d9; text-decoration:none; font-weight:400; transition:color 0.2s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;" onmouseover="this.style.color='#7c3aed'; this.style.textDecoration='underline'" onmouseout="this.style.color='#6d28d9'; this.style.textDecoration='none'">${removeOrderPrefix(file.name)}</a><a href="${mdViewerUrl}" target="_blank" title="Преглед" style="display:inline-flex; align-items:center; justify-content:center; margin-left:6px; text-decoration:none; flex-shrink:0; position: static !important;" onmouseover="this.querySelector('svg').style.fill='#7c3aed'" onmouseout="this.querySelector('svg').style.fill='#6d28d9'">${eyeIcon}</a></li>`;
          }
         else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png') || fileName.endsWith('.gif') || fileName.endsWith('.bmp') || fileName.endsWith('.webp') || fileName.endsWith('.svg')) {
  const eyeIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#6d28d9" style="transition: fill 0.2s;"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z\"/></svg>`;
  const allImages = section.files.filter(f => /\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(f.name));
  const currentIndex = allImages.findIndex(f => f.name === file.name);
  window._currentImageList = allImages;
  sectionContent += `<a href="${file.path}" download style="color:#6d28d9; text-decoration:none; font-weight:400; transition:color 0.2s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;" onmouseover="this.style.color='#7c3aed'; this.style.textDecoration='underline'" onmouseout="this.style.color='#6d28d9'; this.style.textDecoration='none'">${removeOrderPrefix(file.name)}</a><a href="#" title="Преглед" style="display:inline-flex; align-items:center; justify-content:center; margin-left:6px; text-decoration:none; flex-shrink:0;" onclick="event.preventDefault(); showImageModal('${file.path.replace(/'/g, '\\\'')}','${removeOrderPrefix(file.name).replace(/'/g, '\\\'')}', window._currentImageList, ${currentIndex})" onmouseover="this.querySelector('svg').style.fill='#7c3aed'" onmouseout="this.querySelector('svg').style.fill='#6d28d9'">${eyeIcon}</a></li>`;
}
          else {
            sectionContent += `<a href="${file.path}" target="_blank" style="color:#6d28d9; text-decoration:none; font-weight:400; transition:color 0.2s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;" onmouseover="this.style.color='#7c3aed'; this.style.textDecoration='underline'" onmouseout="this.style.color='#6d28d9'; this.style.textDecoration='none'">${removeOrderPrefix(file.name)}</a></li>`;
          }
        });
        sectionContent += '</ul>';
      }
      
      // Show "no files" message only inside opened collapsible sections
      if (isCollapsible && !section.files?.length && !section.subsections?.length) {
        sectionContent += `<div style="color:#999; font-size:0.95em; font-style:italic; margin-top:4px; padding:8px 0;">Няма файлове</div>`;
      }
      
      // Close collapsible container if needed
      if (isCollapsible) {
        sectionContent += `</div>`;
      }
      
      // Close tag based on level
      if (level === 1) {
        sectionContent += `</section>`; // Level 1 затваря section тага
      } else {
        sectionContent += `</div>`; // Level 2+ затваря div тага
      }
      return sectionContent;
    }
    content.innerHTML = `
      <div class="overlay-ribbon">
        <button class="overlay-close" onclick="closeRightOverlay()">&#10005;</button>
      </div>
      <header class="main-header overlay-header">
        <h1 class="page-title">${title}</h1>
      </header>
      <div class="overlay-main-content" style="margin-top:18px;">${customContent}</div>
    `;
    overlay.classList.add('open');
    // Скрий hamburger бутона на мобилни устройства когато overlay е отворен
    var hamburger = document.getElementById('mobileMenuToggle');
    if (hamburger && window.innerWidth <= 768) {
      hamburger.style.opacity = '0';
      hamburger.style.visibility = 'hidden';
      hamburger.style.pointerEvents = 'none';
    }
  }
}
    function closeRightOverlay() {
      var overlay = document.getElementById('rightOverlay');
      if (overlay) overlay.classList.remove('open');
      // Покажи hamburger бутона отново
      var hamburger = document.getElementById('mobileMenuToggle');
      if (hamburger && window.innerWidth <= 768) {
        hamburger.style.opacity = '';
        hamburger.style.visibility = '';
        hamburger.style.pointerEvents = '';
      }
    }
    
    // Close overlay when clicking outside on desktop
    document.addEventListener('click', function(e) {
      const overlay = document.getElementById('rightOverlay');
      const overlayContent = document.getElementById('overlayContent');
      const modal = document.getElementById('textCardModal');
      // Only close on desktop (not mobile)
      if (window.innerWidth > 768 && overlay && overlay.classList.contains('open')) {
        // Check if click is outside overlay-content and NOT inside modal
        if (!overlayContent.contains(e.target) && !e.target.closest('.element-card') && !e.target.closest('#textCardModal')) {
          closeRightOverlay();
        }
      }
    });
    
    // Function to toggle msg note content
    function toggleMsgNote(noteId) {
      const noteContent = document.getElementById(noteId);
      const noteElement = noteContent.closest('.msg-note');
      
      if (noteContent.style.display === 'none' || noteContent.style.display === '') {
        noteContent.style.display = 'block';
        noteElement.classList.add('open');
        // Wrap any markdown tables with a horizontal scroll container (mobile-friendly)
        try {
          const mdRoot = noteContent.querySelector('.markdown-content');
          if (mdRoot) {
            mdRoot.querySelectorAll('table').forEach(tbl => {
              if (!tbl.parentElement.classList.contains('table-scroll')) {
                const wrap = document.createElement('div');
                wrap.className = 'table-scroll';
                tbl.parentElement.insertBefore(wrap, tbl);
                wrap.appendChild(tbl);
              }
            });
          }
        } catch (_) { /* noop */ }
      } else {
        noteContent.style.display = 'none';
        noteElement.classList.remove('open');
      }
    }

    // Open a markdown msg-note in a full-screen new tab without fetching files
    function openMdNoteFull(noteId, rawTitle) {
      try {
        const contentEl = document.getElementById(noteId);
        if (!contentEl) return;
        
        // Find the parent msg-note element to get the note path
        const noteElement = contentEl.closest('.msg-note');
        const notePath = noteElement ? noteElement.getAttribute('data-note-path') : '';
        const basePath = notePath ? notePath.substring(0, notePath.lastIndexOf('/') + 1) : '';
        
        // Check if this is an HTML file - open in md-viewer with content passed via sessionStorage
        if (notePath && /\.html$/i.test(notePath)) {
          // Find the HTML content from courses data
          let htmlContent = '';
          if (typeof courses !== 'undefined') {
            outerLoop: for (let course of courses) {
              for (let section of course.sections) {
                if (section.msgNotes) {
                  for (let note of section.msgNotes) {
                    if (note.path === notePath && note.type === 'html') {
                      htmlContent = note.content;
                      break outerLoop;
                    }
                  }
                }
              }
            }
          }
          
          if (htmlContent) {
            // Store in sessionStorage to avoid URL length limits
            const sessionKey = 'htmlContent_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem(sessionKey, htmlContent);
            sessionStorage.setItem(sessionKey + '_path', notePath);
            
            const mdViewerUrl = `md-viewer.html?path=${encodeURIComponent(notePath)}&sessionKey=${sessionKey}`;
            window.open(mdViewerUrl, '_blank');
          }
          return;
        }
        
        // For markdown/text files, open in md-viewer or simple window
        const mdHtmlEl = contentEl.querySelector('.markdown-content');
        let htmlInner = '';
        if (mdHtmlEl) {
          htmlInner = mdHtmlEl.innerHTML;
        } else {
          const pre = contentEl.querySelector('pre');
          htmlInner = pre ? ('<pre>' + pre.textContent.replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s])) + '</pre>') : contentEl.innerHTML;
        }
        
        // Create a simple window with the content
        const w = window.open();
        if (!w) return;
        w.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${rawTitle || 'Документ'}</title>
            <style>
              body { font-family: 'Open Sans', Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 16px; background: #fafafa; }
              h1, h2, h3 { color: #333; }
              a { color: #6d28d9; }
            </style>
          </head>
          <body>
            <div>${htmlInner}</div>
          </body>
          </html>
        `);
        w.document.close();
      } catch (e) { console.error('openMdNoteFull error', e); }
    }
    
    // Function to toggle version info
    function toggleVersionInfo() {
      const versionInfo = document.getElementById('versionInfo');
      if (versionInfo.style.display === 'none') {
        versionInfo.textContent = (typeof buildTimestamp !== 'undefined' ? buildTimestamp : 'Unknown');
        versionInfo.style.display = 'inline-block';
        // Auto-hide after 5 seconds
        setTimeout(() => {
          versionInfo.style.display = 'none';
        }, 5000);
      } else {
        versionInfo.style.display = 'none';
      }
    }
    
    // Function to copy git commands
    function copyGitCommand(type) {
      let command = '';
      if (type === 'main') {
        command = 'node generate_courses.js; git add .; git commit -m "update"; git push';
      } else if (type === 'files') {
        command = 'cd files; git add .; git commit -m "update"; git push; cd ..';
      }
      
      // Copy to clipboard
      navigator.clipboard.writeText(command).then(() => {
        // Show temporary notification
        const versionInfo = document.getElementById('versionInfo');
        versionInfo.textContent = 'Copied: ' + command;
        versionInfo.style.display = 'inline-block';
        setTimeout(() => {
          versionInfo.style.display = 'none';
        }, 3000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy command');
      });
    }
    
    // Function to show text card in modal
    function showTextCardModal(cardId, title, content) {
      // Decode HTML entities
      content = content.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&#10;/g, '\n');
      
      // Create modal
      const modal = document.createElement('div');
      modal.id = 'textCardModal';
      modal.className = 'text-modal';
      modal.style.display = 'block';
      modal.onclick = function(e) {
        if (e.target === modal) closeTextCardModal();
      };
      
      const modalContent = document.createElement('div');
      modalContent.className = 'text-modal-content';
      
      modalContent.innerHTML = `
        <span class="text-modal-close" onclick="closeTextCardModal()">&times;</span>
        <h2 class="text-modal-title">${title}</h2>
        <div class="text-modal-body">${content}</div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }
    
    function closeTextCardModal() {
      const modal = document.getElementById('textCardModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeTextCardModal();
      }
    });
    
    // Keyboard shortcuts for priority HTML files (Ctrl+1, Ctrl+2, Ctrl+3)
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === '1' || e.key === '2' || e.key === '3')) {
        e.preventDefault();
        openPriorityHtmlFile(parseInt(e.key));
      }
    });
    
    // Function to open priority HTML file by number (1, 2, or 3)
    function openPriorityHtmlFile(priority) {
      if (typeof htmlPriority === 'undefined' || !htmlPriority[priority]) {
        console.warn(`Priority HTML file ${priority} not configured`);
        return;
      }
      
      const filePath = htmlPriority[priority];
      
      // Find the HTML content from courses data
      let htmlContent = '';
      if (typeof courses !== 'undefined') {
        outerLoop: for (let course of courses) {
          for (let section of course.sections) {
            if (section.msgNotes) {
              for (let note of section.msgNotes) {
                if (note.path === filePath && note.type === 'html') {
                  htmlContent = note.content;
                  break outerLoop;
                }
              }
            }
          }
        }
      }
      
      if (htmlContent) {
        // Store in sessionStorage
        const sessionKey = 'htmlContent_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem(sessionKey, htmlContent);
        sessionStorage.setItem(sessionKey + '_path', filePath);
        
        const mdViewerUrl = `md-viewer.html?path=${encodeURIComponent(filePath)}&sessionKey=${sessionKey}`;
        window.open(mdViewerUrl, '_blank');
      } else {
        console.warn(`HTML content for ${filePath} not found in courses data`);
      }
    }
    
    // Function to render DOCX files
    async function renderDocxFile(filePath, fileName) {
      try {
        // Fetch the docx file
        const response = await fetch(filePath);
        const arrayBuffer = await response.arrayBuffer();
        
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'textCardModal';
  modal.className = 'text-modal';
  modal.style.display = 'block';
        modal.onclick = function(e) {
          if (e.target === modal) closeTextCardModal();
        };
        
        const modalContent = document.createElement('div');
        modalContent.className = 'text-modal-content';
        modalContent.innerHTML = `
          <span class="text-modal-close" onclick="closeTextCardModal()">&times;</span>
          <h2 class="text-modal-title">${fileName}</h2>
          <div class="text-modal-body" id="docx-container" style="padding: 20px; background: white; max-height: 70vh; overflow-y: auto;"></div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Render the docx file
        const container = document.getElementById('docx-container');
        await docx.renderAsync(arrayBuffer, container);
        
      } catch (error) {
        console.error('Error rendering DOCX file:', error);
        alert('Грешка при зареждане на документа. Моля опитайте отново.');
      }
    }
    
    // Show image in modal overlay
    function showImageModal(imgPath, imgName, allImages = [], currentIndex = -1) {
      closeTextCardModal();
      const modal = document.createElement('div');
      modal.id = 'textCardModal';
      modal.className = 'text-modal';
      modal.style.display = 'block';
      modal.onclick = function(e) {
        if (e.target === modal) closeTextCardModal();
      };
      const modalContent = document.createElement('div');
      modalContent.className = 'text-modal-content';
      let navHtml = '';
      if (Array.isArray(allImages) && allImages.length > 1 && currentIndex >= 0) {
        navHtml = `<div style="display:flex;justify-content:center;gap:24px;margin-top:18px;">
          <button onclick="event.stopPropagation(); showImageModal('` +
            allImages[(currentIndex - 1 + allImages.length) % allImages.length].path.replace(/'/g, '\\') + `', '` +
            allImages[(currentIndex - 1 + allImages.length) % allImages.length].name.replace(/'/g, '\\') + `', window._currentImageList, ((${currentIndex} - 1 + window._currentImageList.length) % window._currentImageList.length))" style="padding:8px 18px;font-size:1.1em;border-radius:6px;border:none;background:#ede9fe;color:#6d28d9;cursor:pointer;">&#8592; Предишна</button>
          <button onclick="event.stopPropagation(); showImageModal('` +
            allImages[(currentIndex + 1) % allImages.length].path.replace(/'/g, '\\') + `', '` +
            allImages[(currentIndex + 1) % allImages.length].name.replace(/'/g, '\\') + `', window._currentImageList, ((${currentIndex} + 1) % window._currentImageList.length))" style="padding:8px 18px;font-size:1.1em;border-radius:6px;border:none;background:#ede9fe;color:#6d28d9;cursor:pointer;">Следваща &#8594;</button>
        </div>`;
      }
      modalContent.innerHTML = `
        <span class="text-modal-close" onclick="closeTextCardModal()">&times;</span>
        <h2 class="text-modal-title" style="text-align:center; margin-bottom:10px; margin-top:2px;">${imgName}</h2>
        <div class="text-modal-body" style="padding: 0; background: white; max-height: 80vh; min-height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
          <img id="modalZoomImg" src="${imgPath}" alt="${imgName}" style="max-width: 100%; max-height: 65vh; border-radius: 8px; box-shadow: 0 2px 16px rgba(0,0,0,0.12); margin: 0 auto 16px auto; display: block; transition: transform 0.2s; cursor: zoom-in;" />
          ${navHtml}
        </div>
      `;
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      // Add zoom logic after image is in DOM
      setTimeout(function() {
        const img = document.getElementById('modalZoomImg');
        if (!img) return;
        let scale = 1;
        let originX = 0.5;
        let originY = 0.5;
        img.addEventListener('wheel', function(e) {
          e.preventDefault();
          // Zoom in/out
          if (e.deltaY < 0) {
            scale = Math.min(scale + 0.15, 5);
          } else {
            scale = Math.max(scale - 0.15, 1);
          }
          // Zoom to mouse position
          const rect = img.getBoundingClientRect();
          originX = ((e.clientX - rect.left) / rect.width) * 100;
          originY = ((e.clientY - rect.top) / rect.height) * 100;
          img.style.transformOrigin = `${originX}% ${originY}%`;
          img.style.transform = `scale(${scale})`;
          img.style.cursor = scale > 1 ? 'zoom-out' : 'zoom-in';
        }, { passive: false });
        img.addEventListener('mouseleave', function() {
          scale = 1;
          img.style.transform = 'scale(1)';
          img.style.cursor = 'zoom-in';
        });
      }, 0);
    }
    </script>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif:400,700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" type="text/css" href="https://ultra.content.blackboardcdn.com/ultra/uiv3902.1.0-rel.18_6d19913/42761-1d7134afcf37578a.css">
  <!-- Marked.js library for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://ultra.content.blackboardcdn.com/ultra/uiv3902.1.0-rel.18_6d19913/33651-1d7134afcf37578a.css">
  <style>
    .toggle-btn.selected {
      background: #111 !important;
      border-color: #111 !important;
    }
    .toggle-btn img {
      filter: none;
      transition: filter 0.15s;
    }
    .toggle-btn.selected img {
      filter: brightness(0) invert(1);
    }
      /* Stray CSS removed */
      /* .toggle-btn.selected { background: #111 !important; border-color: #111 !important; } */
      /* .toggle-btn.selected img { filter: brightness(0) invert(1); } */
  .filter-select-group:last-of-type .filter-select-wrapper {
    box-shadow: none !important;
  }
  .filter-bar {
  display: flex;
  align-items: flex-end;
  gap: 18px;
  /* Ensure all filter boxes are the same width */
  }
  .filter-search-group,
  .filter-select-group:not(:last-of-type) {
    min-width: 0;
    flex: 1 1 0;
    max-width: none;
    box-sizing: border-box;
  }
  .filter-search-group {
  flex: 1 1 0;
  min-width: 0;
  max-width: none;
  .filter-bar .filter-search-group,
  .filter-bar .filter-select-group:not(:last-of-type) {
    flex-basis: 0;
    flex-grow: 1;
    max-width: none;
    min-width: 0;
  }
  }
  body { background: #f5f5f5; font-family: 'Open Sans', Arial, sans-serif; margin: 0; }
    .base-courses-header-container { background: #262626; color: #fff; padding: 1rem; }
  .page-title { font-size: 30px !important; margin-left: 30px !important; font-family: 'Noto Serif', serif; font-weight: 700; }
    .course-org-list { margin: 2rem 23px 2rem 33px; }
    .element-card {
  background: #fff;
  margin-bottom: 14px;
  display: flex;
  align-items: stretch;
  border-left: 10px solid #1976d2;
  width: calc(100% - 25px);
  height: 105px;
  outline: 1.5px solid #d3cdcd;
  outline-offset: -1.5px;
  position: relative;
  border-bottom: none;
  z-index: 0;
  margin-right: 0;
  max-width: none;
  padding: 0;
  margin-left: 0;
    }
    .element-card:hover::after {
  content: '';
  position: absolute;
  left: -10px;
  right: 0;
  bottom: -4px;
  height: 4px;
  background: #e3e3e3;
  z-index: 1;
}
    .course-banner {
  width: 120px;
  height: 100%;
      background-size: cover;
      background-position: center;
    }
    .element-details {
          padding: 0.6rem 1.2rem 0.6rem 0.8rem;
          flex: 1;
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          height: 100%;
          text-align: left;
    }
        .element-details-content {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          flex: 1;
          min-width: 0;
          position: relative;
          top: -10px;
        }
        .element-details .favorite {
          margin-left: 24px;
          align-self: flex-start;
        }
  .course-title { font-size: 14px; color: #262626; text-decoration: none; font-weight: 525; }
  .course-id { color: #888888; font-size: 14px; margin-bottom: 0.5rem; font-weight: 525; }
  .status-bar { margin-top: 0.5rem; font-size: 0.88rem; display: flex; align-items: center; gap: 8px; }
  .status-divider { display: inline-block; width: 1.5px; height: 16px; background: #444; margin: 0 8px; border-radius: 1px; vertical-align: middle; }
  .status-open { font-size: 12px; font-weight: 400; color: #666666; }
  .status-moreinfo { color: #222222; font-size: 12px; font-weight: 400; cursor: pointer; margin-left: 2px; display: flex; align-items: center; text-decoration: none; gap: 3px; }
  .status-instructors { color: #1976D2; text-decoration: underline; font-weight: 400; font-size: 14px; }
    .controls {
  text-align: right;
  min-width: 80px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  height: 100%;
  padding: 0 1.2rem;
    }
    .favorite { background: none; border: none; cursor: pointer; margin-left: 8px; }
    .base-footer { background: #262626; color: #fff; padding: 1.2rem 1rem; text-align: center; font-size: 1em; border-top: 1px solid #222; }
  .base-footer .footer-links { display: inline-block; margin-left: 1.5em; font-size: 12px !important; }
  .base-footer .footer-links a { font-size: 12px !important; }
  .base-footer a { color: #cdcdcd; margin: 0 0.7em; text-decoration: none; }
  .base-footer a:hover { text-decoration: underline; color: #fff; }
    .course-type { display: inline-block; background: #e0e0e0; color: #333; border-radius: 3px; padding: 2px 8px; font-size: 0.9em; margin-left: 8px; }
    .sidebar {
  width: 200px;
      background: #262626;
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      box-shadow: 2px 0 8px rgba(0,0,0,0.04);
    }
  .logo-header {
  background: #262626;
  width: 200px !important;
  height: 107px !important;
  min-width: 200px !important;
  min-height: 107px !important;
  max-width: 200px !important;
  max-height: 107px !important;
  text-align: center;
  border-bottom: none;
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden;
  flex: 0 0 107px !important;
  box-sizing: content-box;
  display: flex;
  align-items: center;
  justify-content: center;
    }
    .logo-header > a {
      display: block;
      margin: 0 !important;
      padding: 0 !important;
      box-sizing: content-box;
    }
    .logo-img {
      width: 168px !important;
      height: 22.55px !important;
      min-width: 168px !important;
      min-height: 22.55px !important;
      max-width: 168px !important;
      max-height: 22.55px !important;
      object-fit: contain;
      margin: 0 !important;
      display: block;
      box-sizing: content-box;
    }
    .sidebar-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .sidebar-nav li {
      margin: 0;
      position: relative;
    }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      color: #fff !important;
      text-decoration: none;
      padding: 16px 28px 16px 28px;
  font-size: 14px;
      transition: background 0.2s;
      position: relative;
      border-radius: 0;
      gap: 12px;
      flex-direction: row;
      background: #222b36;
      font-weight: 400;
    }
    .sidebar-nav .active a, .sidebar-nav li.active a {
      background: #000000;
      color: #fff !important;
      position: relative;
    }
    .sidebar-nav .active a::before, .sidebar-nav li.active a::before {
      content: '';
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: #C56FD5;
      border-radius: 0;
    }
    .sidebar-nav a:hover {
      background: #181818;
    }
    .sidebar-nav .base-navigation-button-content {
      border-radius: 0;
      background: inherit;
      color: inherit;
      padding-left: 12px;
    }
    .sidebar-nav .svg-icon {
  width: 26px;
  height: 26px;
  margin-right: -2px;
  margin-left: -2px;
  margin-top: -2px;
  margin-bottom: -2px;
  flex-shrink: 0;
  fill: #222 !important;
  stroke: #222 !important;
    }
    .sidebar, .sidebar * {
  font-family: 'Open Sans', Arial, sans-serif !important;
}
  </style>
  <script src="html-priority.js"></script>
  <script src="courses.generated.js"></script>
</head>
<body>
  <div class="layout">
  <div id="side-menu" class="mode-light hide-in-background themed-background-primary-fill-only left-off-canvas-menu color-selection-live-mode" style="background: #262626; width: 200px; min-width: 200px; max-width: 200px; position: fixed; top: 0; left: 0; height: 100vh; z-index: 100;">
      <div class="bb-inner-wrap">
        <div class="logo-header">
          <a href="https://elearn.mu-varna.bg" target="_blank" rel="noopener noreferrer">
            <img src="https://ultra.content.blackboardcdn.com/ultra/static/images/brand/blackboard_logo_white.svg" alt="Blackboard-Medical University Varna" class="logo-img makeStyleslogoContainer-0-2-5 makeStyleslogoHref-0-2-4">
          </a>
        </div>
        <nav class="sidebar-nav" aria-label="Main">
          <ul class="off-canvas-list" id="base_tools">
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="https://elearn.mu-varna.bg/ultra/institution-page">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-institution-custom.svg" alt="Institution Page" />
                <span class="link-text">Institution Page</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="https://elearn.mu-varna.bg/ultra/profile">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-profile-custom.svg" alt="Profile" />
                <span class="link-text">Профил</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="https://elearn.mu-varna.bg/ultra/stream">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-activity-custom.svg" alt="Activity" />
                <span class="link-text">Activity</span>
              </a>
            </li>
            <li class="base-navigation-button active">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="https://elearn.mu-varna.bg/ultra/course">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-courses-book.svg" alt="Courses" />
                <span class="link-text">Courses</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="calendar.html">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-calendar-custom.svg" alt="Calendar" />
                <span class="link-text">Calendar</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="https://elearn.mu-varna.bg/ultra/messages">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/svgexport-8.svg" alt="Messages" />
                <span class="link-text">Messages</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="https://elearn.mu-varna.bg/ultra/messages">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-grades-paper.svg" alt="Grades" />
                <span class="link-text">Grades</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="tests.html">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-tools-custom.svg" alt="Tools" />
                <span class="link-text">Tools</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="md-editor.html">
                <img class="svg-icon" width="22" height="22" src="elearn-mu-varna-bg/icon-signout-custom.svg" alt="Sign Out" />
                <span class="link-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="sidebar-footer-links">
          <span class="sidebar-footer-item" onclick="copyGitCommand('main')" style="cursor: pointer;">Privacy</span>
          <span class="sidebar-footer-item" onclick="copyGitCommand('files')" style="cursor: pointer;">Terms</span>
          <span class="sidebar-footer-item" onclick="toggleVersionInfo()" style="cursor: pointer;">Accessibility</span>
          <span id="versionInfo" style="display: none; position: absolute; left: 100%; bottom: 0; margin-left: 20px; padding: 3px 20px; background: #333; color: white; border-radius: 6px; font-size: 0.85em; white-space: normal; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-width: calc(100vw - 280px);"></span>
        </div>
      </div>
    </div>
    <div class="main-content">
      <header class="main-header">
        <h1 class="page-title">Courses</h1>
      </header>
      <section class="filter-bar">
  <div class="filter-toggle-buttons" style="display: flex; align-items: center; height: 42px; margin-right: -15px;">
    <div style="position: relative; display: flex;">
      <button class="toggle-btn left-btn selected" type="button" style="width: 33px; height: 33px; border: 1.5px solid #bdbdbd; border-right: none; background: #fff; display: flex; align-items: center; justify-content: center; border-radius: 0; outline: none; cursor: pointer;">
        <img src="elearn-mu-varna-bg/svgexport-13.svg" width="18" height="18" alt="Toggle 1" />
      </button>
      <div style="position:absolute; top:0; bottom:0; left:50%; width:1px; background:#bdbdbd; transform:translateX(-50%);"></div>
      <button class="toggle-btn right-btn" type="button" style="width: 33px; height: 33px; border: 1.5px solid #bdbdbdbd; border-left: none; background: #fff; display: flex; align-items: center; justify-content: center; border-radius: 0; outline: none; cursor: pointer;">
        <img src="elearn-mu-varna-bg/svgexport-14.svg" width="18" height="18" alt="Toggle 2" />
      </button>
    </div>
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const leftBtn = document.querySelector('.toggle-btn.left-btn');
      const rightBtn = document.querySelector('.toggle-btn.right-btn');
      leftBtn.addEventListener('click', function() {
        leftBtn.classList.add('selected');
        rightBtn.classList.remove('selected');
      });
      rightBtn.addEventListener('click', function() {
        rightBtn.classList.add('selected');
        leftBtn.classList.remove('selected');
      });
    });
  </script>
  </div>
  <div class="filter-search-group">
    <span class="filter-label">Search your courses</span>
    <div class="filter-search-input-wrapper">
      <input id="courses-overview-filter-search" type="text" class="filter-search-input" placeholder=" " />
      <span class="filter-search-icon" style="left:10px;top:calc(50% + 5px);transform:translateY(-50%);pointer-events:none;position:absolute;z-index:2;">
          <img src="elearn-mu-varna-bg/svgexport-15.svg" width="18" height="18" alt="Search" />
      </span>
    </div>
  </div>
  <div class="filter-select-group">
    <span class="filter-label">Terms</span>
    <div class="filter-select-wrapper">
      <svg class="filter-select-arrow arrow-down" width="18" height="18" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      <svg class="filter-select-arrow arrow-up" width="18" height="18" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
      <select id="courses-overview-filter-terms" class="filter-select">
        <option>All Terms</option>
      </select>
    </div>
  </div>
  <div class="filter-select-group">
    <span class="filter-label">Filters</span>
    <div class="filter-select-wrapper">
    <svg class="filter-select-arrow arrow-down" width="18" height="18" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    <svg class="filter-select-arrow arrow-up" width="18" height="18" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
    <select id="courses-overview-filter-filters" class="filter-select">
      <option>All courses</option>
       <option>Courses I am taking</option>
        <option>Open courses</option>
         <option>Completed courses</option>
    </select>
  </div>
  </div>
  <div class="filter-select-group" style="flex-direction: row; align-items: center;">
    <div class="filter-select-wrapper" style="flex:1;">
    <select id="courses-overview-filter-pagesize" class="filter-select">
      <option selected>25</option>
      <option>50</option>
      <option>100</option>
    </select>
    <div class="filter-select-divider"></div>
    <svg class="filter-select-arrow arrow-down" width="18" height="18" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    <svg class="filter-select-arrow arrow-up" width="18" height="18" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
  <style>
    .filter-select-wrapper {
      overflow: visible;
      position: relative;
    }
    .filter-select-divider {
      position: absolute;
      top: 20%;
      bottom: 20%;
      right: 36px;
      width: 1.5px;
      background: #ccc;
      z-index: 3;
      border-radius: 2px;
      height: 60%;
      content: '';
      display: block;
    }
    #courses-overview-filter-pagesize.filter-select {
         border-color: #bbb;
         box-shadow: 0 0 0 0 #ddd;
    }
    .filter-select-wrapper .filter-select-arrow {
      right: 10px;
      max-width: 18px;
    }
  </style>
  </div>
    <span style="margin-left: 8px; color: #444; font-size: 0.95em;">items per page</span>
  </div>
</section>
<div id="results-count" style="font-size: 14px; color: #444; font-weight: 400; margin: 0 0 1.2rem 36px; font-family: 'Open Sans', Arial, sans-serif !important; text-shadow:0.5px 0 0 #888;">5 results</div>
  <div class="course-org-list" id="course-org-list">
  <div class="others-label" style="font-size: 1.18em; color: #222; font-weight: 400; margin-bottom: 0.5rem; margin-left: 2px; font-family: 'Open Sans', Arial, sans-serif !important;">Others</div>
  <div id="dynamic-course-list"></div>
</div>
<script>
// Generate a consistent color based on course ID
function generateColorFromId(id, isArchived = false) {
  // Remove any non-numeric characters and convert to number
  const numericId = parseInt(id.replace(/\D/g, ''), 10) || 0;
  
  // Predefined color palette for better aesthetics
  const colors = [
    '#1976d2', // Blue
    '#43a047', // Green
    '#fbc02d', // Yellow
    '#8e24aa', // Purple
    '#e53935', // Red
    '#ff5722', // Orange
    '#009688', // Teal
    '#795548', // Brown
    '#607d8b', // Blue Grey
    '#f57c00', // Orange (darker)
    '#7b1fa2', // Purple (darker)
    '#388e3c', // Green (darker)
    '#1565c0', // Blue (darker)
    '#c62828', // Red (darker)
    '#00695c', // Teal (darker)
    '#5d4037'  // Brown (darker)
  ];
  
  // For archived courses, use an offset to get different colors
  let colorIndex;
  if (isArchived) {
    // Use a different offset (half the palette) for archived courses
    const offset = Math.floor(colors.length / 2);
    colorIndex = (numericId + offset) % colors.length;
  } else {
    colorIndex = numericId % colors.length;
  }
  
  // Use modulo to ensure we always get a valid color index
  return colors[colorIndex];
}

// Function to get color mapping for all courses (for debugging/reference)
function getColorMapping() {
  if (typeof courses !== 'undefined' && Array.isArray(courses)) {
    console.log('Course ID -> Color mapping:');
    courses.forEach(course => {
      const color = generateColorFromId(course.id);
      console.log(`${course.id} (${course.title}) -> ${color}`);
    });
  }
}

// Render course cards dynamically using the global courses array from courses.generated.js
function renderCourseList() {
  const list = document.getElementById('dynamic-course-list');
  list.innerHTML = '';
  if (typeof courses !== 'undefined' && Array.isArray(courses)) {
    // Separate active and archived courses
    const activeCourses = [];
    const archivedCourses = [];
    
    courses.forEach(course => {
      // Check if course is in the archived section (after all active ones)
      // We'll determine this by looking at the structure: archived ones come after active ones
      // For now, we'll check if title starts with certain patterns or use a simple heuristic
      // Actually, since generate_courses.js already separates them, we can assume the last courses might be archived
      // Better approach: we'll mark them during generation or check the structure
      // For simplicity, let's check if it has an archived marker
      const isArchived = course.isArchived || false; // We'll update generate_courses.js to set this
      
      if (isArchived) {
        archivedCourses.push(course);
      } else {
        activeCourses.push(course);
      }
    });
    
    // If we don't have explicit markers, try to detect based on position
    // (assumes generate_courses puts archived courses at the end)
    if (archivedCourses.length === 0 && activeCourses.length === 0) {
      // All courses are in the courses array, let's not separate
      activeCourses.push(...courses);
    }
    
    // Render active courses
    activeCourses.forEach(course => {
      const card = document.createElement('div');
      card.className = 'element-card';
      
      // Generate color based on course ID
      const borderColor = generateColorFromId(course.id);
      
      card.innerHTML = `
        <div class="element-details">
          <div class="element-details-content">
            <div class="course-id" style="margin-bottom:8px; font-weight:450; text-shadow:0.5px 0 0 #888;">${course.id}</div>
            <div class="course-title" style="margin-bottom:8px; font-weight:450; text-shadow:0.5px 0 0 #888;">${course.title}</div>
            <div class="status-bar" style="margin-top:0;gap:2px;line-height:1.2;display:flex;align-items:center;">
              <span class="status-open">Open</span>
              <span class="status-divider" style="margin:0 3px;"></span>
              <span class="status-instructors">Multiple Instructors</span>
              <span class="status-divider" style="margin:0 3px;"></span>
              <span class="status-moreinfo">More info</span>
            </div>
          </div>
          <button class="favorite" title="Add to your favorites">
            <svg class="svg-icon small-icon" focusable="false" aria-hidden="true">
              <use xlink:href="https://elearn.mu-varna.bg/ultra/course#icon-small-star"></use>
            </svg>
          </button>
        </div>
      `;
      
      // Apply the color as border-left style
      card.style.borderLeft = "10px solid " + borderColor;
      
      list.appendChild(card);
    });
    
    // Add archive separator if there are archived courses
    if (archivedCourses.length > 0) {
      const separator = document.createElement('div');
      separator.className = 'archive-separator';
      list.appendChild(separator);
      
      const archiveLabel = document.createElement('div');
      archiveLabel.className = 'others-label';
      archiveLabel.style.cssText = 'font-size: 1.18em; color: #222; font-weight: 400; margin-bottom: 0.5rem; margin-left: 2px; font-family: "Open Sans", Arial, sans-serif !important;';
      archiveLabel.textContent = 'Архив';
      list.appendChild(archiveLabel);
      
      // Render archived courses
      archivedCourses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'element-card';
        card.style.opacity = '0.75';
        
        // Generate color based on course ID with isArchived flag for different palette
        const borderColor = generateColorFromId(course.id, true);
        
        card.innerHTML = `
          <div class="element-details">
            <div class="element-details-content">
              <div class="course-id" style="margin-bottom:8px; font-weight:450; text-shadow:0.5px 0 0 #888;">${course.id}</div>
              <div class="course-title" style="margin-bottom:8px; font-weight:450; text-shadow:0.5px 0 0 #888;">${course.title}</div>
              <div class="status-bar" style="margin-top:0;gap:2px;line-height:1.2;display:flex;align-items:center;">
                <span class="status-open">Archived</span>
                <span class="status-divider" style="margin:0 3px;"></span>
                <span class="status-instructors">Multiple Instructors</span>
                <span class="status-divider" style="margin:0 3px;"></span>
                <span class="status-moreinfo">More info</span>
              </div>
            </div>
            <button class="favorite" title="Add to your favorites">
              <svg class="svg-icon small-icon" focusable="false" aria-hidden="true">
                <use xlink:href="https://elearn.mu-varna.bg/ultra/course#icon-small-star"></use>
              </svg>
            </button>
          </div>
        `;
        
        // Apply the color as border-left style
        card.style.borderLeft = "10px solid " + borderColor;
        
        list.appendChild(card);
      });
    }
    
    // Re-attach click listeners for overlay
    list.querySelectorAll('.element-card').forEach(function(card) {
      card.style.cursor = 'pointer';
      card.addEventListener('click', function(e) {
        openRightOverlayForCard(card);
        e.stopPropagation();
      });
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  renderCourseList();
});
</script>
      </div>
    </div>
  </div>
  <script>
    // Simple search system for filtering cards by name
    const searchInput = document.getElementById('courses-overview-filter-search');
    const courseList = document.getElementById('course-org-list');
    const resultsCount = document.getElementById('results-count');
    function updateResultsCount() {
      const visible = courseList.querySelectorAll('.element-card:not([style*="display: none"])').length;
      resultsCount.textContent = visible + (visible === 1 ? ' result' : ' results');
    }
    function filterCourses() {
      const val = searchInput.value.trim().toLowerCase();
      const cards = courseList.querySelectorAll('.element-card');
      cards.forEach(card => {
        const name = card.querySelector('.course-title')?.textContent.toLowerCase() || '';
        const id = card.querySelector('.course-id')?.textContent.toLowerCase() || '';
        if (name.includes(val) || id.includes(val)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
      updateResultsCount();
    }
    if (searchInput) {
      searchInput.addEventListener('input', filterCourses);
    }
    window.addEventListener('DOMContentLoaded', updateResultsCount);
  </script>
  <style>
  body { background: #f5f5f5; font-family: 'Open Sans', Arial, sans-serif; margin: 0; }
    .layout { display: flex; min-height: 100vh; }
  .logo-header { background: #262626; height: 107px; min-height: 107px; max-height: 107px; text-align: center; border-bottom: 2px solid #1d1b1b; padding: 0; display: flex; align-items: center; justify-content: center; }
    .logo-img { width: 168px; margin-top: 3px; }
    .sidebar-profile {
      margin-left: 8px;
      font-weight: 500;
      vertical-align: middle;
      box-shadow: 0 1px 4px rgba(229,57,53,0.15);
    }
    .main-content {
  flex: 1;
  padding: 0 0 0 200px;
  background: #f5f5f5;
  min-height: 100vh;
    }
    .main-header {
  background: #fff;
  color: #000;
  font-family: 'Open Sans', Arial, sans-serif;
  font-weight: 400;
  width: 100%;
  min-width: unset;
  /* no max-width, no margin-left */
  height: 107px;
  min-height: 107px;
  max-height: 107px;
  padding: 0;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #d3cdcd;
  /* outline removed, keep only border-bottom */
    }
    .main-header .page-title {
      font-weight: 400 !important;
    }
    .page-title { font-size: 2rem; margin: 0; }
    .filter-bar {
      display: flex;
      align-items: flex-end;
  gap: 34px;
      background: #f5f5f5;
  padding: 18px 37px 18px 35px;
      border-bottom: none;
    }
    .filter-label {
      font-size: 0.8em;
      color: #888;
      margin-bottom: 0;
      margin-left: 4px;
  font-family: 'Open Sans', Arial, sans-serif;
    }
    .filter-search-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 220px;
    }
    .filter-search-input-wrapper {
  position: relative;
  display: flex;
  align-items: flex-end;
}
    .filter-search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #888;
  pointer-events: none;
  z-index: 2;
}
    .filter-search-input {
      width: 100%;
  padding: 10px 12px 10px 40px;
      border: 1.5px solid #bdbdbd;
      border-radius: 0 !important;
      font-size: 1em;
  font-family: 'Open Sans', Arial, sans-serif;
      transition: border 0.2s;
    }
    .filter-select-group {
      display: flex;
      flex-direction: column;
      min-width: 140px;
      position: relative;
    }
    .filter-select-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .filter-select {
      width: 100%;
      padding: 10px 32px 10px 12px;
  height: 46px;
      line-height: 20px;
      border: 1.5px solid #444;
      border-radius: 0 !important;
      font-size: 1em;
      font-family: 'Roboto', Arial, sans-serif;
      background: #fff;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      margin-bottom: 0;
      margin-top: 2px;
      transition: border 0.2s;
      vertical-align: middle;
    }
    .filter-select:focus {
      border-color: #1976d2;
    }
    .filter-select-arrow {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      fill: #000;
      z-index: 2;
      opacity: 1;
      display: block;
    }
    .filter-select-arrow.arrow-up {
      opacity: 0;
    }
    .filter-select-wrapper:has(.filter-select:focus) .arrow-down {
      opacity: 0;
    }
    .filter-select-wrapper:has(.filter-select:focus) .arrow-up {
      opacity: 1;
    }
  .base-footer {
    background: #262626;
    color: #fff;
    padding: 1.2rem 1rem 1.2rem 1.2rem;
    text-align: left;
    font-size: 0.85em;
    border-top: 1px solid #222;
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    box-sizing: border-box;
  }
  .bb-inner-wrap {
    position: relative;
    height: 100%;
  }
  .sidebar-footer-links {
    position: absolute;
    left: 12px;
    bottom: 11px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 2.5px;
    font-size: 12px;
  }
  .sidebar-footer-item {
      font-size: 12px;
      color: #cdcdcd;
      text-decoration: none;
      cursor: default;
      padding: 0;
      margin: 0;
      background: none;
      border: none;
      outline: none;
      display: block;
    }
  .sidebar-footer-links a:hover {
    text-decoration: underline;
    color: #fff;
    opacity: 1;
  }
    .course-type { display: inline-block; background: #e0e0e0; color: #333; border-radius: 3px; padding: 2px 8px; font-size: 0.9em; margin-left: 8px; }
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; overflow-x: auto; }
      .main-content { padding: 0; }
      .main-header, .filter-bar, .course-org-list { padding-left: 16px; padding-right: 16px; }
      
      /* Mobile overlay header styling */
      .overlay-header {
        justify-content: center !important;
        padding-left: 16px !important;
        padding-right: 16px !important;
      }
      .overlay-header .page-title {
        font-family: 'Open Sans', Arial, sans-serif !important;
        font-size: 1.3em !important;
        font-weight: 700 !important;
        text-align: center !important;
        width: 100%;
      }
    }
  </style>
  <style>
.filter-search-group, .filter-select-group {
  position: relative;
  margin-top: 18px;
}
.filter-label {
  position: absolute;
  top: -0.8em;
  left: 12px;
  background: #f5f5f5;
  padding: 0 4px;
  font-size: 0.85em;
  color: #222;
  font-weight: normal;
  font-family: 'Open Sans', Arial, sans-serif;
  z-index: 2;
  pointer-events: none;
  transition: color 0.2s;
}
.filter-search-input,
.filter-select {
  height: 42px;
  line-height: 46px;
  padding: 0 32px 0 12px;
  border: 1.5px solid #444;
  border-radius: 0 !important;
  font-size: 1em;
  font-family: 'Open Sans', Arial, sans-serif;
  background: #fff;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  margin-bottom: 0;
  margin-top: 2px;
  transition: none;
  box-sizing: border-box;
  display: block;
}
.filter-search-input {
  padding-left: 40px;
}
</style>

<!-- Hamburger button for mobile -->
<button id="mobileMenuToggle" class="mobile-menu-toggle" aria-label="Отвори меню">
  <span></span>
  <span></span>
  <span></span>
</button>
<div class="mobile-overlay" id="mobileOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:3000;"></div>
<div class="sidemenu-overlay" id="sidemenuOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:transparent;z-index:50;"></div>

<style>
@media (max-width: 768px) {
  html, body {
    height: 100vh !important;
    min-height: 100vh !important;
    overflow-x: hidden;
  }
  #side-menu {
    height: 100vh !important;
    min-height: 100vh !important;
    max-height: 100vh !important;
    overflow-y: auto !important;
    position: fixed !important;
    top: 0;
    bottom: 0;
    width: 200px !important;
    max-width: 200px !important;
    min-width: 200px !important;
  }
  .right-overlay {
    height: 100vh !important;
    min-height: 100vh !important;
    max-height: 100vh !important;
    overflow-y: auto !important;
    position: fixed !important;
    top: 0;
    bottom: 0;
    right: 0;
  }
  .mobile-menu-toggle {
    display: flex !important;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 44px;
    height: 44px;
    background: #fff;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    position: fixed;
    top: 18px;
    left: 18px;
    z-index: 3300;
    padding: 0;
    transition: opacity 0.3s, visibility 0.3s;
  }
  #side-menu.mobile-open ~ .mobile-menu-toggle {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }
  .mobile-menu-toggle span {
    display: block;
    width: 26px;
    height: 3px;
    background: #222;
    margin: 4px 0;
    border-radius: 2px;
  }
}
@media (min-width: 769px) {
  .mobile-menu-toggle { display: none !important; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const mobileToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('side-menu');
  const mobileOverlay = document.getElementById('mobileOverlay');
  const sidemenuOverlay = document.getElementById('sidemenuOverlay');
  if (mobileToggle && sidebar && sidemenuOverlay) {
    mobileToggle.addEventListener('click', function() {
      const isOpen = sidebar.classList.contains('mobile-open');
      if (isOpen) {
        sidebar.classList.remove('mobile-open');
        sidemenuOverlay.style.display = 'none';
        document.body.style.overflow = '';
        mobileToggle.style.opacity = '';
        mobileToggle.style.visibility = '';
        mobileToggle.style.pointerEvents = '';
      } else {
        sidebar.classList.add('mobile-open');
        sidemenuOverlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
        mobileToggle.style.opacity = '0';
        mobileToggle.style.visibility = 'hidden';
        mobileToggle.style.pointerEvents = 'none';
      }
    });
    sidemenuOverlay.addEventListener('click', function() {
      sidebar.classList.remove('mobile-open');
      sidemenuOverlay.style.display = 'none';
      document.body.style.overflow = '';
      mobileToggle.style.opacity = '';
      mobileToggle.style.visibility = '';
      mobileToggle.style.pointerEvents = '';
    });
    // Затваря менюто при клик на линк
    sidebar.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', function(e) {
        // Позволяваме на линка да работи нормално
        // Затваряме менюто след малко закъснение
        setTimeout(function() {
          sidebar.classList.remove('mobile-open');
          sidemenuOverlay.style.display = 'none';
          document.body.style.overflow = '';
          mobileToggle.style.opacity = '';
          mobileToggle.style.visibility = '';
          mobileToggle.style.pointerEvents = '';
        }, 200);
      });
    });
    // Затваря менюто при resize към desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        sidebar.classList.remove('mobile-open');
        sidemenuOverlay.style.display = 'none';
        document.body.style.overflow = '';
        mobileToggle.style.opacity = '';
        mobileToggle.style.visibility = '';
        mobileToggle.style.pointerEvents = '';
      }
    });
  }
});

// Функция за показване/скриване на dropdown с файлове
function toggleFileDropdown(sectionId) {
  const dropdown = document.getElementById(`files-${sectionId}`);
  const arrow = document.getElementById(`arrow-${sectionId}`);
  
  if (dropdown && arrow) {
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
      // Отваряме - показваме съдържанието и сменяме стрелката надолу
      dropdown.style.display = 'block';
      arrow.innerHTML = '▼';
    } else {
      // Затваряме - скриваме съдържанието и сменяме стрелката надясно
      dropdown.style.display = 'none';
      arrow.innerHTML = '►';
      
      // Затваряйте всички вложени папки
      const nestedDropdowns = dropdown.querySelectorAll('[id^="files-"]');
      const nestedArrows = dropdown.querySelectorAll('[id^="arrow-"]');
      
      nestedDropdowns.forEach(nested => {
        nested.style.display = 'none';
      });
      
      nestedArrows.forEach(nestedArrow => {
        nestedArrow.innerHTML = '►';
      });
    }
  }
}
</script>

<!-- ============================================
     CHAT SYSTEM - Complete (Firebase REST + UI)
     ============================================ -->

<script src="js/chat.js?v=6"></script>

<!-- Chat Widget HTML -->
<div id="chat-widget" class="chat-widget">
  <!-- Иконка долу дясно -->
  <button class="chat-icon" id="chat-toggle" title="Отвори чат">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span class="chat-badge-count" style="display: none;">0</span>
    <span class="chat-notification-pulse"></span>
  </button>

  <!-- Чат панел -->
  <div class="chat-panel">
    <!-- Header -->
    <div class="chat-header">
      <div class="chat-header-title">
        <h3>💬 Жив Чат</h3>
      </div>
      <button class="chat-close-btn" id="chat-close" title="Затвори чат">✕</button>
    </div>

    <!-- Main container -->
    <div class="chat-container">
      <!-- Messages area -->
      <div class="chat-messages-wrapper">
        <div class="chat-messages"></div>
      </div>

      <!-- Active users sidebar -->
      <div class="chat-active-users"></div>
    </div>

    <!-- Input area -->
    <div class="chat-input-area">
      <input
        type="text"
        class="chat-input"
        placeholder="Напиши съобщение..."
        maxlength="500"
      />
      <button class="chat-send-btn" title="Изпрати">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.16151496 C3.34915502,0.9 2.40734225,0.9 1.77946707,1.4429026 C0.994623095,2.08 0.837654326,3.0226 1.15159189,3.97788954 L3.03521743,10.4188814 C3.03521743,10.5759788 3.34915502,10.7330762 3.50612381,10.7330762 L16.6915026,11.5185631 C16.6915026,11.5185631 17.1624089,11.5185631 17.1624089,12.0598639 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"></path>
        </svg>
      </button>
    </div>

    <!-- User info -->
    <div class="chat-user-info">
      Известен като: <strong id="current-user-name"></strong>
    </div>
  </div>
</div>

<style>
/* ============================================
   CHAT WIDGET STYLING
   ============================================ */

#chat-widget {
  --chat-primary: #7c3aed;
  --chat-secondary: #f3f4f6;
  --chat-border: #e5e7eb;
  --chat-text: #1f2937;
  --chat-text-light: #6b7280;
}

/* Container */
.chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 5000;
  font-family: 'Open Sans', Arial, sans-serif;
}

/* Иконка */
.chat-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--chat-primary);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
  transition: all 0.3s ease;
  position: relative;
}

.chat-icon:hover {
  background: #6d28d9;
  box-shadow: 0 6px 16px rgba(124, 58, 237, 0.4);
  transform: scale(1.1);
}

/* Бейдж - брой активни */
.chat-badge-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Notification pulse */
.chat-notification-pulse {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 16px;
  height: 16px;
  background: #22c55e;
  border-radius: 50%;
  border: 2px solid white;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.chat-icon.has-notification .chat-notification-pulse {
  animation: pulse 0.6s ease-out;
}

@keyframes pulse {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(1.5);
  }
}

/* Chat панел */
.chat-panel {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 380px;
  height: 500px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 5px 40px rgba(0, 0, 0, 0.16);
  display: flex;
  flex-direction: column;
  opacity: 0;
  pointer-events: none;
  transform: translateY(20px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.chat-panel.open {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

/* Header */
.chat-header {
  padding: 16px;
  border-bottom: 1px solid var(--chat-border);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  background: linear-gradient(135deg, var(--chat-primary) 0%, #6d28d9 100%);
  color: white;
  border-radius: 12px 12px 0 0;
}

.chat-header-title h3 {
  margin: 0 0 4px 0;
  font-size: 16px;
  font-weight: 600;
}

.chat-online-count {
  font-size: 12px;
  opacity: 0.9;
}

.chat-close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: background 0.2s;
}

.chat-close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Container */
.chat-container {
  display: flex;
  flex: 1;
  min-height: 0;
  gap: 0;
}

.chat-messages-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Message */
.chat-message {
  display: flex;
  gap: 8px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 14px;
  flex-shrink: 0;
}

.message-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.message-header {
  display: flex;
  gap: 8px;
  align-items: baseline;
}

.message-author {
  font-weight: 600;
  font-size: 13px;
  color: var(--chat-text);
}

.message-time {
  font-size: 11px;
  color: var(--chat-text-light);
}

.message-text {
  font-size: 13px;
  color: var(--chat-text);
  word-break: break-word;
  background: var(--chat-secondary);
  padding: 8px 10px;
  border-radius: 8px;
  line-height: 1.4;
}

/* Active users sidebar */
.chat-active-users {
  width: 120px;
  padding: 12px 8px;
  border-left: 1px solid var(--chat-border);
  overflow-y: auto;
  background: #fafafa;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 0;
}

.active-users-header {
  font-size: 11px;
  font-weight: 600;
  color: var(--chat-text-light);
  padding: 0 4px;
  text-transform: uppercase;
}

.active-user {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--chat-text);
  padding: 4px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
  min-width: 0;
}

.active-user:hover {
  background: var(--chat-secondary);
}

.active-user-badge {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 11px;
  flex-shrink: 0;
}

.active-user span {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 11px;
}

/* Input area */
.chat-input-area {
  display: flex;
  gap: 8px;
  padding: 12px;
  border-top: 1px solid var(--chat-border);
  background: #fafafa;
}

.chat-input {
  flex: 1;
  border: 1px solid var(--chat-border);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 13px;
  font-family: inherit;
  outline: none;
  transition: all 0.2s;
  resize: none;
}

.chat-input:focus {
  border-color: var(--chat-primary);
  box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.chat-send-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--chat-primary);
  color: white;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}

.chat-send-btn:hover {
  background: #6d28d9;
  transform: scale(1.05);
}

.chat-send-btn:active {
  transform: scale(0.95);
}

/* User info */
.chat-user-info {
  padding: 8px 12px;
  font-size: 11px;
  color: var(--chat-text-light);
  border-top: 1px solid var(--chat-border);
  background: #fafafa;
  border-radius: 0 0 12px 12px;
}

#current-user-name {
  color: var(--chat-primary);
  font-weight: 600;
}

/* Responsive - мобилен телефон */
@media (max-width: 600px) {
  .chat-panel {
    width: calc(100vw - 40px);
    height: calc(100vh - 120px);
    bottom: 100px;
    right: 20px;
    left: 20px;
    max-width: none;
  }

  .chat-active-users {
    display: none;
  }

  .chat-widget {
    bottom: 10px;
    right: 10px;
  }

  .chat-icon {
    width: 48px;
    height: 48px;
  }
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar,
.chat-active-users::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track,
.chat-active-users::-webkit-scrollbar-track {
  background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb,
.chat-active-users::-webkit-scrollbar-thumb {
  background: var(--chat-border);
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover,
.chat-active-users::-webkit-scrollbar-thumb:hover {
  background: var(--chat-text-light);
}
</style>

</body>
</html>
