<!DOCTYPE html>
<html lang="bg">
<head>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
  <script>
    // Firebase configuration (extracted from js/chat.js)
    const firebaseConfig = {
      apiKey: "API_KEY", // –ó–∞–º–µ–Ω–∏ —Å —Ç–≤–æ—è API Key
      authDomain: "med-student-chat.firebaseapp.com",
      databaseURL: "https://med-student-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "med-student-chat",
      storageBucket: "med-student-chat.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // Initialize Firebase if not already initialized
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  <script src="js/auth-guard.js?v=2026021812ca"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Calendar</title>
  
  <!-- Favicon -->
  <link rel="icon" href="favicon.svg?v=2026021812ca" type="image/svg+xml">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif:400,700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  
  <style>
  body { background: #f5f5f5; font-family: 'Open Sans', Arial, sans-serif; margin: 0; overflow-y: scroll; }
  .layout { display: flex; min-height: 100vh; }
  
  /* Sidebar styling */
  #side-menu {
    background: #262626;
    width: 200px;
    min-width: 200px;
    max-width: 200px;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 100;
  }
  
 .logo-header {
      background: #262626;
      width: 200px !important;
      height: 107px !important;
      min-width: 200px !important;
      min-height: 107px !important;
      max-width: 200px !important;
      max-height: 107px !important;
      text-align: center;
      border-bottom: none;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden;
      flex: 0 0 107px !important;
      box-sizing: content-box;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 2px solid #1d1b1b;
    }
  
  .logo-img {
    width: 240px !important;
    height: 50px !important;
    object-fit: contain;
    padding-top: 4px !important;
  }
  
  .sidebar-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .sidebar-nav a {
    display: flex;
    align-items: center;
    color: #fff !important;
    text-decoration: none;
    padding: 16px 28px 16px 12px;  /* –ù–∞–º–∞–ª–µ–Ω padding-left –Ω–∞ 20px */
    font-size: 14px;
    transition: background 0.2s;
    gap: 12px;
    background: transparent;
    font-weight: 400;
    position: relative;
    border-radius: 0;
    flex-direction: row;
  }
  
  .sidebar-nav .active a {
    background: #000000;
  }
  
  .sidebar-nav .active a::before {
    content: '';
    display: block;
    position: absolute;
    left: 0;
    top: 0;
    width: 4px;
    height: 100%;
    background: #588157; /* Fern */
  }
  
  .sidebar-nav a:hover {
    background: #181818;  /* –¢—ä–º–Ω–æ —Å–∏–≤–æ –ø—Ä–∏ hover */
  }
  
  .sidebar-nav .svg-icon {
    width: 26px;
    height: 26px;
    flex-shrink: 0;
    margin-right: -2px;
    margin-left: -2px;
    margin-top: -2px;
    margin-bottom: -2px;
  }
  
  /* Make messages icon white */
  .sidebar-nav a[href*="messages"] .svg-icon {
    filter: brightness(0) invert(1);
  }
  
  .sidebar-footer-links {
    position: absolute;
    left: 12px;
    bottom: 11px;
    display: flex;
    flex-direction: column;
    gap: 2.5px;
    font-size: 12px;
    color: #cdcdcd;
  }
  
  .sidebar-footer-item {
    font-size: 12px;
    color: #cdcdcd;
    cursor: default;
  }
  
  .sidebar-footer-item:hover {
    color: #fff;
    text-decoration: underline;
  }
  
  /* Main content */
  .main-content {
    flex: 1;
    padding: 0 0 0 200px;
    background: #f5f5f5;
    min-height: 100vh;
  }
  
  .main-header {
    background: #fff;
    color: #000;
    width: 100%;
    height: 107px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #d3cdcd;
  }
  
  .page-title {
    font-size: 30px !important;
    margin-left: 30px !important;
    font-family: 'Open Sans', serif;
    font-weight: 400;
  }
  
  /* Schedule container */
  .schedule-container {
    margin: 2rem 33px;
  }
  
  /* Current Information Panel */
  .info-panel {
    background: #fff;
    border-radius: 8px;
    padding: 24px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    min-height: 50px; /* Add this to reserve space */
    transition: opacity 0.3s ease-in-out; /* Add for smooth transition */
  }

  .schedule-notes-edit-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    border: none;
    border-radius: 6px;
    padding: 7px 12px;
    background: #588157;
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .schedule-notes-edit-btn:hover {
    background: #344e41;
  }

  .schedule-notes-last-edit {
    position: absolute;
    top: 16px;
    left: 16px;
    color: #6b7280;
    font-size: 12px;
    max-width: calc(100% - 140px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .info-panel-content {
    color: #374151;
    line-height: 1.6;
  }
  
  .info-panel-content h1 {
    font-size: 24px;
    color: #111827;
    margin: 0 0 16px 0;
    font-weight: 600;
  }
  
  .info-panel-content h2 {
    font-size: 20px;
    color: #1f2937;
    margin: 24px 0 12px 0;
    font-weight: 600;
  }
  
  .info-panel-content h3 {
    font-size: 16px;
    color: #588157;
    margin: 16px 0 8px 0;
    font-weight: 600;
  }
  
  .info-panel-content p {
    margin: 8px 0;
  }
  
  .info-panel-content ul {
    margin: 8px 0;
    padding-left: 24px;
  }
  
  .info-panel-content li {
    margin: 4px 0;
  }
  
  .info-panel-content strong {
    color: #111827;
    font-weight: 600;
  }
  
  .info-panel-content hr {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 24px 0;
  }
  
  .info-panel-content code {
    background: #f3f4f6;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
  }
  
  /* Week selector */
  .week-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 12px; /* Reduced from 24px */
    background: #fff;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  .week-btn {
    background: #588157;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .week-btn:hover {
    background: #344e41;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(124,58,237,0.3);
  }
  
  .week-btn:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
  }
  
  .week-info {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    text-align: center;
    padding: 0 10px; /* Minimal padding */
  }
  
  .week-number {
    color: #588157;
    font-size: 14px;
    display: block;
    margin-top: 4px;
  }
  
  /* Vertical Schedule Grid Styles */
  :root {
    --col-dust-grey: #dad7cd;
    --col-dry-sage: #a3b18a;
    --col-fern: #588157;
    --col-hunter: #3a5a40;
    --col-pine: #344e41;
    
    --time-col-width: 40px; /* Compact time column */
    --slot-height: 16px; /* 15 min slot height */
  }

  .calendar-wrapper {
    background: #fff;
    border-radius: 8px; /* Reduced from 16px */
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    max-width: 100%;
    margin: 0 auto;
    border: 1px solid #d3cdcd;
    /* Force clipping of sticky elements */
    mask-image: radial-gradient(white, black); 
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    overflow: hidden;
  }

  .calendar-grid {
    display: grid;
    /* Time col + 5 days */
    grid-template-columns: var(--time-col-width) repeat(5, 1fr);
    grid-auto-rows: var(--slot-height);
    position: relative;
    background: #fff;
    border-radius: 8px; /* Apply to grid directly */
    overflow: hidden;
    
    /* Vertical Lines using gradient */
    /* Time col is fixed, days are 1fr. This is hard to gradient perfectly with mix. */
    /* Fallback: use a repeating-linear-gradient that assumes approx width or just use JS for lines? */
    /* Let's use box-shadow on columns? No. */
  }
  
  /* Vertical Line Helper Class */
  .vertical-line {
      grid-row: 4 / -1; /* Start after header */
      border-right: 1px solid #f4f4f4;
      pointer-events: none;
      z-index: 1;
  }

  /* Full-column highlight for current day */
  .current-day-column {
      grid-row: 1 / -1;
      background-color: rgba(52, 78, 65, 0.07);
      pointer-events: none;
      z-index: 0;
  }

  /* Header (Days) */
  .header-cell {
    background-color: var(--col-fern);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 12px 4px; /* Reduced from 16px */
    position: sticky;
    top: 0;
    z-index: 100;
    grid-row: 1 / span 3; /* Reduced from span 4 */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 14px; /* Reduced from 15px */
    border-right: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    line-height: 1.2;
    isolation: isolate;
  }
  
  .header-cell.time-header {
    background-color: var(--col-pine);
    z-index: 101;
    left: 0; 
  }
  
  /* Explicit Column Assignment for Headers to prevent shifts */
  .calendar-grid > .header-cell:nth-child(1) { grid-column: 1; } /* Time */
  .calendar-grid > .header-cell:nth-child(2) { grid-column: 2; } /* Mon */
  .calendar-grid > .header-cell:nth-child(3) { grid-column: 3; } /* Tue */
  .calendar-grid > .header-cell:nth-child(4) { grid-column: 4; } /* Wed */
  .calendar-grid > .header-cell:nth-child(5) { grid-column: 5; } /* Thu */
  .calendar-grid > .header-cell:nth-child(6) { grid-column: 6; } /* Fri */

  /* Time Labels */
  .time-label {
    grid-column: 1;
    text-align: right;
    padding-right: 4px;
    color: #888;
    font-size: 10px;
    position: relative;
    border-right: 1px solid #eee;
    pointer-events: none;
  }

  /* Grid Lines */
  .grid-line {
    grid-column: 2 / -1;
    border-top: 1px solid #f4f4f4;
    pointer-events: none;
  }
  
  .grid-line.hour-marker {
    border-top: 1px solid #e0e0e0;
  }

  /* Event Card */
  .event-card {
    margin: 1px 2px;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 13px; /* Increased base size */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    line-height: 1.2;
    cursor: pointer;
    transition: transform 0.1s;
    z-index: 5;
  }
  
  .event-card:hover {
    transform: scale(1.02);
    z-index: 15;
  }

  .event-title {
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 15px; /* Increased from 13px */
  }
  
  .title-desktop { display: inline; }
  .title-mobile { display: none; }

  .event-time {
    font-size: 13px; /* Increased from 11px */
    opacity: 0.9;
    white-space: nowrap;
  }
  
  .event-location {
    font-size: 13px; /* Increased from 11px */
    font-style: italic;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
  }

  /* Types */
  .type-exercise {
    background: linear-gradient(135deg, #dbeafe 0%, #91c3fd 100%);
    border-left: 3px solid #2563eb;
    color: #1e40af;
  }
  
  .type-lecture {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border-left: 3px solid #9ca3af;
    color: #4b5563;
  }
  
  .type-important-lecture {
    background: linear-gradient(135deg, #e5e7eb 0%, #dad7cd 110%);
    border-left: 3px solid #646c7e;
    color: #374151;
  }
  
  .type-exam {
    background: linear-gradient(135deg, #e2aa98 0%, #d87060 100%);
    border-left: 3px solid #b34d41;
    color: #7a2f26;
  }
  
  .type-test {
    background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%);
    border-left: 3px solid #732c2c;
    color: #047857;
  }
  
  .type-makeup {
    background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
    border-left: 3px solid #f97316;
    color: #c2410c;
  }

  /* Compact mode for mobile */
  @media (max-width: 768px) {
    .title-desktop { display: none; }
    .title-mobile { display: inline; }
    .event-title { font-size: 14px; } /* Increased from 12px */
    .event-time { font-size: 12px; } /* Increased from 10px */
    .event-location { display: none; } 
    
    /* Dynamic scaling for short events on mobile */
    .short-event {
        justify-content: center;
        line-height: 1;
        padding: 1px 2px;
    }
    .short-event .event-title { font-size: 11px; margin-bottom: 0; }
    .short-event .event-time { font-size: 9px; }
    
    /* Tiny events (1 slot / 15 mins) - Single line layout */
    .tiny-event {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 0 2px;
    }
    .tiny-event .event-title { font-size: 10px; width: auto; margin-bottom: 0; }
    .tiny-event .event-time { font-size: 8px; margin-left: 4px; }
    
    :root {
       --time-col-width: 35px;
       --slot-height: 11px; /* Significantly reduced height from 16px */
    }
    
           .calendar-wrapper {
              margin-bottom: 80px; /* Force white space at the bottom */
              border-left: none;
              border-right: none;
           }    
    .event-card {
       padding: 1px 3px; /* Tighter padding for shorter rows */
    }
  }

  


  /* Modal overlay */
  .modal-overlay {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 5000;
  }
  
  .modal-overlay.open {
    opacity: 1;
    visibility: visible;
    display: flex; /* Keep display: flex for centering */
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: #fff;
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
    position: relative;
  }
  
  @keyframes slideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    font-size: 28px;
    color: #6b7280;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
  }
  
  .modal-close:hover {
    background: #f3f4f6;
    color: #000;
  }
  
  /* Exam card styles */
  .exam-card {
    background: #fff;
    border-radius: 12px;
    padding: 12px 14px 14px 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #588157;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .exam-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
  }
  
  .exam-card-header {
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .exam-card-title {
    color: #588157;
    font-size: 16px;
    font-weight: 700;
    margin: 0;
  }
  
  .exam-card-subtitle {
    color: #6b7280;
    font-size: 13px;
    margin: 0;
  }
  
  .exam-section {
    margin-bottom: 10px;
  }
  
  .exam-section:last-child {
    margin-bottom: 0;
  }
  
  .exam-section-title {
    color: #374151;
    font-size: 15px;
    font-weight: 700;
    margin: 6px 0 6px 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .exam-section-icon {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }
  
  .exam-info-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 8px;
    background: #f9fafb;
    border-radius: 4px;
    margin-bottom: 3px;
    gap: 12px;
  }
  
  .exam-info-row:last-child {
    margin-bottom: 0;
  }
  
  .exam-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 0;
  }
  
  .exam-info-item {
    display: flex;
    flex-direction: column;
    padding: 4px 8px;
    background: #f9fafb;
    border-radius: 4px;
  }
  
  .exam-info-label {
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .exam-info-value {
    color: #111827;
    font-size: 13.5px;
    font-weight: 500;
    text-align: left;
  }
  
  /* Show line break after "–∏" only on mobile */
  .mobile-break {
    display: none;
  }
  
  @media (max-width: 768px) {
    .mobile-break {
      display: block;
    }
  }
  
  .modal-title {
    margin: 0 0 8px 0;
    color: #588157;
    font-size: 1.8em;
    font-weight: 700;
  }
  
  .modal-type {
    display: inline-block;
    background: #dad7cd;
    color: #344e41;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 600;
    margin-bottom: 20px;
  }
  
  .modal-info {
    margin: 16px 0;
  }
  
  .modal-info-row {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 12px;
  }
  
  .modal-info-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    fill: #588157;
  }
  
  .modal-info-label {
    font-weight: 600;
    color: #374151;
    min-width: 100px;
  }
  
  .modal-info-value {
    color: #6b7280;
    flex: 1;
  }
  
  #modalAdditionalInfo {
    text-decoration: underline;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  #modalAdditionalInfo p {
    margin: 0;
  }
  
  #modalAdditionalInfo::-webkit-scrollbar {
    width: 8px;
  }
  
  #modalAdditionalInfo::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
  }
  
  #modalAdditionalInfo::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }
  
  #modalAdditionalInfo::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Table styles for markdown tables */
  #modalAdditionalInfo table {
    width: 100%;
    border-collapse: collapse;
    margin: 4px 0;
    font-size: 12px;
    table-layout: fixed;
  }

  #modalAdditionalInfo table thead {
    background-color: #f3f4f6;
  }

  #modalAdditionalInfo table th,
  #modalAdditionalInfo table td {
    border: 1px solid #d1d5db;
    padding: 6px 4px;
    text-align: left;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  #modalAdditionalInfo table th {
    font-weight: 700;
    color: #111827;
    background-color: #f3f4f6;
    font-size: 11px;
  }

  #modalAdditionalInfo table tbody tr:nth-child(odd) {
    background-color: #fafbfc;
  }

  #modalAdditionalInfo table tbody tr:hover {
    background-color: #f0f4f8;
  }

  #examAdditionalInfo table {
    width: 100%;
    border-collapse: collapse;
    margin: 4px 0;
    font-size: 12px;
    table-layout: fixed;
  }

  #examAdditionalInfo table thead {
    background-color: #f3f4f6;
  }

  #examAdditionalInfo table th,
  #examAdditionalInfo table td {
    border: 1px solid #d1d5db;
    padding: 6px 4px;
    text-align: left;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  #examAdditionalInfo table th {
    font-weight: 700;
    color: #111827;
    background-color: #f3f4f6;
    font-size: 11px;
  }

  #examAdditionalInfo table tbody tr:nth-child(odd) {
    background-color: #fafbfc;
  }

  #examAdditionalInfo table tbody tr:hover {
    background-color: #f0f4f8;
  }

  /* Calculator styles */
  .calc-input-group {
    margin-bottom: 12px;
  }

  .calc-input-group label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
    color: #555;
    font-size: 13px;
  }

  .calc-input-group input,
  .calc-input-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 13px;
  }

  .calc-input-group input:focus,
  .calc-input-group select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 4px rgba(52, 152, 219, 0.3);
  }

  #calcResult.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  #calcResult.warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    #side-menu {
      transform: translateX(-100%);
      transition: transform 0.3s;
      z-index: 3200;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    #side-menu.mobile-open {
      transform: translateX(0);
    }
    
    /* Prevent body scroll when menu is open */
    body.menu-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    
    /* Mobile menu overlay */
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 3100;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .mobile-menu-overlay.active {
      display: block;
      opacity: 1;
    }
    
    .main-content {
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }
    
    .main-header {
      display: flex;
      height: 60px;
      justify-content: center;
      align-items: center;
      padding: 0 !important;
      width: 100% !important;
    }
    
    .page-title {
      font-size: 22px !important;
      margin: 0 !important;
      text-align: center;
      width: 100%;
    }
    
    #weekDateRange {
      font-size: 14px;
    }
    
    .event-time {
      font-size: 9px !important;
    }
    
    .schedule-container {
      margin: 0.5rem 12px;
      overflow-x: auto;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
    }
    
    .week-selector {
      flex-wrap: nowrap;
      gap: 10px;
      padding: 6px 8px; /* Reduced vertical padding from 12px */
      justify-content: center;
      align-items: center;
      margin-bottom: 8px; /* Reduced margin to grid */
    }
    
    .week-btn {
      font-size: 13px;
      width: 44px; /* Fixed width for symmetry */
      height: 44px; /* Square touch target */
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: auto;
      flex-shrink: 0;
    }
    
    .btn-text-label {
      display: none;
    }
    
    .week-info {
      text-align: center;
      min-width: 0;
      flex: 1; /* Take all space between symmetric buttons */
      order: 0;
      margin-bottom: 0;
      font-size: 15px; 
    }
    
    .week-number {
      font-size: 13px; /* Restored close to original */
      white-space: nowrap;
    }
    
    .schedule-table {
      min-width: 100%;
      width: 100%;
      font-size: 13px;
    }
    
    .schedule-table th {
      padding: 12px 4px;
      font-size: 13px;
    }
    
    .schedule-table td {
      padding: 6px 4px;
      min-width: 0;
    }
    
    .schedule-item {
      padding: 8px;
      font-size: 12px;
      margin: 4px 0;
    }
    
    .schedule-item-subject {
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .schedule-item-type {
      font-size: 11px;
      padding: 2px 6px;
    }
    
    .schedule-item-time,
    .schedule-item-room {
      font-size: 11px;
      margin: 2px 0;
      white-space: nowrap;
    }
    
    .schedule-time {
      white-space: nowrap !important;
    }
    
    .currentInfoPanel {
      margin: 1rem 12px;
      padding: 12px;
    }

    .info-panel-content h1 {
      font-size: 20px;
    }
    
    .info-panel-content h2 {
      font-size: 18px;
    }

    .info-panel-content h3 {
      font-size: 17px;
    }
     .info-panel-content h4 {
      font-size: 14.5px;
    }
    
    .modal-content {
      padding: 24px;
      max-width: 90%;
    }
    
    .mobile-menu-toggle {
      display: flex !important;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 44px;
      height: 44px;
      background: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 3300;
      padding: 0;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .mobile-menu-toggle.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .mobile-menu-toggle span {
      display: block;
      width: 26px;
      height: 3px;
      background: #222;
      margin: 4px 0;
      border-radius: 2px;
    }
  }

  /* Extra small screens - use letter-spacing and reduce padding */
  @media (max-width: 480px) {
    .schedule-item {
      padding: 4px 0px !important;
    }
    
    .schedule-item-subject {
      letter-spacing: -0.3px !important;
    }
    
    .schedule-item-time,
    .schedule-item-room {
      letter-spacing: -0.3px !important;
    }
    
    .schedule-time {
      font-size: 11.3px !important;
      letter-spacing: -0.25px !important;
      display: block !important;
    }
    
    .schedule-table td {
      padding: 2px 2px !important;
    }
  }
  
  @media (min-width: 769px) {
    .mobile-menu-toggle {
      display: none !important;
    }
  }
  
  .bb-inner-wrap {
    position: relative;
    height: 100%;
  }

  .schedule-notes-modal-content {
    max-width: 760px;
    width: calc(100% - 32px);
  }

  .schedule-notes-modal-error {
    color: #dc2626;
    margin-bottom: 10px;
    display: none;
    font-size: 13px;
  }

  .schedule-notes-modal-actions {
    margin-top: 12px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .schedule-notes-btn {
    border: none;
    border-radius: 6px;
    padding: 10px 14px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .schedule-notes-btn.cancel {
    background: #e5e7eb;
    color: #111827;
  }

  .schedule-notes-btn.save {
    background: #588157;
    color: #fff;
  }

  .schedule-notes-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  @media (max-width: 768px) {
    .schedule-notes-last-edit {
      position: static;
      margin-bottom: 8px;
      max-width: 100%;
      white-space: normal;
    }

    .schedule-notes-edit-btn {
      top: 10px;
      right: 10px;
      padding: 6px 11px;
    }
  }
  </style>
  <link rel="stylesheet" href="css/mobile-nav.css?v=2026021812ca">
  <script src="js/version-manager.js?v=2026021812ca"></script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <div id="side-menu">
      <div class="bb-inner-wrap">
        <div class="logo-header">
          <a href="https://elearn.mu-varna.bg" target="_blank" rel="noopener noreferrer">
            <img class="logo-img" src="svg/logo-coursebook.svg?v=2026021812ca" alt="StudyBoard">
          </a>
        </div>
        <nav class="sidebar-nav" aria-label="Main">
          <ul>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content" href="https://elearn.mu-varna.bg/ultra/course">
                <img class="svg-icon" width="22" height="22" src="svg/icon-blackboard.svg?v=2026021812ca" alt="blackboard" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Blackboard</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="account.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-account.svg?v=2026021812ca" alt="Account" />
                <span class="link-text">Account</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="index.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-courses.svg?v=2026021812ca" alt="Courses" />
                <span class="link-text">Courses</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="anamnesis.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-anamnesis.svg?v=2026021812ca" alt="Anamnesis" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Anamnesis</span>
              </a>
            </li>
            <li class="base-navigation-button active">
              <a href="calendar.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-calendar.svg?v=2026021812ca" alt="Calendar" />
                <span class="link-text">Calendar</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="tools.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-tools.svg?v=2026021812ca" alt="Tools" />
                <span class="link-text">Tools</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="text-editor.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-editor.svg?v=2026021812ca" alt="Editor" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Editor</span>
              </a>
            </li>
            <li class="base-navigation-button" id="admin-button" style="display: none;">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="admin.html?v=2026021812ca">
                <img class="svg-icon" width="22" height="22" src="svg/icon-admin.svg?v=2026021812ca" alt="Admin Panel" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Admin Panel</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="#" onclick="handleLogout()">
                <img class="svg-icon" width="22" height="22" src="svg/icon-signout.svg?v=2026021812ca" alt="Sign Out" />
                <span class="link-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="sidebar-footer-links">
          <span class="sidebar-footer-item" onclick="showPrivacyModal()" style="cursor: pointer;">Privacy</span>
          <span class="sidebar-footer-item" onclick="toggleVersionInfo()" style="cursor: pointer;">Version</span>
          <span id="versionInfo" style="display: none; position: absolute; left: 100%; bottom: 0; margin-left: 20px; padding: 3px 20px; background: #333; color: white; border-radius: 6px; font-size: 0.85em; white-space: normal; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-width: calc(100vw - 280px);"></span>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <header class="main-header">
        <h1 class="page-title">Calendar</h1>
      </header>

      <!-- Schedule container -->
      <div class="schedule-container">
        <!-- Week selector -->
        <div class="week-selector">
          <button class="week-btn" id="prevWeekBtn" onclick="changeWeek(-1)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 12H18M6 12L11 7M6 12L11 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="btn-text-label">–ü—Ä–µ–¥–∏—à–Ω–∞</span>
          </button>
          
          <div class="week-info">
            <div id="weekDateRange">–°–µ–¥–º–∏—Ü–∞ 1<span style="color: #588157;"></span></div>
            <span class="week-number" id="weekNumber">4 –Ω–æ–µ–º–≤—Ä–∏ - 8 –Ω–æ–µ–º–≤—Ä–∏ 2025</span>
          </div>
          
          <button class="week-btn" id="nextWeekBtn" onclick="changeWeek(1)">
            <span class="btn-text-label">–°–ª–µ–¥–≤–∞—â–∞</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 12H18M18 12L13 7M18 12L13 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <!-- Christmas vacation screen -->
        <div id="christmasScreen" style="display: none;">
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 80px; margin-bottom: 20px;">üéÖüéÑ</div>
            <h2 style="color: #dc2626; font-size: 32px; margin-bottom: 10px;">–ö–æ–ª–µ–¥–Ω–∞ –≤–∞–∫–∞–Ω—Ü–∏—è!</h2>
            <div style="font-size: 60px;">üéÅ‚ùÑÔ∏è‚õÑ</div>
            <p style="color: #9ca3af; margin-top: 30px; font-size: 14px;">–ß–µ—Å—Ç–∏—Ç–∞ –ö–æ–ª–µ–¥–∞ –∏ –©–∞—Å—Ç–ª–∏–≤–∞ –ù–æ–≤–∞ –ì–æ–¥–∏–Ω–∞! üéâ</p>
          </div>
        </div>

        <!-- Exam period screen -->
        <div id="examScreen" style="display: none;">
          <div style="padding: 10px 20px;">
            <div id="examsList" style="display: grid; gap: 20px; max-width: 900px; margin: 0 auto;">
              <!-- Exams will be rendered here by JavaScript -->
            </div>
          </div>
        </div>

        <div id="scheduleGrid" class="calendar-grid">
          <!-- Header Row -->
          <div class="header-cell time-header"></div>
          <div class="header-cell">–ü–û–ù</div>
          <div class="header-cell">–í–¢</div>
          <div class="header-cell">–°–†</div>
          <div class="header-cell">–ß–ï–¢</div>
          <div class="header-cell">–ü–ï–¢</div>
          <!-- Grid Content will be injected by JS -->
        </div>
        
        <!-- Current Information Panel -->
        <div id="currentInfoPanel" class="info-panel">
          <div id="scheduleNotesLastEdit" class="schedule-notes-last-edit">Last edit: ‚Äî</div>
          <button id="editScheduleNotesBtn" class="schedule-notes-edit-btn" type="button">Edit</button>
          <div class="info-panel-content" id="infoContent">
            Loading schedule notes...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile menu overlay -->
  <div id="mobileMenuOverlay" class="mobile-menu-overlay"></div>



  <!-- Modal for schedule details -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <h2 class="modal-title" id="modalSubject"></h2>
      <span class="modal-type" id="modalType"></span>
      <div class="modal-info">
        <div class="modal-info-row">
          <svg class="modal-info-icon" viewBox="0 0 24 24">
            <path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
          </svg>
          <div>
            <div class="modal-info-label">–ß–∞—Å:</div>
            <div class="modal-info-value" id="modalTime"></div>
          </div>
        </div>
        <div class="modal-info-row" id="modalBuildingRow">
          <svg class="modal-info-icon" viewBox="0 0 24 24">
            <path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/>
          </svg>
          <div>
            <div class="modal-info-label">–°–≥—Ä–∞–¥–∞:</div>
            <div class="modal-info-value" id="modalBuilding"></div>
          </div>
        </div>
        <div class="modal-info-row">
          <svg class="modal-info-icon" viewBox="0 0 24 24">
            <path d="M5,3V21H11V17.5H13V21H19V3H5M7,5H9V7H7V5M11,5H13V7H11V5M15,5H17V7H15V5M7,9H9V11H7V9M11,9H13V11H11V9M15,9H17V11H15V9M7,13H9V15H7V13M11,13H13V15H11V13M15,13H17V15H15V13M7,17H9V19H7V17M15,17H17V19H15V17Z"/>
          </svg>
          <div>
            <div class="modal-info-label">–°—Ç–∞—è:</div>
            <div class="modal-info-value" id="modalRoomInfo">
              <span id="modalRoom"></span><span id="modalFloorText"></span>
            </div>
          </div>
        </div>
        <div class="modal-info-row">
          <svg class="modal-info-icon" viewBox="0 0 24 24">
            <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
          </svg>
          <div>
            <div class="modal-info-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª:</div>
            <div class="modal-info-value" id="modalTeacher"></div>
          </div>
        </div>
        
        <div id="modalAdditionalInfoRow" class="modal-info-row" style="display: none;">
          <svg class="modal-info-icon" viewBox="0 0 24 24">
            <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"/>
          </svg>
          <div>
            <div class="modal-info-label">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</div>
            <div class="modal-info-value" id="modalAdditionalInfo"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Exam Info Modal -->
  <div class="modal-overlay" id="examInfoModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeExamModal()">√ó</button>
      <h2 class="modal-title">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
      
      <!-- Calculator Section (hidden by default) -->
      <div id="calculatorSection" style="display: none; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
        <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 1.1em; text-align: center;">–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –Ω–∞ –∏–∑–ø–∏—Ç–∞</h3>
        
        <div class="calc-input-group">
          <label for="calcAnnualGrade">–ì–æ–¥–∏—à–Ω–∞ –æ—Ü–µ–Ω–∫–∞:</label>
          <input type="number" id="calcAnnualGrade" step="0.01" min="2" max="6" placeholder="–ù–∞–ø—Ä. 5.00">
        </div>

        <div class="calc-input-group">
          <label for="calcTargetGrade">–ñ–µ–ª–∞–Ω–∞ –∫—Ä–∞–π–Ω–∞ –æ—Ü–µ–Ω–∫–∞:</label>
          <select id="calcTargetGrade">
            <option value="3.50">3.50 (–î–æ–±—ä—Ä)</option>
            <option value="4.50">4.50 (–ú–Ω–æ–≥–æ –¥–æ–±—ä—Ä)</option>
            <option value="5.50">5.50 (–û—Ç–ª–∏—á–µ–Ω)</option>
          </select>
        </div>

        <button onclick="calculateExamPoints()" style="width: 100%; padding: 10px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: bold;">–ò–∑—á–∏—Å–ª–∏</button>

        <div id="calcResult" style="margin-top: 15px; padding: 12px; border-radius: 6px; display: none; text-align: center; line-height: 1.5; font-size: 13px;"></div>
      </div>
      
      <div class="modal-info" id="examInfoContent">
        <div class="modal-info-row">
          <div id="examAdditionalInfo" style="width: 100%; line-height: 1.6; color: #374151; word-wrap: break-word; font-size: 14px; overflow: auto; max-height: 70vh;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="scheduleNotesEditModal" style="display: none;">
    <div class="modal-content schedule-notes-modal-content">
      <button class="modal-close" type="button" onclick="closeScheduleNotesModal()">√ó</button>
      <h2 class="modal-title">Edit Schedule Notes</h2>
      <div id="scheduleNotesModalError" class="schedule-notes-modal-error"></div>
      <textarea id="scheduleNotesEditor" style="width: 100%; min-height: 320px; resize: vertical; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px;"></textarea>
      <div class="schedule-notes-modal-actions">
        <button id="cancelScheduleNotesBtn" type="button" class="schedule-notes-btn cancel" onclick="closeScheduleNotesModal()">Cancel</button>
        <button id="saveScheduleNotesBtn" type="button" class="schedule-notes-btn save" onclick="saveScheduleNotesFromModal()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Schedule data loaded from Firebase
    let scheduleByWeek = [];
    let currentWeekIndex = 0;
    
    // Global variable to store loaded data for helpers
    window.scheduleData = null;

    // Pre-computed time ranges per semester (earliest start / latest end across all weeks)
    let semesterTimeRanges = {};
    let gridBackgroundSignature = null;

    const SCHEDULE_CACHE_KEY = 'calendarScheduleDataCache_v1';
    const SCHEDULE_NOTES_CACHE_KEY = 'calendarScheduleNotesCache_v1';
    const CACHE_MAX_AGE_MS = 12 * 60 * 60 * 1000;

    function readCachedJson(cacheKey, options = {}) {
      let maxAgeMs = CACHE_MAX_AGE_MS;
      let allowStale = false;

      if (typeof options === 'number') {
        maxAgeMs = options;
      } else if (options && typeof options === 'object') {
        if (typeof options.maxAgeMs === 'number') {
          maxAgeMs = options.maxAgeMs;
        }
        allowStale = options.allowStale === true;
      }

      try {
        const raw = localStorage.getItem(cacheKey);
        if (!raw) return null;

        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        if (!parsed.savedAt || !parsed.data) return null;

        if (!allowStale && Date.now() - parsed.savedAt > maxAgeMs) {
          return null;
        }

        return parsed.data;
      } catch (error) {
        console.warn(`Failed to read cache for ${cacheKey}:`, error);
        return null;
      }
    }

    function writeCachedJson(cacheKey, data) {
      try {
        localStorage.setItem(cacheKey, JSON.stringify({
          savedAt: Date.now(),
          data
        }));
      } catch (error) {
        console.warn(`Failed to write cache for ${cacheKey}:`, error);
      }
    }

    function applyScheduleData(activeScheduleData) {
      if (!activeScheduleData) return false;

      window.scheduleData = activeScheduleData;

      scheduleByWeek = generateWeeksFromTemplate(activeScheduleData);

      // Pre-compute semester-wide time ranges so every week in a semester uses the same grid bounds
      semesterTimeRanges = computeSemesterTimeRanges(scheduleByWeek);

      currentWeekIndex = findCurrentWeekIndex();
      renderSchedule();
      updateWeekInfo();

      return true;
    }

    async function refreshScheduleDataFromFirebase() {
      const snapshot = await firebase.database().ref('/settings/scheduleData').once('value');
      if (!snapshot.exists()) {
        throw new Error('No schedule data found in Firebase');
      }

      const activeScheduleData = snapshot.val();
      applyScheduleData(activeScheduleData);
      writeCachedJson(SCHEDULE_CACHE_KEY, activeScheduleData);
    }

    document.addEventListener('DOMContentLoaded', async function() {
      setupScheduleNotesEditor();

      // Render an empty timetable scaffold immediately to avoid layout flicker
      // while schedule data is loading from cache/Firebase.
      renderGridSkeleton();

      // Apply cached notes instantly (synchronous, no Firebase request)
      const cachedNotes = readCachedJson(SCHEDULE_NOTES_CACHE_KEY, { allowStale: true });
      if (cachedNotes) {
        applyScheduleNotesState(normalizeScheduleNotesValue(cachedNotes));
      }

      // Apply cached schedule instantly (synchronous)
      let hasRenderedSchedule = false;
      const cachedScheduleData = readCachedJson(SCHEDULE_CACHE_KEY, { allowStale: true });
      if (cachedScheduleData) {
        hasRenderedSchedule = applyScheduleData(cachedScheduleData);
      }

      // If cache already rendered, refresh from Firebase in background to keep UI responsive.
      if (hasRenderedSchedule) {
        refreshScheduleDataFromFirebase().catch(error => {
          console.error('Error fetching schedule from Firebase:', error);
        });
      } else {
        try {
          await refreshScheduleDataFromFirebase();
        } catch (error) {
          console.error('Error fetching schedule from Firebase:', error);
          const weekDateRangeEl = document.getElementById('weekDateRange');
          const weekNumberEl = document.getElementById('weekNumber');
          if (weekDateRangeEl) weekDateRangeEl.textContent = '–†–∞–∑–ø–∏—Å–∞–Ω–∏–µ';
          if (weekNumberEl) weekNumberEl.textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –ø–æ-–∫—ä—Å–Ω–æ.';
        }
      }

      // After timetable is rendered, refresh notes from Firebase (non-blocking)
      refreshScheduleNotesFromFirebase();
    });
    
    const scheduleNotesDbRef = firebase.database().ref('scheduleNotes/content');
    let scheduleNotesState = {
      content: '',
      lastEditedBy: '',
      lastEditedAt: null
    };

    function normalizeScheduleNotesValue(value) {
      if (typeof value === 'string') {
        return {
          content: value,
          lastEditedBy: '',
          lastEditedAt: null
        };
      }

      if (value && typeof value === 'object') {
        return {
          content: value.content || '',
          lastEditedBy: value.lastEditedBy || '',
          lastEditedAt: value.lastEditedAt || null
        };
      }

      return {
        content: '',
        lastEditedBy: '',
        lastEditedAt: null
      };
    }

    function applyScheduleNotesState(nextState) {
      scheduleNotesState = {
        content: nextState.content || '',
        lastEditedBy: nextState.lastEditedBy || '',
        lastEditedAt: nextState.lastEditedAt || null
      };

      renderScheduleNotesContent(scheduleNotesState.content);
      updateLastEditInfo(scheduleNotesState.lastEditedBy, scheduleNotesState.lastEditedAt);
      writeCachedJson(SCHEDULE_NOTES_CACHE_KEY, scheduleNotesState);
    }

    function getEditorDisplayName(user) {
      if (!user) return 'Unknown user';
      return user.displayName || user.userName || user.username || user.userId || 'Unknown user';
    }

    function formatLastEdited(lastEditedAt) {
      if (!lastEditedAt) return 'Last edit: ‚Äî';
      const date = new Date(lastEditedAt);
      if (Number.isNaN(date.getTime())) return 'Last edit: ‚Äî';
      return `Last edit: ${date.toLocaleString('bg-BG')}`;
    }

    function renderScheduleNotesContent(markdown) {
      const infoContent = document.getElementById('infoContent');
      if (!infoContent) return;

      if (markdown && markdown.trim()) {
        infoContent.innerHTML = marked.parse(markdown);
      } else {
        infoContent.innerHTML = '<p>–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ –±–µ–ª–µ–∂–∫–∏. –ù–∞—Ç–∏—Å–Ω–∏ <strong>Edit</strong>, –∑–∞ –¥–∞ –¥–æ–±–∞–≤–∏—à.</p>';
      }
    }

    function updateLastEditInfo(lastEditedBy, lastEditedAt) {
      const lastEditEl = document.getElementById('scheduleNotesLastEdit');
      if (!lastEditEl) return;

      const timeText = formatLastEdited(lastEditedAt).replace('Last edit: ', '');
      if (lastEditedBy && lastEditedAt) {
        lastEditEl.textContent = `Last edit: ${lastEditedBy} ¬∑ ${timeText}`;
      } else {
        lastEditEl.textContent = 'Last edit: ‚Äî';
      }
    }

    function openScheduleNotesModal() {
      const modal = document.getElementById('scheduleNotesEditModal');
      const editor = document.getElementById('scheduleNotesEditor');
      const errorEl = document.getElementById('scheduleNotesModalError');

      if (!modal || !editor) return;

      editor.value = scheduleNotesState.content || '';
      if (errorEl) {
        errorEl.style.display = 'none';
        errorEl.textContent = '';
      }

      modal.style.display = 'flex';
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
      editor.focus();
    }

    function closeScheduleNotesModal() {
      const modal = document.getElementById('scheduleNotesEditModal');
      if (!modal) return;

      modal.style.display = 'none';
      modal.classList.remove('open');
      document.body.style.overflow = '';
    }

    async function saveScheduleNotesFromModal() {
      const editor = document.getElementById('scheduleNotesEditor');
      const saveBtn = document.getElementById('saveScheduleNotesBtn');
      const errorEl = document.getElementById('scheduleNotesModalError');
      if (!editor || !saveBtn) return;

      saveBtn.disabled = true;
      if (errorEl) {
        errorEl.style.display = 'none';
        errorEl.textContent = '';
      }

      try {
        let currentUser = null;
        if (window.currentUserPromise) {
          currentUser = await window.currentUserPromise;
        }

        const payload = {
          content: editor.value,
          lastEditedBy: getEditorDisplayName(currentUser),
          lastEditedAt: firebase.database.ServerValue.TIMESTAMP
        };

        await scheduleNotesDbRef.set(payload);
        applyScheduleNotesState({
          content: editor.value,
          lastEditedBy: getEditorDisplayName(currentUser),
          lastEditedAt: Date.now()
        });
        closeScheduleNotesModal();
        refreshScheduleNotesFromFirebase();
      } catch (error) {
        console.error('Error saving schedule notes:', error);
        if (errorEl) {
          errorEl.textContent = `Error saving: ${error.message}`;
          errorEl.style.display = 'block';
        }
      } finally {
        saveBtn.disabled = false;
      }
    }

    function setupScheduleNotesEditor() {
      const editBtn = document.getElementById('editScheduleNotesBtn');
      const modal = document.getElementById('scheduleNotesEditModal');

      if (editBtn) {
        editBtn.addEventListener('click', openScheduleNotesModal);
      }

      if (modal) {
        modal.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeScheduleNotesModal();
          }
        });
      }
    }

    window.closeScheduleNotesModal = closeScheduleNotesModal;
    window.saveScheduleNotesFromModal = saveScheduleNotesFromModal;

    // Load current information from Markdown file
    async function loadCurrentInfo(options = {}) {
      const { preferCache = false } = options;
      let renderedFromCache = false;

      if (preferCache) {
        const cachedNotes = readCachedJson(SCHEDULE_NOTES_CACHE_KEY);
        if (cachedNotes) {
          applyScheduleNotesState(normalizeScheduleNotesValue(cachedNotes));
          renderedFromCache = true;
        }
      }

      try {
        const snapshot = await scheduleNotesDbRef.once('value');
        applyScheduleNotesState(normalizeScheduleNotesValue(snapshot.val()));
      } catch (error) {
        console.error('Error loading current info from Firebase:', error);
        if (!renderedFromCache) {
          applyScheduleNotesState({
            content: '',
            lastEditedBy: '',
            lastEditedAt: null
          });
        }
      }
    }

    // Lightweight refresh: fetches notes from Firebase without clearing on error
    async function refreshScheduleNotesFromFirebase() {
      try {
        const snapshot = await scheduleNotesDbRef.once('value');
        applyScheduleNotesState(normalizeScheduleNotesValue(snapshot.val()));
      } catch (error) {
        console.error('Error refreshing schedule notes from Firebase:', error);
      }
    }
    
    // Find the current week index based on today's date
    function findCurrentWeekIndex() {
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to midnight
      
      const semConfig = getSemesterConfigForDate(today);
      
      // Special Check: If today is in an Exam Period, force find the exam week
      if (semConfig && semConfig.examPeriod) {
          const examStart = new Date(semConfig.examPeriod.start);
          const examEnd = new Date(semConfig.examPeriod.end);
          examStart.setHours(0,0,0,0);
          examEnd.setHours(0,0,0,0);
          
          if (today >= examStart && today <= examEnd) {
              // Find the week that starts on (or closest before?) the exam start
              // The weeks array usually has an entry for the Exam Start date.
              const examStartIndex = scheduleByWeek.findIndex(w => {
                  const wStart = new Date(w.startDate);
                  wStart.setHours(0,0,0,0);
                  return wStart.getTime() === examStart.getTime();
              });
              
              if (examStartIndex !== -1) {
                  return examStartIndex;
              }
          }
      }
      
      // Check if today is in Christmas break
      if (semConfig && semConfig.christmasBreak) {
        const christmasStart = new Date(semConfig.christmasBreak.start);
        const christmasEnd = new Date(semConfig.christmasBreak.end);
        christmasStart.setHours(0, 0, 0, 0);
        christmasEnd.setHours(0, 0, 0, 0);
        
        if (today >= christmasStart && today <= christmasEnd) {
             // Return index of the week that contains or precedes the break
             // Or better, if we have a "Christmas" week entry (we do: Dec 24)
             const xmasIndex = scheduleByWeek.findIndex(w => {
                  const wStart = new Date(w.startDate);
                  wStart.setHours(0,0,0,0);
                  return wStart.getTime() === christmasStart.getTime();
             });
             if (xmasIndex !== -1) return xmasIndex;
        }
      }
      
      // Check if today is Saturday (6) or Sunday (0)
      const dayOfWeek = today.getDay();
      let targetDate = new Date(today);
      
      if (dayOfWeek === 0) {
        // Sunday - show next week (add 1 day to Monday)
        targetDate.setDate(targetDate.getDate() + 1);
      } else if (dayOfWeek === 6) {
        // Saturday - show next week (add 2 days to Monday)
        targetDate.setDate(targetDate.getDate() + 2);
      }
      
      for (let i = 0; i < scheduleByWeek.length; i++) {
        const weekStart = new Date(scheduleByWeek[i].startDate);
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 4); // End of week (Friday)
        
        if (targetDate >= weekStart && targetDate <= weekEnd) {
          return i;
        }
      }
      
      // If today is before first week, return 0
      if (scheduleByWeek.length > 0) {
        const firstWeek = new Date(scheduleByWeek[0].startDate);
        if (targetDate < firstWeek) {
          return 0;
        }
      }
      
      // If today is after all weeks, return last week
      return Math.max(0, scheduleByWeek.length - 1);
    }
    
    // Generate schedule for all weeks from template
    function generateWeeksFromTemplate(config) {
      const weeks = [];
      const overrides = config.overrides || {};
      const addedExamPeriods = new Set(); // Track which exam periods we've already added
      
      const processedTemplates = {};
      
      // Check if templates object exists AND has keys. If empty, try legacy fallback.
      if (config.templates && Object.keys(config.templates).length > 0) {
        // New structure
        Object.keys(config.templates).forEach(sem => {
          processedTemplates[sem] = config.templates[sem].map(item => ({
            ...item
          }));
        });
      } else {
        // Fallback for legacy structure (or empty templates object)
        const template = config.template || [];
        processedTemplates['winter'] = template.map(item => ({
          ...item
        }));
        processedTemplates['summer'] = [];
      }

      config.weeks.forEach((week, index) => {
        const weekNumber = index + 1;
        const weekStartDateStr = week.startDate;
        
        // Determine semester using string comparison
        let semesterKey = 'winter';
        if (config.semesters) {
            // Sort keys by start date to find the correct range
            const keys = Object.keys(config.semesters).sort((a, b) => config.semesters[a].startDate.localeCompare(config.semesters[b].startDate));
            for (const key of keys) {
                if (weekStartDateStr >= config.semesters[key].startDate) {
                    semesterKey = key;
                }
            }
        } else if (config.semesters && config.semesters.summer) {
             // Fallback for simple case if keys iteration fails
             if (weekStartDateStr >= config.semesters.summer.startDate) {
                 semesterKey = 'summer';
             }
        }
        
        // Check if this week overlaps with an exam period
        let matchingExamPeriod = null;
        const weekDate = new Date(weekStartDateStr);
        const weekEndDate = new Date(weekDate);
        weekEndDate.setDate(weekEndDate.getDate() + 6); // Week spans Monday to Sunday
        
        if (config.semesters) {
            for (const semKey in config.semesters) {
                const sem = config.semesters[semKey];
                if (sem.examPeriod && sem.examPeriod.start && sem.examPeriod.end) {
                    const examStart = new Date(sem.examPeriod.start);
                    const examEnd = new Date(sem.examPeriod.end);
                    examStart.setHours(0, 0, 0, 0);
                    examEnd.setHours(0, 0, 0, 0);
                    weekDate.setHours(0, 0, 0, 0);
                    weekEndDate.setHours(0, 0, 0, 0);
                    
                    // Check if week overlaps with exam period at all
                    if (weekDate <= examEnd && weekEndDate >= examStart) {
                        matchingExamPeriod = { key: semKey, ...sem.examPeriod };
                        break;
                    }
                }
            }
        }
        
        // Skip weeks that overlap with exam periods - but add the exam period once
        if (matchingExamPeriod) {
            const examKey = `${matchingExamPeriod.start}_${matchingExamPeriod.end}`;
            if (!addedExamPeriods.has(examKey)) {
                addedExamPeriods.add(examKey);
                weeks.push({
                    weekNumber: weekNumber,
                    startDate: matchingExamPeriod.start,
                    endDate: matchingExamPeriod.end,
                    schedule: [],
                    semester: semesterKey,
                    type: 'exam'
                });
            }
            return; // Skip this week
        }
        
        const currentTemplate = processedTemplates[semesterKey] || [];
        let schedule = JSON.parse(JSON.stringify(currentTemplate)); // Deep copy
        
        // Apply overrides for this week if they exist
        if (overrides[weekNumber]) {
          overrides[weekNumber].forEach(override => {
            if (override.removeDay) {
              schedule = schedule.filter(item => item.day !== override.removeDay);
            } else if (override.remove) {
              schedule = schedule.filter(item => 
                !(item.day === override.day && 
                  item.subject === override.subject && 
                  item.startTime === override.startTime)
              );
            } else if (override.changes) {
              if (override.changes.removed === true) {
                schedule = schedule.filter(item => 
                  !(item.day === override.day && 
                    item.subject === override.subject && 
                    item.startTime === override.startTime)
                );
              } else {
                const itemIndex = schedule.findIndex(item => 
                  item.day === override.day && 
                  item.subject === override.subject && 
                  item.startTime === override.startTime
                );
                if (itemIndex !== -1) {
                  Object.assign(schedule[itemIndex], override.changes);
                }
              }
            } else {
              schedule.push({ ...override });
            }
          });
        }
        
        weeks.push({
          weekNumber: weekNumber,
          startDate: week.startDate,
          schedule: schedule,
          semester: semesterKey,
          type: 'normal'
        });
      });
      
      return weeks;
    }
    
    // Helper to get semester config for a specific date
    function getSemesterConfigForDate(dateStr) {
      // Normalize date string to YYYY-MM-DD for string comparison if passed as Date object or timestamp
      let dateString = dateStr;
      if (dateStr instanceof Date) {
          const offset = dateStr.getTimezoneOffset() * 60000;
          dateString = new Date(dateStr.getTime() - offset).toISOString().split('T')[0];
      } else if (typeof dateStr === 'string' && dateStr.includes('T')) {
          dateString = dateStr.split('T')[0];
      }

      const data = window.scheduleData;
      
      if (!data) return null;
      
      if (data.semesters) {
        // Sort keys by start date to find the correct range
        const keys = Object.keys(data.semesters).sort((a, b) => data.semesters[a].startDate.localeCompare(data.semesters[b].startDate));
        let selectedSem = data.semesters.winter; // Default to first/winter
        
        for (const key of keys) {
            if (dateString >= data.semesters[key].startDate) {
                selectedSem = data.semesters[key];
            }
        }
        return selectedSem;
      }
      
      return data.semester; // Legacy fallback
    }

    // Calculate week number from semester start
    function getWeekNumberFromSemesterStart(dateStr) {
      const semConfig = getSemesterConfigForDate(dateStr);
      if (!semConfig) return 1;
      
      const weekDate = new Date(dateStr);
      const semesterStart = new Date(semConfig.startDate);
      
      // Calculate difference in days
      const diffTime = weekDate - semesterStart;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      // Calculate week number (starting from 1)
      const weekNum = Math.floor(diffDays / 7) + 1;
      return weekNum > 0 ? weekNum : 1;
    }
    
    // Check if date is in Christmas break
    function isChristmasBreak(dateStr) {
      const semConfig = getSemesterConfigForDate(dateStr);
      if (!semConfig || !semConfig.christmasBreak) return false;
      
      const date = new Date(dateStr);
      const breakStart = new Date(semConfig.christmasBreak.start);
      const breakEnd = new Date(semConfig.christmasBreak.end);
      
      return date >= breakStart && date <= breakEnd;
    }
    
    // Check if date is in exam period
    function isExamPeriod(dateStr) {
      const semConfig = getSemesterConfigForDate(dateStr);
      if (!semConfig || !semConfig.examPeriod) return false;
      
      const date = new Date(dateStr);
      const examStart = new Date(semConfig.examPeriod.start);
      const examEnd = new Date(semConfig.examPeriod.end);
      
      return date >= examStart && date <= examEnd;
    }
    
    // Get week type (normal, christmas, exam)
    function getWeekType(dateStr) {
      if (isChristmasBreak(dateStr)) return 'christmas';
      if (isExamPeriod(dateStr)) return 'exam';
      return 'normal';
    }

    // Helper function to format time for display
    function formatTime(startTime, endTime) {
      if (!startTime || !endTime) return '';
      // Remove leading zero from hours for display
      const formatHour = (time) => {
        const [hours, minutes] = time.split(':');
        return `${parseInt(hours)}:${minutes}`;
      };
      return `${formatHour(startTime)}-${formatHour(endTime)}`;
    }

    function resolveAdditionalInfoHtml(entry) {
      if (!entry || typeof entry !== 'object') return '';

      const rawMarkdown = typeof entry.additionalInfo === 'string' ? entry.additionalInfo.trim() : '';
      const existingHtml = typeof entry.additionalInfoHtml === 'string' ? entry.additionalInfoHtml.trim() : '';

      if (existingHtml) {
        const looksLikeHtml = /<\/?[a-z][\s\S]*>/i.test(existingHtml);
        if (looksLikeHtml) {
          return existingHtml;
        }
        if (typeof marked !== 'undefined' && marked.parse) {
          return marked.parse(existingHtml);
        }
        return existingHtml;
      }

      if (rawMarkdown) {
        if (typeof marked !== 'undefined' && marked.parse) {
          return marked.parse(rawMarkdown);
        }
        return rawMarkdown.replace(/\n/g, '<br>');
      }

      return '';
    }

    // Helper: Time string ("HH:MM") to minutes from midnight
    function timeToMinutes(timeStr) {
      if (!timeStr) return 0;
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }

    // Compute the earliest start hour and latest end hour for each semester across all weeks
    function computeSemesterTimeRanges(weeks) {
      const ranges = {};
      weeks.forEach(week => {
        if (week.type === 'exam' || !week.schedule || week.schedule.length === 0) return;
        const sem = week.semester || 'winter';
        if (!ranges[sem]) {
          ranges[sem] = { earliestMin: 24 * 60, latestMin: 0 };
        }
        week.schedule.forEach(ev => {
          if (!ev.startTime || !ev.endTime) return;
          const start = timeToMinutes(ev.startTime);
          const end = timeToMinutes(ev.endTime);
          if (start < ranges[sem].earliestMin) ranges[sem].earliestMin = start;
          if (end > ranges[sem].latestMin) ranges[sem].latestMin = end;
        });
      });

      const result = {};
      for (const sem in ranges) {
        const r = ranges[sem];
        if (r.latestMin === 0) {
          result[sem] = { startHour: 8, endHour: 18 };
          continue;
        }
        const startHour = Math.floor(r.earliestMin / 60);
        const baseHour = Math.floor(r.latestMin / 60);
        const mins = r.latestMin % 60;
        const endHour = mins < 30 ? baseHour + 0.5 : baseHour + 1.5;
        result[sem] = { startHour, endHour };
      }
      return result;
    }

    // Helper: Get time range for a week (uses semester-wide range if available, else per-week)
    function getTimeRangeForWeek(week) {
      const sem = week.semester || 'winter';
      if (semesterTimeRanges[sem]) {
        return semesterTimeRanges[sem];
      }
      // Fallback to per-week calculation
      return calculateDynamicRange(week.schedule || []);
    }

    // Helper: Calculate start/end hour based on events
    function calculateDynamicRange(events) {
      let earliestMin = 24 * 60;
      let latestMin = 0;
      let hasEvents = false;

      events.forEach(ev => {
        if (!ev.startTime || !ev.endTime) return;
        hasEvents = true;
        const start = timeToMinutes(ev.startTime);
        const end = timeToMinutes(ev.endTime);
        if (start < earliestMin) earliestMin = start;
        if (end > latestMin) latestMin = end;
      });

      if (!hasEvents) return { startHour: 8, endHour: 18 }; // Default

      // Round down start to nearest hour
      let startHour = Math.floor(earliestMin / 60);

      // Round up end to next :30 increment
      // If ends before XX:30, snap to XX:30. 
      // If ends at or after XX:30, snap to (XX+1):30.
      let baseHour = Math.floor(latestMin / 60);
      let mins = latestMin % 60;
      let endHour;
      if (mins < 30) {
          endHour = baseHour + 0.5;
      } else {
          endHour = baseHour + 1.5;
      }
      
      return { startHour, endHour };
    }

    // Get current day of week (–ü–û–ù, –í–¢, etc.) or Monday if weekend
    // Returns null if we're viewing a different week than current
    function getCurrentDay() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Check if today is in the currently displayed week
      const currentWeek = scheduleByWeek[currentWeekIndex];
      if (!currentWeek) return null;
      
      const weekStart = new Date(currentWeek.startDate);
      weekStart.setHours(0, 0, 0, 0);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6); // End of week (Sunday)
      
      // If today is not in this week, don't highlight anything
      if (today < weekStart || today > weekEnd) {
        return null;
      }
      
      const dayIndex = today.getDay(); // 0=Sunday, 1=Monday, etc.
      const days = ['–ü–û–ù', '–í–¢', '–°–†', '–ß–ï–¢', '–ü–ï–¢'];
      
      // If Saturday (6) or Sunday (0), return Monday (for current week only)
      if (dayIndex === 0 || dayIndex === 6) {
        return '–ü–û–ù';
      }
      
      // Otherwise return the current day (Monday=1 -> index 0)
      return days[dayIndex - 1];
    }

    function renderSchedule() {
      const grid = document.getElementById('scheduleGrid');
      const days = ['–ü–û–ù', '–í–¢', '–°–†', '–ß–ï–¢', '–ü–ï–¢'];
      const currentDay = getCurrentDay();

      // Update Dates in Headers
      const headerCells = grid.querySelectorAll('.header-cell:not(.time-header)');
      const currentWeek = scheduleByWeek[currentWeekIndex];
      
      if (!currentWeek) return; // Should not happen if data loaded

      // Update Header Dates
      if (currentWeek.startDate) {
          const startDate = new Date(currentWeek.startDate);
          headerCells.forEach((cell, i) => {
              const date = new Date(startDate);
              date.setDate(date.getDate() + i);
              const d = date.getDate();
              const m = date.getMonth() + 1;
              const dateStr = `${d}.${m < 10 ? '0' + m : m}`;
              // Using divs for flex column layout
              cell.innerHTML = `<div>${days[i]}</div><div style="font-weight:400; font-size: 0.9em; opacity: 0.9; margin-top: 2px;">${dateStr}</div>`;
              
              // Highlight current day
              if (days[i] === currentDay) {
                  cell.style.backgroundColor = 'var(--col-pine)'; // Darker highlight
              } else {
                  cell.style.backgroundColor = ''; // Reset (uses CSS default)
              }
          });
      }

      // Check for Exam View
      if (currentWeek.type === 'exam') {
          // Hide grid, show exam list
          grid.style.display = 'none';
          document.getElementById('examScreen').style.display = 'block';
          return; // RenderExams called by updateWeekInfo
      } else {
          grid.style.display = 'grid';
          document.getElementById('examScreen').style.display = 'none';
      }

      const scheduleData = currentWeek.schedule;
      const { startHour, endHour } = getTimeRangeForWeek(currentWeek);
        const backgroundSignature = `${startHour}-${endHour}-${currentDay || 'none'}`;

        if (gridBackgroundSignature !== backgroundSignature) {
        renderGridBackground(startHour, endHour, currentDay);
        gridBackgroundSignature = backgroundSignature;
        }

        // Clear previous events only (keep static background grid for smoother updates)
        grid.querySelectorAll('.event-card').forEach(el => el.remove());
      
      const stepMinutes = 15;
      const totalMinutes = (endHour - startHour) * 60;
      const totalRows = totalMinutes / stepMinutes;

      // 2. Render Events
      scheduleData.forEach(ev => {
          if (!ev.startTime || !ev.endTime) return;
          if (ev.startTime === '00:00') return; 

          const dayIndex = days.indexOf(ev.day);
          if (dayIndex === -1) return;

          const startMins = timeToMinutes(ev.startTime);
          const endMins = timeToMinutes(ev.endTime);
          const duration = endMins - startMins;

          const startOffset = startMins - (startHour * 60);
          
          // Row Calculation
          const slotIndex = Math.floor(startOffset / stepMinutes);
          const remainderMinutes = startOffset % stepMinutes;
          
          // Revert to +4 offset
          const rowStart = Math.max(4, slotIndex + 4);
          const rowSpan = Math.ceil(duration / stepMinutes);
          
          const pixelOffsetRatio = remainderMinutes / stepMinutes;

          const el = document.createElement('div');
          
          const typeMap = {
            '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ': 'type-exercise',
            '–õ–µ–∫—Ü–∏—è': 'type-lecture',
            '–í–∞–∂–Ω–∞ –ª–µ–∫—Ü–∏—è': 'type-important-lecture',
            'ImportantLecture': 'type-important-lecture',
            '–ö–æ–ª–æ–∫–≤–∏—É–º': 'type-exam',
            '–ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ö–æ–ª–æ–∫–≤–∏—É–º': 'type-makeup',
            '–¢–µ—Å—Ç': 'type-test'
          };
          const typeClass = typeMap[ev.type] || 'type-lecture';
          
          el.className = `event-card ${typeClass}`;
          if (ev.highlight) el.classList.add('highlight');
          
          // Apply dynamic scaling classes based on duration (rowSpan)
          if (rowSpan === 1) {
              el.classList.add('tiny-event');
          } else if (rowSpan === 2) {
              el.classList.add('short-event');
          }

          el.style.gridColumn = dayIndex + 2; 
          el.style.gridRowStart = rowStart;
          el.style.gridRowEnd = `span ${rowSpan}`;
          
          // Precision positioning using relative top
          if (pixelOffsetRatio > 0) {
             el.style.position = 'relative';
             el.style.top = `calc(var(--slot-height) * ${pixelOffsetRatio})`;
          }

          const infoIndicator = (ev.additionalInfo || ev.additionalInfoHtml) ? '*' : '';
          const titleDesktop = ev.fullName || ev.subject;
          const titleMobile = ev.subject;
          
          // --- Smart Logic for Building/Room (Handles Old and New Schema) ---
          let b = ev.building;
          let r = ev.room;
          let f = ev.floor;
          if (!b && f) {
              b = ev.room;
              r = ev.floor;
          }
          
          // Construct location HTML: Building \n Room for desktop
          const locationHtml = `
              ${b ? `<div>${b}</div>` : ''}
              ${r ? `<div>${r}</div>` : ''}
          `;

          el.innerHTML = `
              <div class="event-title">
                <span class="title-desktop">${titleDesktop}${infoIndicator}</span>
                <span class="title-mobile">${titleMobile}${infoIndicator}</span>
              </div>
              <div class="event-time">${ev.startTime}-${ev.endTime}</div>
              <div class="event-location">${locationHtml}</div>
          `;
          
          el.onclick = () => openModal(ev);
          grid.appendChild(el);
      });
    }

    function renderGridBackground(startHour, endHour, currentDay) {
      const grid = document.getElementById('scheduleGrid');
      if (!grid) return;

      const days = ['–ü–û–ù', '–í–¢', '–°–†', '–ß–ï–¢', '–ü–ï–¢'];
      const stepMinutes = 15;
      const totalMinutes = (endHour - startHour) * 60;
      const totalRows = totalMinutes / stepMinutes;
      const gridEndRow = totalRows + 5;

      const existingBackground = grid.querySelectorAll('.time-label, .grid-line, .vertical-line, .current-day-column');
      existingBackground.forEach(el => el.remove());

      for (let c = 3; c <= 6; c++) {
        const vLine = document.createElement('div');
        vLine.className = 'vertical-line';
        vLine.style.gridColumn = c;
        vLine.style.gridRow = `1 / ${gridEndRow}`;
        vLine.style.borderLeft = '1px solid #f4f4f4';
        grid.appendChild(vLine);
      }

      if (currentDay) {
        const dayCol = days.indexOf(currentDay) + 2;
        const highlight = document.createElement('div');
        highlight.className = 'current-day-column';
        highlight.style.gridColumn = dayCol;
        highlight.style.gridRow = `1 / ${gridEndRow}`;
        grid.appendChild(highlight);
      }

      for (let i = 0; i <= totalRows; i++) {
        const rowNum = i + 4;
        const currentMin = (startHour * 60) + (i * stepMinutes);

        if (currentMin % 60 === 0) {
          const hour = Math.floor(currentMin / 60);
          const timeLabel = document.createElement('div');
          timeLabel.className = 'time-label';
          timeLabel.style.gridRow = rowNum;
          timeLabel.innerText = `${hour.toString().padStart(2, '0')}:00`;
          grid.appendChild(timeLabel);

          const line = document.createElement('div');
          line.className = 'grid-line hour-marker';
          line.style.gridRow = rowNum;
          grid.appendChild(line);
        } else {
          const line = document.createElement('div');
          line.className = 'grid-line';
          line.style.gridRow = rowNum;
          grid.appendChild(line);
        }
      }
    }

    function renderGridSkeleton() {
      const grid = document.getElementById('scheduleGrid');
      if (!grid) return;

      const headerCells = grid.querySelectorAll('.header-cell:not(.time-header)');
      const days = ['–ü–û–ù', '–í–¢', '–°–†', '–ß–ï–¢', '–ü–ï–¢'];
      headerCells.forEach((cell, i) => {
        cell.innerHTML = `<div>${days[i]}</div><div style="font-weight:400; font-size: 0.9em; opacity: 0.55; margin-top: 2px;">--.--</div>`;
        cell.style.backgroundColor = '';
      });

      grid.querySelectorAll('.event-card').forEach(el => el.remove());
      renderGridBackground(7, 20, null);
      gridBackgroundSignature = '7-20-none';
    }
    
    // Change week
    function changeWeek(direction) {
      const newIndex = currentWeekIndex + direction;
      if (newIndex >= 0 && newIndex < scheduleByWeek.length) {
        currentWeekIndex = newIndex;
        renderSchedule();
        updateWeekInfo();
      }
    }
    
    // Update week information display
    function updateWeekInfo() {
      const currentWeek = scheduleByWeek[currentWeekIndex];
      if (!currentWeek) return;
      
      const semesterConfig = getSemesterConfigForDate(currentWeek.startDate);

      // Parse start date
      const startDate = new Date(currentWeek.startDate);
      let endDate = new Date(startDate);
      
      // Check if this is week 15 (last week before Christmas) - only show Mon-Tue
      const weekNumber = currentWeekIndex + 1;
      if (weekNumber === 15) {
        endDate.setDate(endDate.getDate() + 1); // Only Tuesday (–ø–æ–Ω–µ–¥–µ–ª–Ω–∏–∫ + 1 –¥–µ–Ω = –≤—Ç–æ—Ä–Ω–∏–∫)
      } else {
        endDate.setDate(endDate.getDate() + 6); // Sunday (–ø–æ–Ω–µ–¥–µ–ª–Ω–∏–∫ + 6 –¥–Ω–∏ = –Ω–µ–¥–µ–ª—è)
      }
      
      // Get week type - use the type from the week object itself (already calculated during generation)
      const weekType = currentWeek.type || getWeekType(currentWeek.startDate);
      
      // Format dates
      const months = ['—è–Ω—É–∞—Ä–∏', '—Ñ–µ–≤—Ä—É–∞—Ä–∏', '–º–∞—Ä—Ç', '–∞–ø—Ä–∏–ª', '–º–∞–π', '—é–Ω–∏', 
                      '—é–ª–∏', '–∞–≤–≥—É—Å—Ç', '—Å–µ–ø—Ç–µ–º–≤—Ä–∏', '–æ–∫—Ç–æ–º–≤—Ä–∏', '–Ω–æ–µ–º–≤—Ä–∏', '–¥–µ–∫–µ–º–≤—Ä–∏'];
      
      const startDay = startDate.getDate();
      const startMonth = months[startDate.getMonth()];
      const endDay = endDate.getDate();
      const endMonth = months[endDate.getMonth()];
      const year = startDate.getFullYear();
      
      // Calculate actual week number from semester start
      const actualWeekNumber = getWeekNumberFromSemesterStart(currentWeek.startDate);
      
      // Update display based on week type
      const weekDateRangeEl = document.getElementById('weekDateRange');
      const weekNumberEl = document.getElementById('weekNumber');
      
      // Get special screens
      const christmasScreen = document.getElementById('christmasScreen');
      const examScreen = document.getElementById('examScreen');
      const scheduleGrid = document.getElementById('scheduleGrid');
      
      if (weekType === 'christmas') {
        // Christmas break - show special screen
        weekDateRangeEl.textContent = 'üéÑ –ö–æ–ª–µ–¥–Ω–∞ –≤–∞–∫–∞–Ω—Ü–∏—è';
        weekDateRangeEl.style.color = '#dc2626';
        
        // Hide table, show Christmas screen
        scheduleGrid.style.display = 'none';
        examScreen.style.display = 'none';
        christmasScreen.style.display = 'block';
        
        // Show full Christmas break range
        if (semesterConfig && semesterConfig.christmasBreak) {
            const christmasStart = new Date(semesterConfig.christmasBreak.start);
            const christmasEnd = new Date(semesterConfig.christmasBreak.end);
            const christmasStartDay = christmasStart.getDate();
            const christmasStartMonth = months[christmasStart.getMonth()];
            const christmasStartYear = christmasStart.getFullYear();
            const christmasEndDay = christmasEnd.getDate();
            const christmasEndMonth = months[christmasEnd.getMonth()];
            const christmasEndYear = christmasEnd.getFullYear();
            
            if (christmasStartMonth === christmasEndMonth && christmasStartYear === christmasEndYear) {
            weekNumberEl.textContent = `${christmasStartDay} - ${christmasEndDay} ${christmasStartMonth} ${christmasStartYear}`;
            } else {
            weekNumberEl.textContent = `${christmasStartDay} ${christmasStartMonth} ${christmasStartYear} - ${christmasEndDay} ${christmasEndMonth} ${christmasEndYear}`;
            }
        }
        
        return; // Skip normal rendering
      } else if (weekType === 'exam') {
        // Exam period - show special screen
        weekDateRangeEl.textContent = '–ò–∑–ø–∏—Ç–Ω–∞ —Å–µ—Å–∏—è';
        weekDateRangeEl.style.color = '#588157';
        
        // Hide table, show exam screen
        scheduleGrid.style.display = 'none';
        christmasScreen.style.display = 'none';
        examScreen.style.display = 'block';
        
        // Render exams
        renderExams(semesterConfig ? semesterConfig.examPeriod : null);
        
        // Show full month range
        if (semesterConfig && semesterConfig.examPeriod) {
            const examStart = new Date(semesterConfig.examPeriod.start);
            const examEnd = new Date(semesterConfig.examPeriod.end);
            const examStartDay = examStart.getDate();
            const examStartMonth = months[examStart.getMonth()];
            const examEndDay = examEnd.getDate();
            const examEndMonth = months[examEnd.getMonth()];
            
            if (examStartMonth === examEndMonth) {
            weekNumberEl.textContent = `${examStartDay} - ${examEndDay} ${examStartMonth} ${year}`;
            } else {
            weekNumberEl.textContent = `${examStartDay} ${examStartMonth} - ${examEndDay} ${examEndMonth} ${year}`;
            }
        }
        
        return; // Skip normal rendering
      } else {
        // Normal week - show table, hide special screens
        scheduleGrid.style.display = 'grid';
        christmasScreen.style.display = 'none';
        examScreen.style.display = 'none';
        
        // Normal week - show week number from semester start
        weekDateRangeEl.textContent = `–°–µ–¥–º–∏—Ü–∞ ${actualWeekNumber}`;
        weekDateRangeEl.style.color = '#588157';
      }
      
      // Show date range
      if (startMonth === endMonth) {
        weekNumberEl.textContent = 
          `${startDay} - ${endDay} ${startMonth} ${year}`;
      } else {
        weekNumberEl.textContent = 
          `${startDay} ${startMonth} - ${endDay} ${endMonth} ${year}`;
      }
      
      // Update dates in table header
      updateTableHeaderDates(startDate);
      
      // Update button states
      document.getElementById('prevWeekBtn').disabled = currentWeekIndex === 0;
      document.getElementById('nextWeekBtn').disabled = currentWeekIndex === scheduleByWeek.length - 1;
    }
    
    // Update dates in table header
    function updateTableHeaderDates(startDate) {
      const headerCells = document.querySelectorAll('#scheduleGrid .header-cell:not(.time-header)');
      const days = ['–ü–û–ù', '–í–¢', '–°–†', '–ß–ï–¢', '–ü–ï–¢'];
      const currentDay = getCurrentDay();

      if (!headerCells.length) return;
      
      for (let i = 0; i < Math.min(5, headerCells.length); i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        
        const day = date.getDate();
        const month = date.getMonth() + 1; // Month is 0-indexed
        const dateStr = `${day}.${month < 10 ? '0' + month : month}`;
        
        headerCells[i].innerHTML = `<div>${days[i]}</div><div style="font-weight:400; font-size: 0.9em; opacity: 0.9; margin-top: 2px;">${dateStr}</div>`;
        
        // Add current-day class if this is today
        if (days[i] === currentDay) {
          headerCells[i].style.backgroundColor = 'var(--col-pine)';
        } else {
          headerCells[i].style.backgroundColor = '';
        }
      }
    }

    // Open exam info modal
    function showExamModal(exam) {
      const examAdditionalInfo = document.getElementById('examAdditionalInfo');
      const infoHtml = resolveAdditionalInfoHtml(exam);
      exam.additionalInfoHtml = infoHtml;
      
      if (infoHtml) {
        examAdditionalInfo.innerHTML = infoHtml;
      } else {
        examAdditionalInfo.innerHTML = '–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.';
      }
      
      // Show/hide calculator based on flag
      const calculatorSection = document.getElementById('calculatorSection');
      if (exam.hasCalculatorPharmacology1) {
        calculatorSection.style.display = 'block';
      } else {
        calculatorSection.style.display = 'none';
      }
      
      document.getElementById('examInfoModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeExamModal() {
      document.getElementById('examInfoModal').classList.remove('open');
      document.body.style.overflow = '';
    }

    // Calculator function
    function calculateExamPoints() {
      const scoreScale = [
        {pts: "60-61", val: 3.00}, {pts: "62-63", val: 3.10}, {pts: "64-65", val: 3.20},
        {pts: "66-67", val: 3.30}, {pts: "68-69", val: 3.40}, {pts: "70", val: 3.50},
        {pts: "71", val: 3.60}, {pts: "72", val: 3.70}, {pts: "73", val: 3.80},
        {pts: "74", val: 3.90}, {pts: "75", val: 4.00}, {pts: "76", val: 4.10},
        {pts: "77", val: 4.20}, {pts: "78", val: 4.30}, {pts: "79", val: 4.40},
        {pts: "80", val: 4.50}, {pts: "81", val: 4.60}, {pts: "82", val: 4.70},
        {pts: "83", val: 4.80}, {pts: "84", val: 4.90}, {pts: "85", val: 5.00},
        {pts: "86", val: 5.10}, {pts: "87", val: 5.20}, {pts: "88", val: 5.30},
        {pts: "89", val: 5.40}, {pts: "90-91", val: 5.50}, {pts: "92-93", val: 5.60},
        {pts: "94-95", val: 5.70}, {pts: "96-97", val: 5.80}, {pts: "98", val: 5.90},
        {pts: "99-100", val: 6.00}
      ];

      const annual = parseFloat(document.getElementById('calcAnnualGrade').value);
      const target = parseFloat(document.getElementById('calcTargetGrade').value);
      const resultDiv = document.getElementById('calcResult');

      if (isNaN(annual) || annual < 2 || annual > 6) {
        resultDiv.textContent = '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–∞ –≥–æ–¥–∏—à–Ω–∞ –æ—Ü–µ–Ω–∫–∞ –º–µ–∂–¥—É 2 –∏ 6.';
        resultDiv.className = 'warning';
        resultDiv.style.display = 'block';
        return;
      }

      const neededExamGrade = (target - (0.3 * annual)) / 0.7;
      
      let foundPoints = "";
      for (let entry of scoreScale) {
        if (entry.val >= neededExamGrade) {
          foundPoints = entry.pts;
          break;
        }
      }

      resultDiv.style.display = "block";
      if (foundPoints === "" && neededExamGrade > 6) {
        resultDiv.className = "warning";
        resultDiv.innerHTML = `–ó–∞ —Å—ä–∂–∞–ª–µ–Ω–∏–µ, —Ü–µ–ª—Ç–∞ –æ—Ç <strong>${target.toFixed(2)}</strong> –µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞ —Å –≥–æ–¥–∏—à–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${annual.toFixed(2)}.`;
      } else if (neededExamGrade <= 3.00) {
        resultDiv.className = "success";
        resultDiv.innerHTML = `–¢—ä–π –∫–∞—Ç–æ –≥–æ–¥–∏—à–Ω–∞—Ç–∞ –í–∏ –æ—Ü–µ–Ω–∫–∞ –µ –≤–∏—Å–æ–∫–∞, –í–∏ —Ç—Ä—è–±–≤–∞—Ç —Å–∞–º–æ –º–∏–Ω–∏–º–∞–ª–Ω–∏—Ç–µ <strong>60 —Ç–æ—á–∫–∏</strong>, –∑–∞ –¥–∞ –ø—Ä–µ–º–∏–Ω–µ—Ç–µ –∏–∑–ø–∏—Ç–∞.`;
      } else {
        const actualScaleGrade = scoreScale.find(e => e.pts === foundPoints).val;
        resultDiv.className = "success";
        resultDiv.innerHTML = `–ó–∞ –∫—Ä–∞–π–Ω–∞ –æ—Ü–µ–Ω–∫–∞ <strong>${target.toFixed(2)}</strong>,<br>–Ω–∞ –∏–∑–ø–∏—Ç–∞ –í–∏ —Ç—Ä—è–±–≤–∞—Ç –º–∏–Ω–∏–º—É–º:<br><span style="font-size: 1.3em;"><strong>${foundPoints} —Ç–æ—á–∫–∏</strong></span><br>(–¢–æ–≤–∞ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞ –Ω–∞ <strong>${actualScaleGrade.toFixed(2)}</strong> –æ—Ç —Ç–µ—Å—Ç–∞ –Ω–∞ –∏–∑–ø–∏—Ç–∞)`;
      }
    }

    // Close exam modal on overlay click
    document.getElementById('examInfoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeExamModal();
      }
    });

    // Close exam modal on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('examInfoModal').classList.contains('open')) {
        closeExamModal();
      }
    });

    // Open modal with event details
    function openModal(event) {
      const displayName = event.fullName || event.subject;
      document.getElementById('modalSubject').textContent = displayName;
      document.getElementById('modalType').textContent = event.type || '-';
      
      const displayTime = event.time || formatTime(event.startTime, event.endTime);
      document.getElementById('modalTime').textContent = displayTime;
      
      // --- Smart Logic for Building/Room (Handles Old and New Schema) ---
      let building = event.building;
      let room = event.room;
      let floor = event.floor;
      
      // If building is missing but floor exists, it's the old schema:
      // old room -> building, old floor -> room
      if (!building && floor) {
          building = event.room;
          room = event.floor;
          floor = null; // Floor is now integrated into room in old entries
      }
      
      document.getElementById('modalBuilding').textContent = building || '–ù–µ –µ –ø–æ—Å–æ—á–µ–Ω–∞';
      document.getElementById('modalRoom').textContent = room || '–ù–µ –µ –ø–æ—Å–æ—á–µ–Ω–∞';
      
      // Only show floor if it's explicitly provided (new/separate field cases)
      if (floor && floor !== '-' && floor !== '') {
        document.getElementById('modalFloorText').textContent = ` (–ï—Ç–∞–∂ ${floor})`;
      } else {
        document.getElementById('modalFloorText').textContent = '';
      }
      
      document.getElementById('modalTeacher').textContent = event.teacher || '–ù–µ –µ –ø–æ—Å–æ—á–µ–Ω';
      
      const additionalInfoElement = document.getElementById('modalAdditionalInfo');
      const additionalInfoRow = document.getElementById('modalAdditionalInfoRow');

      const infoHtml = resolveAdditionalInfoHtml(event);
      event.additionalInfoHtml = infoHtml;
      
      if (infoHtml) {
        additionalInfoElement.innerHTML = infoHtml;
        additionalInfoRow.style.display = 'flex';
      } else {
        additionalInfoRow.style.display = 'none';
      }
      
      document.getElementById('modalOverlay').classList.add('open');
      document.body.style.overflow = 'hidden';
    }    // Close modal
    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.body.style.overflow = '';
    }
    
    function handleLogout() {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }

    // Admin button visibility logic
    document.addEventListener('DOMContentLoaded', function() {
      const adminButton = document.getElementById('admin-button');
      if (adminButton && window.currentUserPromise) {
        window.currentUserPromise.then(user => {
          if (user && user.isAdmin) {
            adminButton.style.display = 'list-item'; // Or 'block', depending on parent element
          }
        }).catch(error => {
          console.error("Error checking admin status for button visibility:", error);
        });
      }
    });
    // Render exams list
    function renderExams(examPeriod) {
      const examsList = document.getElementById('examsList');
      if (!scheduleData.exams || scheduleData.exams.length === 0) {
        examsList.innerHTML = '<p style="text-align: center; color: #6b7280;">–ù—è–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∏–∑–ø–∏—Ç–∏.</p>';
        return;
      }
      
      let examsToShow = scheduleData.exams;
      
      // Filter if period is provided
      if (examPeriod && examPeriod.start && examPeriod.end) {
          const start = new Date(examPeriod.start);
          const end = new Date(examPeriod.end);
          start.setHours(0,0,0,0);
          end.setHours(0,0,0,0);
          
          examsToShow = examsToShow.filter(exam => {
              if (!exam.examDate) return false;
              const d = new Date(exam.examDate);
              d.setHours(0,0,0,0);
              return d >= start && d <= end;
          });
      }
      
      if (examsToShow.length === 0) {
          examsList.innerHTML = '<p style="text-align: center; color: #6b7280;">–ù—è–º–∞ –∏–∑–ø–∏—Ç–∏ –∑–∞ —Ç–æ–∑–∏ –ø–µ—Ä–∏–æ–¥.</p>';
          return;
      }
      
      const months = ['—è–Ω—É–∞—Ä–∏', '—Ñ–µ–≤—Ä—É–∞—Ä–∏', '–º–∞—Ä—Ç', '–∞–ø—Ä–∏–ª', '–º–∞–π', '—é–Ω–∏', 
                      '—é–ª–∏', '–∞–≤–≥—É—Å—Ç', '—Å–µ–ø—Ç–µ–º–≤—Ä–∏', '–æ–∫—Ç–æ–º–≤—Ä–∏', '–Ω–æ–µ–º–≤—Ä–∏', '–¥–µ–∫–µ–º–≤—Ä–∏'];
      
      examsList.innerHTML = examsToShow.map(exam => {
        // Format exam date
        const examDate = new Date(exam.examDate);
        const examDay = examDate.getDate();
        const examMonth = months[examDate.getMonth()];
        const examYear = examDate.getFullYear();
        const examDateFormatted = `${examDay} ${examMonth} ${examYear}`;
        
        // Format retake date - handle multiple dates separated by " –∏ " (and)
        let retakeDateFormatted = '';
        if (exam.retakeDate && exam.retakeDate.includes(' –∏ ')) {
          // Multiple dates
          const retakeDates = exam.retakeDate.split(' –∏ ').map(d => d.trim());
          const formattedDates = retakeDates.map(dateStr => {
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr; // Return original if invalid
            const day = d.getDate();
            const month = months[d.getMonth()];
            const year = d.getFullYear();
            return `${day} ${month} ${year}`;
          });
          // Add <br> after "–∏" for mobile devices
          retakeDateFormatted = formattedDates.join(' –∏ <span class="mobile-break"></span>');
        } else if (exam.retakeDate) {
          // Single date
          const retakeDate = new Date(exam.retakeDate);
          if (!isNaN(retakeDate.getTime())) {
            const retakeDay = retakeDate.getDate();
            const retakeMonth = months[retakeDate.getMonth()];
            const retakeYear = retakeDate.getFullYear();
            retakeDateFormatted = `${retakeDay} ${retakeMonth} ${retakeYear}`;
          } else {
            retakeDateFormatted = exam.retakeDate;
          }
        }
        
        return `
          <div class="exam-card" onclick="showExamModal(${JSON.stringify(exam).replace(/"/g, '&quot;')})">
            <div class="exam-card-header">
              <h3 class="exam-card-title">${exam.fullName || exam.subject}</h3>
            </div>
            
            <div class="exam-section">
              <div class="exam-section-title">
                <svg class="exam-section-icon" viewBox="0 0 24 24">
                  <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                </svg>
                –†–µ–¥–æ–≤–µ–Ω –∏–∑–ø–∏—Ç
              </div>
              <div class="exam-info-grid">
                <div class="exam-info-item">
                  <span class="exam-info-label">–î–∞—Ç–∞:</span>
                  <span class="exam-info-value">${examDateFormatted}</span>
                </div>
                <div class="exam-info-item">
                  <span class="exam-info-label">–ß–∞—Å:</span>
                  <span class="exam-info-value">${exam.examTime || ''}</span>
                </div>
              </div>
            </div>
            
            <div class="exam-section">
              <div class="exam-section-title">
                <svg class="exam-section-icon" viewBox="0 0 24 24">
                  <path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                </svg>
                –ü–æ–ø—Ä–∞–≤–∫–∞
              </div>
              <div class="exam-info-grid">
                <div class="exam-info-item">
                  <span class="exam-info-label">–î–∞—Ç–∞:</span>
                  <span class="exam-info-value">${retakeDateFormatted}</span>
                </div>
                <div class="exam-info-item">
                  <span class="exam-info-label">–ß–∞—Å:</span>
                  <span class="exam-info-value">${exam.retakeTime || ''}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Close modal on outside click
    document.getElementById('modalOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
      const mobileToggle = document.getElementById('mobileMenuToggle');
      const sidebar = document.getElementById('side-menu');
      const overlay = document.getElementById('mobileMenuOverlay');
      
      function closeMobileMenu() {
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
        mobileToggle.classList.remove('hidden');
        document.body.classList.remove('menu-open');
        document.body.style.overflow = '';
      }
      
      if (mobileToggle && sidebar && overlay) {
        mobileToggle.addEventListener('click', function() {
          sidebar.classList.toggle('mobile-open');
          overlay.classList.toggle('active');
          mobileToggle.classList.toggle('hidden');
          // Add/remove menu-open class on body to prevent scrolling
          if (sidebar.classList.contains('mobile-open')) {
            document.body.classList.add('menu-open');
            document.body.style.overflow = 'hidden';
          } else {
            document.body.classList.remove('menu-open');
            document.body.style.overflow = '';
          }
        });
        
        // Close menu when clicking on overlay
        overlay.addEventListener('click', closeMobileMenu);
        
        // Close menu on link click
        sidebar.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', closeMobileMenu);
        });
      }
    });
  </script>

<!-- ============================================
         CHAT SYSTEM - Complete (Firebase REST + UI)
         ============================================ -->

<script src="js/user-identity.js?v=202602171mhr"></script>
    <!-- CHAT SYSTEM -->
    <script src="js/chat.js?v=2026021812ca"></script>

    <script src="js/presence.js?v=202602171mhr"></script>
<script src="js/version-check.js?v=202602171mhr"></script>
    <!-- Privacy Modal -->
<div id="privacyModal" class="modal-overlay" style="display: none; align-items: center; justify-content: center;">
  <div class="modal-content" style="max-width: 500px;">
    <button class="modal-close" onclick="closePrivacyModal()">√ó</button>
    <h2 class="modal-title">Privacy & Data Storage</h2>
    <div style="color: #374151; font-size: 14px; line-height: 1.6;">
      <p style="margin: 0 0 12px 0;">This application stores data locally on your device to ensure functionality. Here is what we store:</p>
      <ul style="margin: 0 0 12px 0; padding-left: 24px;">
        <li style="margin-bottom: 8px;"><strong>Authentication:</strong> We store your unique User ID and Session Token to keep you logged in.</li>
        <li style="margin-bottom: 8px;"><strong>Device ID:</strong> A random identifier is generated for this browser to manage active sessions security.</li>
        <li style="margin-bottom: 0;"><strong>Preferences:</strong> Settings such as font size or theme choices are saved for your convenience.</li>
      </ul>
      <p style="margin: 0;"><strong>Note:</strong> This data is strictly necessary for the application to function. We do not use cookies for advertising, tracking, or analytics. No data is shared with third parties.</p>
    </div>
  </div>
</div>

<script>
function showPrivacyModal() {
  const modal = document.getElementById('privacyModal');
  if (modal) {
    modal.style.display = 'flex';
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
}

function closePrivacyModal() {
  const modal = document.getElementById('privacyModal');
  if (modal) {
    modal.style.display = 'none';
    modal.classList.remove('open');
    document.body.style.overflow = '';
  }
}

// Close modal when clicking outside
document.getElementById('privacyModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePrivacyModal();
  }
});
</script>
<script src="js/mobile-nav.js?v=202602171mhr"></script>
</body>
    </html>
