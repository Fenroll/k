<!DOCTYPE html>
<html lang="en">
<head>
  <script src="js/auth-guard.js?v=202602171qz1"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Tools</title>
  
  <!-- Favicon -->
  <link rel="icon" href="favicon.svg?v=202602171qz1" type="image/svg+xml">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,700&display=swap">
  
  <style>
    /* Base styles */
    *, *::before, *::after { box-sizing: border-box; }
    body { background: #f5f5f5; font-family: 'Open Sans', Arial, sans-serif; margin: 0; overflow-y: scroll; }
    .layout { display: flex; min-height: 100vh; }
    
    /* Sidebar styling */
    #side-menu {
      background: #262626;
      width: 200px;
      min-width: 200px;
      max-width: 200px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 100;
    }
    
    .logo-header {
      background: #262626;
      width: 200px !important;
      height: 107px !important;
      min-width: 200px !important;
      min-height: 107px !important;
      max-width: 200px !important;
      max-height: 107px !important;
      text-align: center;
      border-bottom: none;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden;
      flex: 0 0 107px !important;
      box-sizing: content-box;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 2px solid #1d1b1b;
    }
    
    .logo-header > a {
      display: block;
      margin: 0 !important;
      padding: 0 !important;
      box-sizing: content-box;
    }
    
    .logo-img {
      width: 240px !important;
      height: 50px !important;
      object-fit: contain;
      padding-top: 1px !important;
      margin: 0 !important;
      display: block;
      box-sizing: content-box;
    }
    
    .sidebar-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-nav a {
      display: flex;
      align-items: center;
      color: #fff !important;
      text-decoration: none;
      padding: 16px 28px 16px 12px;
      font-size: 14px;
      transition: background 0.2s;
      gap: 12px;
      background: transparent;
      font-weight: 400;
      position: relative;
      border-radius: 0;
      flex-direction: row;
    }
    
    .sidebar-nav .active a {
      background: #000000;
    }
    
    .sidebar-nav .active a::before {
      content: '';
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: #588157;
    }
    
    .sidebar-nav a:hover {
      background: #181818;
    }
    
    .sidebar-nav .svg-icon {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
      margin-right: -2px;
      margin-left: -2px;
      margin-top: -2px;
      margin-bottom: -2px;
    }
    
    .sidebar-nav a[href*="messages"] .svg-icon {
      filter: brightness(0) invert(1);
    }
    
    .sidebar-footer-links {
      position: absolute;
      left: 12px;
      bottom: 11px;
      display: flex;
      flex-direction: column;
      gap: 2.5px;
      font-size: 12px;
      color: #cdcdcd;
    }
    
    .sidebar-footer-item {
      font-size: 12px;
      color: #cdcdcd;
      cursor: default;
    }
    
    .sidebar-footer-item:hover {
      color: #fff;
      text-decoration: underline;
    }
    
    .bb-inner-wrap {
      position: relative;
      height: 100%;
    }
    
    /* Main content */
    .main-content {
      flex: 1;
      padding: 0 0 0 200px;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .main-header {
      background: #fff;
      color: #000;
      width: 100%;
      height: 107px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #d3cdcd;
    }
    
    .page-title {
      font-size: 30px !important;
      margin-left: 30px !important;
      font-family: 'Open Sans', serif;
      font-weight: 400;
    }
    
    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-family: 'Open Sans', Arial, sans-serif;
    }
    
    .btn-primary {
      background: #588157;
      color: white;
    }
    
    .btn-primary:hover {
      background: #476647;
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #4b5563;
    }
    
    .btn-secondary:hover {
      background: #d1d5db;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }

    /* Upload Tool Styles */
    .drop-zone {
      border: 3px dashed #d1d5db;
      border-radius: 12px;
      padding: 60px 40px;
      text-align: center;
      transition: all 0.3s ease;
      background: white;
      cursor: pointer;
    }
    
    .drop-zone:hover {
      border-color: #588157;
      background: #f0f9ff;
    }
    
    .drop-zone.drag-over {
      border-color: #588157;
      background: #dbeafe;
      border-style: solid;
    }
    
    .drop-zone.drag-over .drop-zone-content {
      display: none;
    }
    
    .drop-zone.drag-over .drop-zone-active {
      display: block !important;
    }
    
    .drop-zone-content h3 {
      margin: 0 0 8px 0;
      color: #262626;
      font-size: 20px;
    }
    
    .drop-zone-content p {
      margin: 8px 0;
      color: #666;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .file-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    
    .file-item-name {
      font-weight: 500;
      color: #262626;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .file-item-size {
      color: #666;
      font-size: 13px;
    }
    
    .file-item-status {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .file-item-status.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .file-item-status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .file-item-status.uploading {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #588157, #6b9b6a);
      width: 0%;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .main-content {
        padding-left: 0 !important;
        padding-bottom: 90px !important;
        overflow-x: hidden;
      }

      .content {
        padding: 0 10px 16px;
        overflow-x: hidden;
      }

      .tools-menu {
        padding: 14px 10px !important;
      }

      .tools-menu > div {
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        max-width: 100% !important;
      }

      .test-menu-btn {
        width: 100%;
        min-height: 46px;
        padding: 8px 6px !important;
        font-size: 0 !important;
      }

      .test-menu-btn::before {
        content: attr(data-emoji);
        font-size: 22px;
        line-height: 1;
      }

      .upload-container,
      #financeTool > div,
      #tool3Tool > div {
        max-width: 100% !important;
        margin: 16px auto !important;
        padding: 14px !important;
      }

      .drop-zone {
        padding: 24px 14px;
      }

      #financeAdminPanel > div:nth-of-type(2) {
        grid-template-columns: 1fr !important;
      }

      #financeTool > div > div:first-child {
        justify-content: center !important;
        align-items: center !important;
        text-align: center;
      }

      #financeTool > div > div:first-child > div {
        width: 100%;
        justify-content: center !important;
      }

      #financeDonationsSection {
        overflow-x: auto;
        padding: 10px !important;
      }

      #financeDonationsRows {
        min-width: 0;
        width: max-content;
      }

      #financeDonationsRows .finance-donation-row {
        grid-template-columns: 114px 68px 48px 88px !important;
        gap: 5px !important;
        width: max-content;
      }

      #financeDonationsRows .finance-donation-row input,
      #financeDonationsRows .finance-donation-row select {
        padding: 8px 6px !important;
      }

      #financeDonationsRows .finance-donation-row .finance-donation-paid {
        padding-right: 20px !important;
      }

      #financeAdminActions {
        justify-content: center !important;
        width: 100%;
      }
      
      .main-header {
        display: none !important;
      }
      
      #side-menu {
        display: none !important;
      }
    }
  </style>
  <link rel="stylesheet" href="css/mobile-nav.css?v=202602171qz1">
  <script src="js/version-manager.js?v=202602171qz1"></script>
</head>
<body>
  <div class="layout">
    <!-- Side menu -->
    <div id="side-menu">
      <div class="bb-inner-wrap">
        <div class="logo-header">
          <a href="https://elearn.mu-varna.bg" target="_blank" rel="noopener noreferrer">
            <img class="logo-img" src="svg/logo-coursebook.svg?v=202602171qz1" alt="StudyBoard">
          </a>
        </div>
        <nav class="sidebar-nav" aria-label="Main">
          <ul>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content" href="https://elearn.mu-varna.bg/ultra/course">
                <img class="svg-icon" width="22" height="22" src="svg/icon-blackboard.svg?v=202602171qz1" alt="blackboard" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Blackboard</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="account.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-account.svg?v=202602171qz1" alt="Account" />
                <span class="link-text">Account</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="index.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-courses.svg?v=202602171qz1" alt="Courses" />
                <span class="link-text">Courses</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="anamnesis.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-anamnesis.svg?v=202602171qz1" alt="Anamnesis" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Anamnesis</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a href="calendar.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-calendar.svg?v=202602171qz1" alt="Calendar" />
                <span class="link-text">Calendar</span>
              </a>
            </li>
            <li class="base-navigation-button active">
              <a href="tools.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-tools.svg?v=202602171qz1" alt="Tools" />
                <span class="link-text">Tools</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="text-editor.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-editor.svg?v=202602171qz1" alt="Editor" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Editor</span>
              </a>
            </li>
            <li class="base-navigation-button" id="admin-button" style="display: none;">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="admin.html?v=202602171qz1">
                <img class="svg-icon" width="22" height="22" src="svg/icon-admin.svg?v=202602171qz1" alt="Admin Panel" style="filter: brightness(0) invert(1);" />
                <span class="link-text">Admin Panel</span>
              </a>
            </li>
            <li class="base-navigation-button">
              <a class="base-navigation-button-content themed-background-primary-alt-fill-only theme-border-left-active" href="#" onclick="handleLogout()">
                <img class="svg-icon" width="22" height="22" src="svg/icon-signout.svg?v=202602171qz1" alt="Sign Out" />
                <span class="link-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="sidebar-footer-links">
          <span class="sidebar-footer-item" onclick="showPrivacyModal()" style="cursor: pointer;">Privacy</span>
          <span class="sidebar-footer-item" onclick="toggleVersionInfo()" style="cursor: pointer;">Version</span>
          <span id="versionInfo" style="display: none; position: absolute; left: 100%; bottom: 0; margin-left: 20px; padding: 3px 20px; background: #333; color: white; border-radius: 6px; font-size: 0.85em; white-space: normal; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-width: calc(100vw - 280px);"></span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <header class="main-header">
        <h1 class="page-title">Tools</h1>
      </header>
      
      <!-- Tools Menu -->
      <div class="tools-menu" style="padding: 30px 20px; background: #f5f5f5; border-bottom: 1px solid #e5e7eb;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; max-width: 1200px; margin: 0 auto;">
          <button class="test-menu-btn active" data-test="upload" data-emoji="üì§" style="padding: 18px 24px; border: none; background: #588157; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; color: white; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(88, 129, 87, 0.2); display: flex; align-items: center; justify-content: center; gap: 8px;">
            üì§ –ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ
          </button>
          <button class="test-menu-btn" data-test="finance" data-emoji="üí∂" id="financeMenuBtn" style="padding: 18px 24px; border: none; background: white; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; color: #666; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; gap: 8px;">
            üí∂ –§–∏–Ω–∞–Ω—Å–∏
          </button>
          <button class="test-menu-btn" data-test="tool3" data-emoji="üìù" style="padding: 18px 24px; border: none; background: white; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; color: #666; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; gap: 8px;">
            üìù –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 3 (—Å–∫–æ—Ä–æ)
          </button>
        </div>
      </div>
      
      <div class="content">
        <!-- File Upload Container -->
        <div id="uploadTool" class="test-container" style="display: block;">
          <div class="upload-container" style="max-width: 800px; margin: 40px auto; padding: 30px;">
            <h2 style="text-align: center; margin-bottom: 30px; color: #262626;">–ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ –≤ Cloudflare R2</h2>
            
            <!-- Drop Zone -->
            <div id="dropZone" class="drop-zone">
              <div class="drop-zone-content">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #588157; margin-bottom: 16px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <h3>–ü—É—Å–Ω–µ—Ç–µ —Ñ–∞–π–ª–æ–≤–µ –∏–ª–∏ –ø–∞–ø–∫–∏ —Ç—É–∫</h3>
                <p>–∏–ª–∏</p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                  <label for="singleFileInput" class="btn btn-primary" style="cursor: pointer;">
                    üìÑ –ò–∑–±–µ—Ä–∏ —Ñ–∞–π–ª–æ–≤–µ
                  </label>
                  <label for="fileInput" class="btn btn-secondary" style="cursor: pointer;">
                    üìÅ –ò–∑–±–µ—Ä–∏ –ø–∞–ø–∫–∞
                  </label>
                </div>
                <input type="file" id="fileInput" multiple webkitdirectory directory style="display: none;">
                <input type="file" id="singleFileInput" multiple style="display: none;">
                <p style="font-size: 12px; color: #666; margin-top: 12px;">–ò–∑–±–µ—Ä–∏ –æ—Ç–¥–µ–ª–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ –∏–ª–∏ —Ü—è–ª–∞ –ø–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–æ–≤–µ</p>
              </div>
              <div class="drop-zone-active" style="display: none;">
                <h3>–ü—É—Å–Ω–µ—Ç–µ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ —Ç—É–∫</h3>
              </div>
            </div>
            
            <!-- Upload Progress -->
            <div id="uploadProgress" style="display: none; margin-top: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span id="uploadStatusText">–ö–∞—á–≤–∞–Ω–µ...</span>
                <span id="uploadPercentage">0%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
              </div>
            </div>
            
            <!-- File List -->
            <div id="fileList" style="margin-top: 24px; display: none;">
              <h3 style="margin-bottom: 16px;">–ò–∑–±—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ</h3>
              <div id="fileListContainer" style="max-height: 400px; overflow-y: auto;">
                <!-- Files will be listed here -->
              </div>
              <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button id="uploadBtn" class="btn btn-success">–ö–∞—á–∏ –≤—Å–∏—á–∫–∏ —Ñ–∞–π–ª–æ–≤–µ</button>
                <button id="clearFilesBtn" class="btn btn-secondary">–ò–∑—á–∏—Å—Ç–∏</button>
              </div>
            </div>
            
            <!-- Upload Results -->
            <div id="uploadResults" style="display: none; margin-top: 24px;">
              <h3>–†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
              <div id="uploadResultsList"></div>
            </div>
          </div>
        </div>

        <div id="financeTool" class="test-container" style="display: none;">
          <div style="max-width: 1000px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
              <h2 style="margin: 0; color: #1f2937;">–§–∏–Ω–∞–Ω—Å–∏</h2>
              <div style="display: flex; align-items: center; gap: 8px;">
                <button id="financePrevMonthBtn" type="button" class="btn btn-secondary" style="padding: 8px 12px;">‚óÄ</button>
                <div id="financeMonthLabel" style="min-width: 180px; text-align: center; font-weight: 700; color: #374151;"></div>
                <button id="financeNextMonthBtn" type="button" class="btn btn-secondary" style="padding: 8px 12px;">‚ñ∂</button>
              </div>
            </div>

            <div id="financeMyDonationCard" style="display: none; margin-bottom: 16px; padding: 14px; border-radius: 10px; border: 1px solid #d1d5db; background: #f9fafb;">
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 6px; font-weight: 700;">–ú–æ—è—Ç –ø—Ä–∏—Ö–æ–¥:</div>
              <div id="financeMyDonationText" style="font-size: 15px; font-weight: 700; color: #1f2937;">‚Äî</div>
            </div>

            <div id="financeAdminPanel" style="display: none;">
              <div id="financeStatus" style="display: none; margin-bottom: 12px; padding: 10px 12px; border-radius: 8px; font-size: 14px;"></div>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-bottom: 16px;">
                <div style="border: 1px solid #d1fae5; border-left: 5px solid #10b981; border-radius: 10px; padding: 14px; background: #ecfdf5;">
                  <h3 style="margin: 0 0 10px 0; color: #065f46;">–î–æ—Ö–æ–¥–∏</h3>
                  <textarea id="financeIncomeInput" style="width: 100%; min-height: 180px; border: 1px solid #a7f3d0; border-radius: 8px; padding: 10px; box-sizing: border-box; resize: vertical; font-size: 14px;" placeholder="–ü—Ä–∏–º–µ—Ä:\n- Donations: 45 EUR\n- –°–ø–æ–Ω—Å–æ—Ä—Å—Ç–≤–æ: 20 EUR"></textarea>
                  <div id="financeIncomePreview" style="display:none; min-height: 180px; border: 1px solid #a7f3d0; border-radius: 8px; padding: 10px; box-sizing: border-box; background:#fff; font-size: 14px; color:#374151; white-space: normal;"></div>
                </div>

                <div style="border: 1px solid #fecaca; border-left: 5px solid #ef4444; border-radius: 10px; padding: 14px; background: #fef2f2;">
                  <h3 style="margin: 0 0 10px 0; color: #991b1b;">–†–∞–∑—Ö–æ–¥–∏</h3>
                  <textarea id="financeExpenseInput" style="width: 100%; min-height: 180px; border: 1px solid #fca5a5; border-radius: 8px; padding: 10px; box-sizing: border-box; resize: vertical; font-size: 14px;" placeholder="–ü—Ä–∏–º–µ—Ä:\n- –•–æ—Å—Ç–∏–Ω–≥: 12 EUR\n- –î–æ–º–µ–π–Ω: 9 EUR"></textarea>
                  <div id="financeExpensePreview" style="display:none; min-height: 180px; border: 1px solid #fca5a5; border-radius: 8px; padding: 10px; box-sizing: border-box; background:#fff; font-size: 14px; color:#374151; white-space: normal;"></div>
                </div>
              </div>

              <div id="financeDonationsSection" style="border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; background: #f9fafb; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 10px;">
                  <h3 style="margin: 0; color: #1f2937;">Donations –ø–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</h3>
                </div>

                <div id="financeDonationsRows"></div>
              </div>

              <div id="financeAdminActions" style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                <button id="financeReloadBtn" type="button" class="btn btn-secondary">–ü—Ä–µ–∑–∞—Ä–µ–¥–∏</button>
                <button id="financeSaveBtn" type="button" class="btn btn-success">–ó–∞–ø–∞–∑–∏ –∑–∞ –º–µ—Å–µ—Ü–∞</button>
              </div>

              <div id="financeLastUpdate" style="margin-top: 10px; font-size: 12px; color: #6b7280;"></div>
            </div>
          </div>
        </div>

        <div id="tool3Tool" class="test-container" style="display: none;">
          <div style="max-width: 800px; margin: 40px auto; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); color: #6b7280; text-align: center;">
            –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 3 –ø—Ä–µ–¥—Å—Ç–æ–∏.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Test menu functionality
    document.querySelectorAll('.test-menu-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        // Remove active state from all buttons
        document.querySelectorAll('.test-menu-btn').forEach(b => {
          b.style.borderColor = '';
          b.style.background = 'white';
          b.style.color = '#666';
          b.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
        });
        
        // Add active state to clicked button
        e.target.style.borderColor = '';
        e.target.style.background = '#588157';
        e.target.style.color = 'white';
        e.target.style.boxShadow = '0 4px 15px rgba(88, 129, 87, 0.2)';
        
        // Hide all test containers
        document.querySelectorAll('.test-container').forEach(test => {
          test.style.display = 'none';
        });
        
        // Show selected tool
        const button = e.currentTarget;
        const testType = button.dataset.test;
        if (testType === 'upload') {
          document.getElementById('uploadTool').style.display = 'block';
        } else if (testType === 'finance') {
          document.getElementById('financeTool').style.display = 'block';
        } else if (testType === 'tool3') {
          document.getElementById('tool3Tool').style.display = 'block';
        }
      });
    });
    
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const sideMenu = document.getElementById('side-menu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      
      // Check if elements exist
      if (!mobileMenuToggle || !sideMenu || !mobileMenuOverlay) {
        return;
      }
      
      // Function to close menu
      function closeMenu() {
        sideMenu.classList.remove('show');
        mobileMenuOverlay.classList.remove('show');
        mobileMenuToggle.classList.remove('hidden');
      }
      
      // Function to open menu
      function openMenu() {
        sideMenu.classList.add('show');
        mobileMenuOverlay.classList.add('show');
        mobileMenuToggle.classList.add('hidden');
      }
      
      // Toggle menu on button click
      mobileMenuToggle.addEventListener('click', function() {
        if (sideMenu.classList.contains('show')) {
          closeMenu();
        } else {
          openMenu();
        }
      });
      
      // Close menu when clicking on overlay
      mobileMenuOverlay.addEventListener('click', closeMenu);
    });
  </script>
  
  <!-- File Upload Script -->
  <script>
    // Cloudflare R2 Upload Configuration
    const R2_WORKER_URL = 'https://r2-upload.sergey-2210-pavlov.workers.dev';
    
    let selectedFiles = [];
    
    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const singleFileInput = document.getElementById('singleFileInput');
    const fileList = document.getElementById('fileList');
    const fileListContainer = document.getElementById('fileListContainer');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearFilesBtn = document.getElementById('clearFilesBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadStatusText = document.getElementById('uploadStatusText');
    const uploadPercentage = document.getElementById('uploadPercentage');
    const progressBarFill = document.getElementById('progressBarFill');
    const uploadResults = document.getElementById('uploadResults');
    const uploadResultsList = document.getElementById('uploadResultsList');
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // File/Folder input change (labels trigger inputs directly now)
    fileInput.addEventListener('change', (e) => {
      handleFiles(Array.from(e.target.files));
    });
    
    singleFileInput.addEventListener('change', (e) => {
      handleFiles(Array.from(e.target.files));
    });
    
    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      
      const items = Array.from(e.dataTransfer.items);
      const files = [];
      
      // Process dropped items (handles folders)
      Promise.all(items.map(item => {
        if (item.kind === 'file') {
          const entry = item.webkitGetAsEntry();
          if (entry) {
            return traverseFileTree(entry);
          }
        }
        return Promise.resolve([]);
      })).then(results => {
        results.forEach(fileArray => files.push(...fileArray));
        handleFiles(files);
      });
    });
    
    // Traverse folder tree
    function traverseFileTree(item, path = '') {
      return new Promise((resolve) => {
        if (item.isFile) {
          item.file(file => {
            const fullPath = path + file.name;
            file.fullPath = fullPath;
            resolve([file]);
          });
        } else if (item.isDirectory) {
          const dirReader = item.createReader();
          dirReader.readEntries(entries => {
            Promise.all(entries.map(entry => 
              traverseFileTree(entry, path + item.name + '/')
            )).then(results => {
              resolve(results.flat());
            });
          });
        } else {
          resolve([]);
        }
      });
    }
    
    // Handle selected files
    function handleFiles(files) {
      files.forEach(file => {
        // Add fullPath if not set
        if (!file.fullPath) {
          file.fullPath = file.webkitRelativePath || file.name;
        }
        
        // Check if file already exists
        if (!selectedFiles.find(f => f.fullPath === file.fullPath)) {
          selectedFiles.push(file);
        }
      });
      
      renderFileList();
      fileList.style.display = 'block';
      uploadResults.style.display = 'none';
    }
    
    // Render file list
    function renderFileList() {
      fileListContainer.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item" data-index="${index}">
          <div class="file-item-info">
            <span class="file-item-name" title="${file.fullPath}">üìÑ ${file.fullPath}</span>
            <span class="file-item-size">${formatFileSize(file.size)}</span>
          </div>
          <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="removeFile(${index})">–ü—Ä–µ–º–∞—Ö–Ω–∏</button>
        </div>
      `).join('');
    }
    
    // Remove file
    window.removeFile = function(index) {
      selectedFiles.splice(index, 1);
      renderFileList();
      if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
      }
    };
    
    // Clear all files
    clearFilesBtn.addEventListener('click', () => {
      selectedFiles = [];
      fileList.style.display = 'none';
      uploadResults.style.display = 'none';
      fileInput.value = '';
      singleFileInput.value = '';
    });
    
    // Upload files
    uploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;
      
      // Get current user name
      let userName = 'anonymous';
      try {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (loggedInUser) {
          const user = JSON.parse(loggedInUser);
          userName = user.userName || user.displayName || 'anonymous';
        }
      } catch (e) {
        console.warn('Could not get user name:', e);
      }
      
      uploadProgress.style.display = 'block';
      uploadBtn.disabled = true;
      clearFilesBtn.disabled = true;
      
      const results = [];
      let completed = 0;
      
      for (const file of selectedFiles) {
        try {
          uploadStatusText.textContent = `–ö–∞—á–≤–∞–Ω–µ –Ω–∞ ${file.fullPath}...`;
          
          const formData = new FormData();
          formData.append('file', file);
          formData.append('path', file.fullPath);
          formData.append('userName', userName);
          
          const response = await fetch(R2_WORKER_URL, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            const data = await response.json();
            results.push({ file: file.fullPath, status: 'success', url: data.url });
          } else {
            const errorText = await response.text();
            console.error('Upload error for', file.fullPath, ':', errorText);
            results.push({ file: file.fullPath, status: 'error', message: errorText });
          }
        } catch (error) {
          results.push({ file: file.fullPath, status: 'error', message: error.message });
        }
        
        completed++;
        const percentage = Math.round((completed / selectedFiles.length) * 100);
        uploadPercentage.textContent = `${percentage}%`;
        progressBarFill.style.width = `${percentage}%`;
      }
      
      // Show results
      uploadProgress.style.display = 'none';
      uploadResults.style.display = 'block';
      uploadResultsList.innerHTML = results.map(result => `
        <div class="file-item">
          <div class="file-item-info">
            <span class="file-item-name">${result.file}</span>
          </div>
          <span class="file-item-status ${result.status}">
            ${result.status === 'success' ? '‚úì –ö–∞—á–µ–Ω' : '‚úó –ì—Ä–µ—à–∫–∞'}
          </span>
        </div>
      `).join('');
      
      uploadBtn.disabled = false;
      clearFilesBtn.disabled = false;
      uploadStatusText.textContent = '–ö–∞—á–≤–∞–Ω–µ –∑–∞–≤—ä—Ä—à–µ–Ω–æ!';
      
      // Clear selected files after successful upload
      selectedFiles = [];
      fileList.style.display = 'none';
    });
  </script>
  
  <script>
    // Show admin button if user is admin
    document.addEventListener('DOMContentLoaded', function() {
      const adminButton = document.getElementById('admin-button');
      if (adminButton && window.currentUserPromise) {
        window.currentUserPromise.then(user => {
          if (user && user.isAdmin) {
            adminButton.style.display = 'list-item';
          }
        }).catch(error => {
          console.error("Error checking admin status for button visibility:", error);
        });
      }
    });
  </script>
  
  <script src="js/user-identity.js?v=202602171mhr"></script>
  <!-- Mobile menu overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

  <!-- ============================================
       FIREBASE & CHAT WIDGET
       ============================================ -->
  <!-- Initialize Chat Widget -->
    <script src="js/chat.js?v=202602171qz1"></script>

  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
  <script src="js/presence.js?v=202602171mhr"></script>
<script>
  (function() {
    const firebaseConfig = {
      apiKey: "API_KEY",
      authDomain: "med-student-chat.firebaseapp.com",
      databaseURL: "https://med-student-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "med-student-chat",
      storageBucket: "med-student-chat.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    try {
      if (typeof firebase !== 'undefined' && firebase.apps && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    } catch (error) {
      console.warn('Firebase init warning in tools finance module:', error);
    }

    const state = {
      monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      currentUser: null,
      isAdmin: false
    };

    const SPECIAL_DONATION_RULES = [
      { aliases: ['vikopiko'], label: 'Driver Pass' },
      { aliases: ['–ø–∞–∏—Å–∏–π', 'paisiy'], label: 'Owner' }
    ];

    const FINANCE_BLUE = '#2563eb';

    const MIN_FINANCE_MONTH = new Date(2026, 0, 1);

    function getCurrentMonthStart() {
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), 1);
    }

    function clampFinanceMonth(date) {
      const normalized = new Date(date.getFullYear(), date.getMonth(), 1);
      const maxMonth = getCurrentMonthStart();

      if (normalized < MIN_FINANCE_MONTH) return new Date(MIN_FINANCE_MONTH);
      if (normalized > maxMonth) return maxMonth;
      return normalized;
    }

    function getMonthKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function normalizeText(value) {
      return String(value || '').trim().toLowerCase();
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderFormattedFinanceText(value) {
      let html = escapeHtml(value || '');

      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/&lt;u&gt;([\s\S]*?)&lt;\/u&gt;/g, '<u>$1</u>');
      html = html.replace(/(\d+(?:[\.,]\d+)?)\s*‚Ç¨/g, `<span style="color:${FINANCE_BLUE}; font-weight:700;">$1‚Ç¨</span>`);
      html = html.replace(/(^|\n)-\s+/g, '$1‚Ä¢ ');
      html = html.replace(/\n/g, '<br>');

      return html;
    }

    function syncFinancePreview(textarea, preview) {
      if (!textarea || !preview) return;
      preview.innerHTML = renderFormattedFinanceText(textarea.value || '');
    }

    function setFinancePreviewMode(textarea, preview, editable) {
      if (!textarea || !preview) return;

      textarea.style.display = 'none';
      preview.style.display = 'block';
      preview.style.cursor = editable ? 'text' : 'default';
      syncFinancePreview(textarea, preview);
    }

    function setFinanceRawMode(textarea, preview) {
      if (!textarea || !preview) return;

      preview.style.display = 'none';
      textarea.style.display = 'block';
      textarea.focus();
      const end = textarea.value.length;
      textarea.setSelectionRange(end, end);
    }

    function bindFinancePreviewToggle(textarea, preview, editable) {
      if (!textarea || !preview || textarea.dataset.previewBound === 'true') return;

      if (editable) {
        preview.addEventListener('click', () => {
          setFinanceRawMode(textarea, preview);
        });

        textarea.addEventListener('blur', () => {
          setFinancePreviewMode(textarea, preview, true);
        });

        textarea.addEventListener('input', () => {
          syncFinancePreview(textarea, preview);
        });
      }

      textarea.dataset.previewBound = 'true';
    }

    function getCurrentUserIdentityNames() {
      if (!state.currentUser) return [];
      const identity = [
        state.currentUser.userName,
        state.currentUser.username,
        state.currentUser.displayName,
        state.currentUser.uid,
        state.currentUser.userId
      ];

      return identity
        .map(normalizeText)
        .filter(Boolean);
    }

    function getSpecialRuleByName(name) {
      const normalized = normalizeText(name);
      if (!normalized) return null;

      return SPECIAL_DONATION_RULES.find(rule =>
        rule.aliases.some(alias => normalizeText(alias) === normalized)
      ) || null;
    }

    function getSpecialRuleForUser(user) {
      if (!user) return null;
      const candidates = [user.displayName, user.username, user.userName];
      for (const candidate of candidates) {
        const rule = getSpecialRuleByName(candidate);
        if (rule) return rule;
      }
      return null;
    }

    function getSpecialRuleForCurrentUser() {
      const identityNames = getCurrentUserIdentityNames();
      for (const name of identityNames) {
        const rule = getSpecialRuleByName(name);
        if (rule) return rule;
      }
      return null;
    }

    function formatMonthLabel(date) {
      return date.toLocaleDateString('bg-BG', { year: 'numeric', month: 'long' });
    }

    function financeRefForMonth(date) {
      return firebase.database().ref(`finance/monthly/${getMonthKey(date)}`);
    }


    function setFinanceStatus(message, isError = false) {
      const statusEl = document.getElementById('financeStatus');
      if (!statusEl) return;

      statusEl.textContent = message;
      statusEl.style.display = 'block';
      if (isError) {
        statusEl.style.background = '#fef2f2';
        statusEl.style.color = '#991b1b';
        statusEl.style.border = '1px solid #fecaca';
      } else {
        statusEl.style.background = '#ecfdf5';
        statusEl.style.color = '#065f46';
        statusEl.style.border = '1px solid #a7f3d0';
      }
    }

    function clearFinanceStatus() {
      const statusEl = document.getElementById('financeStatus');
      if (!statusEl) return;
      statusEl.style.display = 'none';
      statusEl.textContent = '';
    }

    function createDonationRow(row = {}) {
      const wrapper = document.createElement('div');
      wrapper.className = 'finance-donation-row';
      wrapper.dataset.userId = row.uid || '';

      if (row.specialLabel) {
        wrapper.style.display = 'grid';
        wrapper.style.gridTemplateColumns = 'minmax(200px, 2fr) minmax(200px, 1fr)';
        wrapper.style.gap = '8px';
        wrapper.style.marginBottom = '8px';
        wrapper.innerHTML = `
          <input type="text" class="finance-donation-user" value="${(row.user || '').replace(/"/g, '&quot;')}" readonly>
          <input type="text" class="finance-donation-special" value="${(row.specialLabel || '').replace(/"/g, '&quot;')}" readonly>
        `;

        wrapper.querySelectorAll('input').forEach(el => {
          el.style.padding = '8px 10px';
          el.style.border = '1px solid #d1d5db';
          el.style.borderRadius = '8px';
          el.style.fontSize = '13px';
          el.style.background = '#f3f4f6';
          el.style.color = FINANCE_BLUE;
          el.style.fontWeight = '700';
        });

        return wrapper;
      }

      wrapper.style.display = 'grid';
      wrapper.style.gridTemplateColumns = 'minmax(180px, 1.5fr) minmax(90px, 0.7fr) minmax(90px, 0.7fr) minmax(220px, 1.6fr)';
      wrapper.style.gap = '8px';
      wrapper.style.marginBottom = '8px';
      wrapper.innerHTML = `
        <input type="text" class="finance-donation-user" value="${(row.user || '').replace(/"/g, '&quot;')}" readonly>
        <select class="finance-donation-paid">
          <option value="yes" ${row.donated ? 'selected' : ''}>–î–∞</option>
          <option value="no" ${!row.donated ? 'selected' : ''}>–ù–µ</option>
        </select>
        <input type="number" class="finance-donation-amount" min="0" step="0.01" placeholder="EUR" value="${Number.isFinite(row.amount) ? row.amount : ''}">
        <input type="text" class="finance-donation-note" placeholder="–ë–µ–ª–µ–∂–∫–∞" value="${String(row.note || '').replace(/"/g, '&quot;')}">
      `;

      wrapper.querySelectorAll('input, select').forEach(el => {
        el.style.padding = '8px 10px';
        el.style.border = '1px solid #d1d5db';
        el.style.borderRadius = '8px';
        el.style.fontSize = '13px';
      });

      const amountInput = wrapper.querySelector('.finance-donation-amount');
      if (amountInput) {
        amountInput.style.color = FINANCE_BLUE;
        amountInput.style.fontWeight = '700';
      }

      return wrapper;
    }

    function getDonationsFromUI() {
      const rowsContainer = document.getElementById('financeDonationsRows');
      if (!rowsContainer) return [];

      const rows = Array.from(rowsContainer.querySelectorAll('.finance-donation-row'));
      return rows
        .map(row => {
          const specialLabel = row.querySelector('.finance-donation-special')?.value?.trim() || '';
          if (specialLabel) {
            return null;
          }

          const uid = row.dataset.userId || '';
          const user = row.querySelector('.finance-donation-user')?.value?.trim() || '';
          const donated = row.querySelector('.finance-donation-paid')?.value === 'yes';
          const amountRaw = row.querySelector('.finance-donation-amount')?.value;
          const amount = amountRaw === '' ? null : Number(amountRaw);
          const note = row.querySelector('.finance-donation-note')?.value?.trim() || '';
          return { uid, user, donated, amount, note };
        })
        .filter(entry => entry && (entry.uid || entry.user || entry.amount !== null || entry.note));
    }

    async function loadDonationMembersList() {
      const usersSnap = await firebase.database().ref('site_users').once('value');
      const users = usersSnap.val() || {};

      return Object.entries(users)
        .filter(([, user]) => {
          if (!user) return false;

          const username = normalizeText(user.username);
          const displayName = normalizeText(user.displayName);
          const userName = normalizeText(user.userName);
          const isTestAccount = username === 'test' || displayName === 'test' || userName === 'test';

          if (!user.showInMembersList && !isTestAccount) return false;

          const specialRule = getSpecialRuleForUser(user);
          if (specialRule && specialRule.label === 'Owner') {
            return false; // Paisiy/Owner should not be editable in list
          }
          if (specialRule && specialRule.label === 'Driver Pass') {
            return false; // Vikopiko should not be shown in donations list
          }

          return true;
        })
        .map(([uid, user]) => ({
          uid,
          user: user.displayName || user.username || uid,
          username: user.username || '',
          isTestAccount: normalizeText(user.username) === 'test' || normalizeText(user.displayName) === 'test' || normalizeText(user.userName) === 'test',
          specialLabel: getSpecialRuleForUser(user)?.label || ''
        }))
        .sort((a, b) => {
          if (a.isTestAccount && !b.isTestAccount) return 1;
          if (!a.isTestAccount && b.isTestAccount) return -1;
          return a.user.localeCompare(b.user, 'bg');
        });
    }

    function mergeDonationsByMembers(savedRows, members) {
      const byUid = new Map();
      const byName = new Map();

      (savedRows || []).forEach(row => {
        if (!row) return;
        if (row.uid) byUid.set(String(row.uid), row);
        if (row.user) byName.set(String(row.user).toLowerCase(), row);
      });

      return members.map(member => {
        if (member.specialLabel) {
          return {
            uid: member.uid,
            user: member.user,
            specialLabel: member.specialLabel
          };
        }

        const existing = byUid.get(String(member.uid)) || byName.get(String(member.user).toLowerCase()) || byName.get(String(member.username || '').toLowerCase()) || null;

        return {
          uid: member.uid,
          user: member.user,
          donated: !!existing?.donated,
          amount: Number.isFinite(existing?.amount) ? existing.amount : null,
          note: typeof existing?.note === 'string' ? existing.note : ''
        };
      });
    }

    function renderDonationsRows(rows) {
      const rowsContainer = document.getElementById('financeDonationsRows');
      if (!rowsContainer) return;
      rowsContainer.innerHTML = '';

      if (!rows || rows.length === 0) {
        rowsContainer.appendChild(createDonationRow({ donated: false }));
        return;
      }

      rows.forEach(row => rowsContainer.appendChild(createDonationRow(row)));
    }

    function renderMyDonationStatus(monthValue) {
      const card = document.getElementById('financeMyDonationCard');
      const textEl = document.getElementById('financeMyDonationText');
      if (!card || !textEl) return;

      const meNames = new Set(getCurrentUserIdentityNames());
      const meUid = normalizeText(state.currentUser?.uid || state.currentUser?.userId || '');

      card.style.display = 'block';

      const mySpecialRule = getSpecialRuleForCurrentUser();
      if (mySpecialRule) {
        textEl.textContent = mySpecialRule.label;
        textEl.style.color = FINANCE_BLUE;
        return;
      }

      const donations = Array.isArray(monthValue?.donations) ? monthValue.donations : [];
      const myDonation = donations.find(row => {
        if (!row) return false;
        const rowUid = normalizeText(row.uid || '');
        const rowUser = normalizeText(row.user || '');
        return (rowUid && rowUid === meUid) || (rowUser && meNames.has(rowUser));
      });

      if (!myDonation) {
        textEl.innerHTML = '<span style="color:#991b1b;">0‚Ç¨</span>';
        textEl.style.color = '';
        return;
      }

      if (myDonation.donated) {
        const amountValue = Number.isFinite(myDonation.amount) ? myDonation.amount : 0;
        const amountText = amountValue.toLocaleString('bg-BG');
        const noteText = typeof myDonation.note === 'string' ? myDonation.note.trim() : '';
        const safeNote = escapeHtml(noteText);
        textEl.innerHTML = noteText
          ? `<span style="color:#065f46; font-weight:700;">${amountText}‚Ç¨</span> <span style="color:#111827; font-weight:400;">(${safeNote})</span>`
          : `<span style="color:#065f46; font-weight:700;">${amountText}‚Ç¨</span>`;
        textEl.style.color = '';
      } else {
        textEl.innerHTML = '<span style="color:#991b1b;">0‚Ç¨</span>';
        textEl.style.color = '';
      }
    }


    function setMonthLabel() {
      state.monthDate = clampFinanceMonth(state.monthDate);

      const monthLabel = document.getElementById('financeMonthLabel');
      if (monthLabel) {
        monthLabel.textContent = formatMonthLabel(state.monthDate);
      }

      const prevBtn = document.getElementById('financePrevMonthBtn');
      const nextBtn = document.getElementById('financeNextMonthBtn');
      const maxMonth = getCurrentMonthStart();

      if (prevBtn) {
        prevBtn.disabled = state.monthDate <= MIN_FINANCE_MONTH;
      }

      if (nextBtn) {
        nextBtn.disabled = state.monthDate >= maxMonth;
      }
    }

    function setLastUpdate(meta) {
      const lastUpdateEl = document.getElementById('financeLastUpdate');
      if (!lastUpdateEl) return;

      if (!meta || !meta.updatedAt) {
        lastUpdateEl.textContent = '–ü–æ—Å–ª–µ–¥–µ–Ω —ä–ø–¥–µ–π—Ç: –Ω—è–º–∞';
        return;
      }

      const when = new Date(meta.updatedAt);
      const by = meta.updatedBy || 'Unknown';
      const byRule = getSpecialRuleByName(by);
      if (byRule && byRule.label === 'Owner') {
        lastUpdateEl.textContent = `–ü–æ—Å–ª–µ–¥–µ–Ω —ä–ø–¥–µ–π—Ç: ${when.toLocaleString('bg-BG')}`;
      } else {
        lastUpdateEl.textContent = `–ü–æ—Å–ª–µ–¥–µ–Ω —ä–ø–¥–µ–π—Ç: ${by} ¬∑ ${when.toLocaleString('bg-BG')}`;
      }
    }

    function applyInlineFormat(textarea, prefix, suffix) {
      if (!textarea || textarea.readOnly) return;

      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const value = textarea.value;
      const selected = value.slice(start, end);

      const replacement = `${prefix}${selected}${suffix}`;
      textarea.value = value.slice(0, start) + replacement + value.slice(end);

      const caretStart = start + prefix.length;
      const caretEnd = caretStart + selected.length;
      textarea.setSelectionRange(caretStart, caretEnd);
      textarea.focus();
    }

    function applyBulletPoints(textarea) {
      if (!textarea || textarea.readOnly) return;

      const value = textarea.value;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;

      const lineStart = value.lastIndexOf('\n', Math.max(0, start - 1)) + 1;
      const nextNewLine = value.indexOf('\n', end);
      const lineEnd = nextNewLine === -1 ? value.length : nextNewLine;

      const selectedBlock = value.slice(lineStart, lineEnd);
      const lines = selectedBlock.split('\n');
      const allBulleted = lines.every(line => line.trim() === '' || line.startsWith('- '));

      const transformedLines = allBulleted
        ? lines.map(line => (line.startsWith('- ') ? line.slice(2) : line))
        : lines.map(line => (line.trim() === '' ? line : `- ${line}`));

      const transformedBlock = transformedLines.join('\n');
      textarea.value = value.slice(0, lineStart) + transformedBlock + value.slice(lineEnd);
      textarea.setSelectionRange(lineStart, lineStart + transformedBlock.length);
      textarea.focus();
    }

    function attachFinanceFormattingShortcuts(textarea) {
      if (!textarea || textarea.dataset.shortcutsBound === 'true') return;

      textarea.addEventListener('keydown', (event) => {
        if (!(event.ctrlKey || event.metaKey) || event.altKey) return;

        const key = (event.key || '').toLowerCase();
        const code = event.code || '';

        if (code === 'KeyB' || key === 'b') {
          event.preventDefault();
          applyInlineFormat(textarea, '**', '**');
        } else if (code === 'KeyI' || key === 'i') {
          event.preventDefault();
          applyInlineFormat(textarea, '*', '*');
        } else if (code === 'KeyU' || key === 'u') {
          event.preventDefault();
          applyInlineFormat(textarea, '<u>', '</u>');
        } else if (code === 'KeyG' || key === 'g') {
          event.preventDefault();
          applyBulletPoints(textarea);
        }
      });

      textarea.dataset.shortcutsBound = 'true';
    }

    async function loadFinanceMonth() {
      if (!state.currentUser) return;

      clearFinanceStatus();
      setMonthLabel();

      try {
        const snap = await financeRefForMonth(state.monthDate).once('value');
        const value = snap.val() || {};
        const members = await loadDonationMembersList();
        const donationRows = mergeDonationsByMembers(Array.isArray(value.donations) ? value.donations : [], members);

        document.getElementById('financeIncomeInput').value = value.incomeMarkdown || '';
        document.getElementById('financeExpenseInput').value = value.expenseMarkdown || '';
        const incomePreview = document.getElementById('financeIncomePreview');
        const expensePreview = document.getElementById('financeExpensePreview');
        if (incomePreview) incomePreview.innerHTML = renderFormattedFinanceText(value.incomeMarkdown || '');
        if (expensePreview) expensePreview.innerHTML = renderFormattedFinanceText(value.expenseMarkdown || '');
        renderDonationsRows(donationRows);
        renderMyDonationStatus(value);

        setLastUpdate(value);
      } catch (error) {
        console.error('Finance load error:', error);
        setFinanceStatus(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: ${error.message}`, true);
      }
    }

    async function saveFinanceMonth() {
      if (!state.isAdmin) return;

      const saveBtn = document.getElementById('financeSaveBtn');
      if (saveBtn) saveBtn.disabled = true;
      clearFinanceStatus();

      try {
        const payload = {
          incomeMarkdown: document.getElementById('financeIncomeInput').value || '',
          expenseMarkdown: document.getElementById('financeExpenseInput').value || '',
          donations: getDonationsFromUI(),
          updatedBy: state.currentUser?.displayName || state.currentUser?.userName || state.currentUser?.userId || 'Admin',
          updatedAt: firebase.database.ServerValue.TIMESTAMP
        };

        await financeRefForMonth(state.monthDate).set(payload);
        setFinanceStatus('–§–∏–Ω–∞–Ω—Å–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ.');
        await loadFinanceMonth();
      } catch (error) {
        console.error('Finance save error:', error);
        setFinanceStatus(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ${error.message}`, true);
      } finally {
        if (saveBtn) saveBtn.disabled = false;
      }
    }

    function shiftMonth(offset) {
      const targetMonth = new Date(state.monthDate.getFullYear(), state.monthDate.getMonth() + offset, 1);
      state.monthDate = clampFinanceMonth(targetMonth);
      loadFinanceMonth();
    }

    async function initFinanceTool() {
      const financeMenuBtn = document.getElementById('financeMenuBtn');
      const adminPanel = document.getElementById('financeAdminPanel');
      const donationsSection = document.getElementById('financeDonationsSection');
      const adminActions = document.getElementById('financeAdminActions');
      const financeStatus = document.getElementById('financeStatus');
      const incomeInput = document.getElementById('financeIncomeInput');
      const expenseInput = document.getElementById('financeExpenseInput');
      const incomePreview = document.getElementById('financeIncomePreview');
      const expensePreview = document.getElementById('financeExpensePreview');
      const prevBtn = document.getElementById('financePrevMonthBtn');
      const nextBtn = document.getElementById('financeNextMonthBtn');
      const reloadBtn = document.getElementById('financeReloadBtn');
      const saveBtn = document.getElementById('financeSaveBtn');

      if (!financeMenuBtn || !adminPanel) return;

      if (!window.currentUserPromise) {
        financeMenuBtn.style.display = 'none';
        return;
      }

      try {
        state.currentUser = await window.currentUserPromise;
      } catch (error) {
        console.error('Cannot resolve current user for finance tool:', error);
      }

      state.isAdmin = !!(state.currentUser && state.currentUser.isAdmin);
      adminPanel.style.display = 'block';

      attachFinanceFormattingShortcuts(incomeInput);
      attachFinanceFormattingShortcuts(expenseInput);

      state.monthDate = clampFinanceMonth(state.monthDate);
      prevBtn?.addEventListener('click', () => shiftMonth(-1));
      nextBtn?.addEventListener('click', () => shiftMonth(1));

      if (!state.isAdmin) {
        if (donationsSection) donationsSection.style.display = 'none';
        if (adminActions) adminActions.style.display = 'none';
        if (financeStatus) financeStatus.style.display = 'none';
        if (incomeInput) {
          incomeInput.readOnly = true;
          incomeInput.style.display = 'none';
          incomeInput.style.color = '#374151';
        }
        if (expenseInput) {
          expenseInput.readOnly = true;
          expenseInput.style.display = 'none';
          expenseInput.style.color = '#374151';
        }
        setFinancePreviewMode(incomeInput, incomePreview, false);
        setFinancePreviewMode(expenseInput, expensePreview, false);
        await loadFinanceMonth();
        return;
      }

      if (donationsSection) donationsSection.style.display = 'block';
      if (adminActions) adminActions.style.display = 'flex';
      if (incomeInput) {
        incomeInput.readOnly = false;
        incomeInput.style.display = 'none';
        incomeInput.style.background = '';
        incomeInput.style.color = '';
      }
      if (expenseInput) {
        expenseInput.readOnly = false;
        expenseInput.style.display = 'none';
        expenseInput.style.background = '';
        expenseInput.style.color = '';
      }

      bindFinancePreviewToggle(incomeInput, incomePreview, true);
      bindFinancePreviewToggle(expenseInput, expensePreview, true);
      setFinancePreviewMode(incomeInput, incomePreview, true);
      setFinancePreviewMode(expenseInput, expensePreview, true);

      reloadBtn?.addEventListener('click', loadFinanceMonth);
      saveBtn?.addEventListener('click', saveFinanceMonth);

      await loadFinanceMonth();
    }

    document.addEventListener('DOMContentLoaded', initFinanceTool);
  })();
</script>
<script>
  // Initialize chat widget
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof ChatWidget !== 'undefined') {
      new ChatWidget();
    }
  });
  
  // Privacy modal
  function showPrivacyModal() {
    alert('Privacy policy coming soon!');
  }
  
  // Version info
  function toggleVersionInfo() {
    const versionInfo = document.getElementById('versionInfo');
    if (versionInfo.style.display === 'none') {
      versionInfo.textContent = 'Version 2026.02.01';
      versionInfo.style.display = 'block';
    } else {
      versionInfo.style.display = 'none';
    }
  }
  
  // Logout
  function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }
  }
</script>
<script src="js/mobile-nav.js?v=202602171mhr"></script>
</body>
</html>
