<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anamnesis</title>
    
    <!-- Scripts -->
    <script src="js/auth-guard.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
    <script src="js/user-identity.js?v=20260127"></script>
    
    <!-- Fonts & Icons -->
    <link rel="icon" href="favicon.svg?v=7" type="image/svg+xml">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif:400,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <style>
        body { background: #f5f5f5; font-family: 'Open Sans', Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styling (Exact match from calendar.html) */
        #side-menu {
            background: #262626;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 3200; /* High z-index for mobile */
            transition: transform 0.3s cubic-bezier(.4,0,.2,1);
        }
        
        .logo-header {
            background: #262626;
            width: 200px !important;
            height: 107px !important;
            min-width: 200px !important;
            min-height: 107px !important;
            max-width: 200px !important;
            max-height: 107px !important;
            text-align: center;
            border-bottom: none;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            flex: 0 0 107px !important;
            box-sizing: content-box;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 2px solid #1d1b1b;
        }
        
        .logo-img {
            width: 240px !important;
            height: 50px !important;
            object-fit: contain;
            padding-left: 70px !important;    
            padding-top: 4px !important;
        }
        
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav a {
            display: flex;
            align-items: center;
            color: #fff !important;
            text-decoration: none;
            padding: 16px 28px 16px 12px;
            font-size: 14px;
            transition: background 0.2s;
            gap: 12px;
            background: transparent;
            font-weight: 400;
            position: relative;
            border-radius: 0;
            flex-direction: row;
        }
        
        .sidebar-nav .active a {
            background: #000000;
        }
        
        .sidebar-nav .active a::before {
            content: '';
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: #588157; /* Fern */
        }
        
        .sidebar-nav a:hover {
            background: #181818;
        }
        
        .sidebar-nav .svg-icon {
            width: 26px;
            height: 26px;
            flex-shrink: 0;
            margin-right: -2px;
            margin-left: -2px;
            margin-top: -2px;
            margin-bottom: -2px;
        }
        
        .sidebar-footer-links {
            position: absolute;
            left: 12px;
            bottom: 11px;
            display: flex;
            flex-direction: column;
            gap: 2.5px;
            font-size: 12px;
            color: #cdcdcd;
        }
        
        .sidebar-footer-item {
            font-size: 12px;
            color: #cdcdcd;
            cursor: default;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding-left: 200px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f5;
        }

        .anamnesis-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Patient List Panel */
        .patient-list-panel {
            width: 320px;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        .panel-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            /* Adjust for mobile menu button */
            padding-left: 16px; 
        }
        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: 'Open Sans', sans-serif;
            margin-top: 10px;
        }
        .patient-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .patient-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .patient-item:hover { background: #f9f9f9; }
        .patient-item.selected { background: #e8f5e9; border-left: 4px solid #588157; }
        .patient-name { font-weight: 600; color: #333; margin-bottom: 4px; font-size: 15px; }
        .patient-meta { font-size: 12px; color: #888; display: flex; justify-content: space-between; }

        /* Workspace Panel */
        .workspace-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f9f9f9;
        }
        .workspace-header {
            padding: 16px 32px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workspace-title { margin: 0; font-size: 1.5rem; color: #333; font-weight: 600; font-family: 'Open Sans',Arial, sans-serif; }
        .new-btn {
            background: #588157;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Open Sans', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .new-btn:hover { background: #4a6d49; }

        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Mobile Visibility Helpers */
        .mobile-visible { display: none; }
        @media (max-width: 900px) {
            .mobile-visible { display: flex !important; }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 0;
            overflow: hidden; /* Hide all overflow on desktop */
            white-space: nowrap;
        }
        @media (max-width: 900px) {
            .tabs {
                overflow-x: auto; /* Allow horizontal scroll on mobile */
                padding-bottom: 5px;
            }
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            margin-bottom: -2px;
            font-family: 'Open Sans', sans-serif;
            flex: 0 0 auto;
        }
        .tab-btn.active {
            color: #588157;
            border-bottom-color: #588157;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Forms */
        .module-container {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .form-section {
            margin-bottom: 32px;
        }
        .form-section h3 {
            color: #588157;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        .form-section h4 {
            color: #444;
            font-size: 16px;
            margin: 16px 0 8px 0;
            font-weight: 600;
        }
        .form-row { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #555; }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
        }
        .form-control:focus { border-color: #588157; outline: none; }
        textarea.form-control { min-height: 80px; resize: vertical; line-height: 1.5; }
        
        .section-header-large {
            font-size: 22px;
            font-weight: 700;
            color: #222;
            margin: 40px 0 20px 0;
            font-family: 'Open Sans', Arial, sans-serif;
            border-bottom: 2px solid #588157;
            padding-bottom: 10px;
        }

        /* View Mode */
        .anamnesis-card {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 32px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .anamnesis-header-bar {
            background: #f1f8e9;
            padding: 16px 24px;
            border-bottom: 1px solid #c5e1a5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .author-badge { 
            background: #588157; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; 
        }
        .date-badge { color: #555; font-size: 13px; }
        .anamnesis-view-content { padding: 32px; }
        .view-section { margin-bottom: 24px; }
        .view-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .view-value { font-size: 15px; color: #333; line-height: 1.6; white-space: pre-wrap; }
        .view-value.empty { color: #ccc; font-style: italic; }
        
        /* Grid for Status View */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }
        .status-item {
            background: #fafafa;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        /* Utilities */
        .hidden { display: none !important; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #588157;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* =========================================
           MOBILE OPTIMIZATIONS
           ========================================= */
        
        .mobile-menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 44px;
            height: 44px;
            background: #fff;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            position: fixed;
            top: 18px;
            left: 18px;
            z-index: 3300;
            padding: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .mobile-menu-toggle span {
            display: block;
            width: 26px;
            height: 3px;
            background: #222;
            margin: 4px 0;
            border-radius: 2px;
        }
        #side-menu.mobile-open {
            transform: translateX(0);
        }
        #side-menu.mobile-open ~ .mobile-menu-toggle {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .mobile-back-btn {
            display: none;
            background: none;
            border: none;
            color: #588157;
            cursor: pointer;
            padding: 8px;
            margin-right: 10px;
        }

        @media (max-width: 900px) {
            /* Main Layout */
            .main-content {
                padding-left: 0;
            }
            #side-menu {
                transform: translateX(-100%);
                box-shadow: 2px 0 16px rgba(0,0,0,0.18);
            }
            
            .mobile-menu-toggle {
                display: flex;
            }

            /* Adjust header to account for toggle button */
            .panel-header {
                padding-left: 70px; /* Space for button */
            }

            /* Stacked Panels Logic */
            .patient-list-panel {
                width: 100%;
                display: flex;
            }
            .workspace-panel {
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                width: 100%;
                z-index: 200; /* Above list */
                display: none; /* Hidden by default */
            }
            .workspace-panel.active {
                display: flex;
            }
            
            /* Form Improvements */
            .module-container {
                padding: 16px;
            }
            .workspace-content {
                padding: 0;
            }
            .workspace-header {
                padding: 12px 16px;
            }
            .workspace-title {
                font-size: 1.2rem;
            }
            .mobile-back-btn {
                display: block;
            }
            
            /* Form Elements */
            .form-row {
                flex-direction: column;
                gap: 12px;
            }
            .form-group {
                min-width: 0;
                width: 100%;
                flex: none; /* Reset flex */
            }
            
            /* Cards */
            .anamnesis-view-content {
                padding: 16px;
            }
            .anamnesis-header-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            /* Tab scroll fix */
            .tabs {
                padding-bottom: 0;
                display: flex;
                overflow: hidden;
            }
            .tab-btn {
                flex: 1;
                padding: 10px 2px;
                font-size: 13px;
                text-align: center;
            }
        }
    </style>
  <link rel="stylesheet" href="css/mobile-nav.css">
</head>
<body>


    <div class="sidemenu-overlay" id="sidemenuOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:3100;"></div>

    <!-- Sidebar (Structure from calendar.html) -->
    <div id="side-menu">
        <div class="logo-header">
            <a href="index.html">
                <img class="logo-img" src="svg/logo-coursebook.svg" alt="StudyBoard">
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="base-navigation-button">
                    <a href="https://elearn.mu-varna.bg/ultra/course">
                        <img class="svg-icon" src="svg/icon-blackboard.svg" style="filter: brightness(0) invert(1);">
                        <span>Blackboard</span>
                    </a>
                </li>
                <li class="base-navigation-button">
                    <a href="account.html">
                        <img class="svg-icon" src="svg/icon-account.svg">
                        <span>Account</span>
                    </a>
                </li>
                <li class="base-navigation-button">
                    <a href="index.html"> <!-- Link back to Courses -->
                        <img class="svg-icon" src="svg/icon-courses.svg">
                        <span>Courses</span>
                    </a>
                </li>
                <li class="base-navigation-button active">
                    <a href="anamnesis.html">
                        <img class="svg-icon" src="svg/icon-anamnesis.svg" style="filter: brightness(0) invert(1);">
                        <span>Anamnesis</span>
                    </a>
                </li>
                <li class="base-navigation-button">
                    <a href="calendar.html">
                        <img class="svg-icon" src="svg/icon-calendar.svg">
                        <span>Calendar</span>
                    </a>
                </li>

                <li class="base-navigation-button">
                    <a href="text-editor.html">
                        <img class="svg-icon" src="svg/icon-editor.svg" style="filter: brightness(0) invert(1);">
                        <span>Editor</span>
                    </a>
                </li>
                <li class="base-navigation-button" id="admin-button" style="display: none;">
                    <a href="admin.html">
                        <img class="svg-icon" src="svg/icon-admin.svg" style="filter: brightness(0) invert(1);">
                        <span>Admin Panel</span>
                    </a>
                </li>
                <li class="base-navigation-button">
                    <a href="#" onclick="handleLogout()">
                        <img class="svg-icon" src="svg/icon-signout.svg">
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer-links">
            <span class="sidebar-footer-item">Privacy</span>
            <span class="sidebar-footer-item">Terms</span>
            <span class="sidebar-footer-item">Accessibility</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="anamnesis-layout">
            
            <!-- List Panel -->
            <div class="patient-list-panel" id="patientListPanel">
                <div class="panel-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 style="margin:0; color:#333; font-size: 18px;">Пациенти</h2>
                        <button id="btn-new-mobile-list" class="new-btn mobile-visible" style="padding: 6px 12px; font-size: 14px;">
                            <span class="material-icons" style="font-size: 18px;">add</span>
                        </button>
                    </div>
                    <input type="text" id="patient-search" class="search-box" placeholder="Търсене...">
                </div>
                <ul id="patient-list" class="patient-list"></ul>
            </div>

            <!-- Workspace Panel -->
            <div class="workspace-panel" id="workspacePanel">
                <div class="workspace-header">
                    <div style="display: flex; align-items: center;">
                        <button id="btn-back-mobile" class="mobile-back-btn" type="button">
                            <span class="material-icons" style="font-size: 24px;">arrow_back</span>
                        </button>
                        <h1 id="workspace-title" class="workspace-title">Нова Анамнеза</h1>
                    </div>
                    <button id="btn-new-anamnesis" class="new-btn">
                        <span class="material-icons" style="font-size: 18px;">add</span> <span class="btn-text">Нова</span>
                    </button>
                </div>

                <div class="workspace-content">
                    
                    <!-- FORM VIEW -->
                    <div id="view-form">
                        <form id="anamnesis-form">
                            
                            <div class="module-container">
                                <div class="tabs">
                                    <button type="button" class="tab-btn active" onclick="switchTab('tab-anamnesis')">Анамнеза</button>
                                    <button type="button" class="tab-btn" onclick="switchTab('tab-status')">Статус Презенс</button>
                                    <button type="button" class="tab-btn" onclick="switchTab('tab-notes')">Записки</button>
                                </div>

                                <!-- TAB 1: ANAMNESIS -->
                                <div id="tab-anamnesis" class="tab-content active">
                                    
                                    <div class="form-section">
                                        <h3>1. Въведение и Паспортни Данни</h3>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Име</label>
                                                <input type="text" name="name" class="form-control" required placeholder="Три имена">
                                            </div>
                                            <div class="form-group" style="flex: 0 0 100px;">
                                                <label>Години</label>
                                                <input type="number" name="age" class="form-control" placeholder="Възраст">
                                            </div>
                                            <div class="form-group">
                                                <label>Местоживеене</label>
                                                <input type="text" name="address" class="form-control" placeholder="Населено място">
                                            </div>
                                            <div class="form-group" style="flex: 0 0 120px;">
                                                <label>Пол</label>
                                                <select name="gender" class="form-control">
                                                    <option value="M">Мъж</option>
                                                    <option value="F">Женат</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Прием в Клиниката ("Постъпва за... с оплаквания...")</label>
                                            <textarea name="admission_note" class="form-control" placeholder="Постъпва за пореден път в клиниката със следните оплаквания..."></textarea>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>2. Anamnesis morbi (Сегашно състояние)</h3>
                                        <div class="form-group">
                                            <label>Основно Оплакване</label>
                                            <textarea name="complaint" class="form-control" placeholder="Причина за търсене на помощ"></textarea>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Хронология и Прогрес</label>
                                                <textarea name="chronology" class="form-control" placeholder="Начало, продължителност, развитие..."></textarea>
                                            </div>
                                            <div class="form-group">
                                                <label>Лечение и Предишни Епизоди</label>
                                                <textarea name="history_treatment" class="form-control" placeholder="Предишно лечение, подобни епизоди..."></textarea>
                                            </div>
                                        </div>
                                        
                                        <h4>Детайли по Симптоми</h4>
                                        <div class="form-row">
                                            <div class="form-group"><label>Болка</label><input type="text" name="sym_pain" class="form-control" placeholder="Локализация, характер..."></div>
                                            <div class="form-group"><label>Кашлица</label><input type="text" name="sym_cough" class="form-control" placeholder="Суха/Влажна, храчки..."></div>
                                            <div class="form-group"><label>Задух</label><input type="text" name="sym_dyspnea" class="form-control" placeholder="При усилие/покой..."></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group"><label>Кръвно Налягане</label><input type="text" name="sym_bp_hist" class="form-control" placeholder="Стойности, кризи..."></div>
                                            <div class="form-group"><label>Пулс</label><input type="text" name="sym_pulse" class="form-control" placeholder="уд/мин..."></div>
                                            <div class="form-group"><label>Температура</label><input type="text" name="sym_temp" class="form-control" placeholder="Градуси, втрисване..."></div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>3. Anamnesis vitae (Минали заболявания)</h3>
                                        <div class="form-group">
                                            <label>Прекарани Заболявания и Операции</label>
                                            <textarea name="past_diseases" class="form-control" placeholder="Диабет, хепатит, туберкулоза, пневмонии..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Придружаващи заболявания</label>
                                            <textarea name="concomitant_diseases" class="form-control" placeholder="Хронични заболявания..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Медикаменти (Настоящ и минал прием)</label>
                                            <textarea name="medications" class="form-control" placeholder="Списък лекарства..."></textarea>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>4. Социална и Фамилна</h3>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Навици (Тютюнопушене, Алкохол)</label>
                                                <input type="text" name="habits" class="form-control" placeholder="Пакетогодини, алкохол...">
                                            </div>
                                            <div class="form-group">
                                                <label>Алергии</label>
                                                <input type="text" name="allergies" class="form-control" placeholder="Храни, медикаменти...">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Фамилна История</label>
                                            <textarea name="family_history" class="form-control" placeholder="Наследствени болести, родители..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB 2: STATUS PRAESENS -->
                                <div id="tab-status" class="tab-content">

                                    <div class="form-section">
                                        <h3>1. Общо състояние</h3>
                                        <div class="form-row">
                                            <div class="form-group"><label>Общ вид</label><input type="text" name="st_general" class="form-control" value="Отговаря на възрастта"></div>
                                            <div class="form-group"><label>Съзнание</label><input type="text" name="st_consciousness" class="form-control" value="Ясно, ориентиран"></div>
                                            <div class="form-group"><label>Положение</label><input type="text" name="st_posture" class="form-control" value="Активно"></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group"><label>Кожа и Лигавици</label><input type="text" name="st_skin" class="form-control" value="Розови, запазен тургор"></div>
                                            <div class="form-group"><label>Лимфни възли</label><input type="text" name="st_lymph" class="form-control" value="Не се палпират увеличени"></div>
                                            <div class="form-group"><label>Походка</label><input type="text" name="st_gait" class="form-control" value="Запазена"></div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>2. Глава и Шия</h3>
                                        <div class="form-row">
                                            <div class="form-group"><label>Глава/Очи</label><input type="text" name="st_head" class="form-control" value="Правилна конфигурация, зеници реагиращи"></div>
                                            <div class="form-group"><label>Устна кухина/Език</label><input type="text" name="st_mouth" class="form-control" value="Влажен, необложен език, розови тонзили"></div>
                                            <div class="form-group"><label>Шия/Щитовидна</label><input type="text" name="st_neck" class="form-control" value="Свободно подвижна, не се палпира щитовидна"></div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>3. Дихателна система</h3>
                                        <div class="form-row">
                                            <div class="form-group"><label>Оглед/Гръден кош</label><input type="text" name="st_resp_inspect" class="form-control" value="Симетричен, диафрагмално дишане"></div>
                                            <div class="form-group"><label>Перкусия/Палпация</label><input type="text" name="st_resp_palp" class="form-control" value="Ясен перкуторен тон, запазен фремитус"></div>
                                        </div>
                                        <div class="form-group">
                                            <label>Аускултация</label>
                                            <input type="text" name="st_resp_auscult" class="form-control" value="Везикуларно дишане, без хрипове">
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>4. Сърдечно-съдова система</h3>
                                        <div class="form-row">
                                            <div class="form-group"><label>Оглед и Палпация</label><input type="text" name="st_cardio_inspect_palp" class="form-control" value="Без патологични пулсации, ictus cordis в 5-то м.р."></div>
                                            <div class="form-group"><label>Перкусия (Граници)</label><input type="text" name="st_cardio_percussion" class="form-control" value="Нормални граници на сърдечно притъпление"></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group"><label>Аускултация</label><input type="text" name="st_cardio_auscultation" class="form-control" value="Ритмична дейност, ясни тонове, без шумове"></div>
                                            <div class="form-group"><label>Шиен венозен застой</label><input type="text" name="st_cardio_jvd" class="form-control" value="Не се установява"></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group"><label>АН (RR)</label><input type="text" name="st_bp" class="form-control" placeholder="120/80 mmHg"></div>
                                            <div class="form-group"><label>Пулс</label><input type="text" name="st_pulse" class="form-control" placeholder="72 уд/мин"></div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>5. Корем</h3>
                                        <div class="form-row">
                                            <div class="form-group"><label>Оглед</label><input type="text" name="st_abd_inspect" class="form-control" value="На нивото на гръдния кош, симетричен, участва в дишането"></div>
                                            <div class="form-group"><label>Аускултация</label><input type="text" name="st_abd_auscult" class="form-control" value="Умерена чревна перисталтика"></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group"><label>Перкусия</label><input type="text" name="st_abd_percuss" class="form-control" value="Тимпаничен перкуторен тон"></div>
                                        </div>
                                        <h4>Палпация</h4>
                                        <div class="form-row">
                                            <div class="form-group"><label>Повърхностна</label><input type="text" name="st_abd_palp_super" class="form-control" value="Мекоеластични коремни стени, без болезненост и дефанс"></div>
                                            <div class="form-group"><label>Дълбока</label><input type="text" name="st_abd_palp_deep" class="form-control" value="Не се установяват туморни маси или болезненост"></div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group"><label>Чернодробна област</label><input type="text" name="st_abd_liver" class="form-control" value="Сагитален размер 10 см, долен ръб еластичен, под ребрена дъга"></div>
                                            <div class="form-group"><label>Слезка</label><input type="text" name="st_abd_spleen" class="form-control" value="Надлъжен размер 7 см, не се палпира"></div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <h3>6. Други</h3>
                                        <div class="form-row">
                                            <div class="form-group"><label>Бъбреци (Succ. Renalis)</label><input type="text" name="st_kidney" class="form-control" value="Отрицателен двустранно"></div>
                                            <div class="form-group"><label>Крайници/Отоци</label><input type="text" name="st_limbs" class="form-control" value="Без отоци, запазени пулсации"></div>
                                        </div>
                                    </div>

                                </div>

                                <!-- TAB 3: NOTES -->
                                <div id="tab-notes" class="tab-content">
                                    <div class="form-section">
                                        <div class="form-group">
                                            <label>Допълнителни бележки и коментари</label>
                                            <textarea name="patient_notes" class="form-control" style="min-height: 300px;" placeholder="Въведете вашите записки тук..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div style="text-align: right; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
                                    <button type="submit" class="new-btn" style="font-size: 1.2rem; padding: 14px 40px; display: inline-flex; width: 100%; justify-content: center; box-sizing: border-box;">
                                        <span class="material-icons" style="margin-right:8px;">save</span> Запази Анамнеза
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- DISPLAY VIEW -->
                    <div id="view-display" class="hidden">
                        <div id="anamnesis-container">
                            <!-- Cards will be injected here -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <script src="js/anamnesis.js?v=20260127_v3"></script>
    
    <!-- CHAT SYSTEM -->
    <script src="js/chat.js?v=202404231000"></script>

    <!-- Chat Widget HTML -->
    <div id="chat-widget" class="chat-widget">
      <button class="chat-icon" id="chat-toggle" title="Отвори чат">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span class="chat-badge-count" style="display: none;">0</span>
        <span class="chat-notification-pulse"></span>
      </button>

      <div class="chat-panel">
        <div class="chat-header">
          <div class="chat-header-title">
            <div style="font-size: 18px; font-weight: bold; margin: 0;">Чат</div>
            <span class="chat-online-count" style="font-size: 13px;">Активни: 1</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="chat-header-btn" id="chat-members-toggle" title="Активни членове">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button class="chat-close-btn" id="chat-close" title="Затвори чат">✕</button>
          </div>
        </div>

        <div class="chat-container">
          <div class="chat-messages-wrapper">
            <div class="chat-messages"></div>
          </div>
          <div class="chat-active-users"></div>
        </div>

        <div class="chat-input-area">
          <div class="chat-controls-row">
            <textarea class="chat-input" placeholder="Напиши съобщение..." rows="1" maxlength="500"></textarea>
            <button class="chat-send-btn" title="Изпрати">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.16151496 C3.34915502,0.9 2.40734225,0.9 1.77946707,1.4429026 C0.994623095,2.08 0.837654326,3.0226 1.15159189,3.97788954 L3.03521743,10.4188814 C3.03521743,10.5759788 3.34915502,10.7330762 3.50612381,10.7330762 L16.6915026,11.5185631 C16.6915026,11.5185631 17.1624089,11.5185631 17.1624089,12.0598639 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <style>
    /* CHAT WIDGET STYLING */
    #chat-widget { --chat-primary: #588157; --chat-secondary: #f0ede2; --chat-border: #a3b18a; --chat-text: #000000; --chat-text-light: #000000; }
    .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 5000; font-family: 'Open Sans', Arial, sans-serif; }
    .chat-icon { width: 56px; height: 56px; border-radius: 50%; background: var(--chat-primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(58, 90, 64, 0.3); transition: all 0.3s ease; position: relative; }
    .chat-icon:hover { background: #344e41; box-shadow: 0 6px 16px rgba(93, 64, 55, 0.5); transform: scale(1.1); }
    .chat-badge-count { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); }
    .chat-notification-pulse { position: absolute; top: -6px; right: -6px; width: 16px; height: 16px; background: #22c55e; border-radius: 50%; border: 2px solid white; opacity: 0; transition: opacity 0.3s ease; }
    .chat-panel { position: fixed; bottom: 90px; right: 20px; width: 400px; height: 500px; background: white; border-radius: 12px; box-shadow: 0 5px 40px rgba(0, 0, 0, 0.16); display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .chat-panel.open { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .chat-header { padding: 16px; border-bottom: 1px solid var(--chat-border); display: flex; justify-content: space-between; align-items: flex-start; background: var(--chat-primary); color: white; border-radius: 12px 12px 0 0; }
    .chat-header-title h3 { margin: 0 0 4px 0; font-size: 16px; font-weight: 600; }
    .chat-online-count { font-size: 11px; opacity: 0.9; display: none; }
    .chat-header-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 18px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: background 0.2s; }
    .chat-header-btn:hover { background: rgba(255, 255, 255, 0.3); }

    #chat-members-toggle {
      position: relative;
    }

    .chat-panel:not(.show-members) #chat-members-toggle::after {
      content: "";
      position: absolute;
      top: 15%;
      left: 50%;
      width: 2px;
      height: 70%;
      background: white;
      transform: translateX(-50%) rotate(-45deg);
      border-radius: 1px;
      box-shadow: 0 0 2px rgba(0,0,0,0.3);
    }

    .chat-close-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: background 0.2s; }
    .chat-close-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .chat-container { display: flex; flex: 1; min-height: 0; gap: 0; }
    .chat-messages-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .chat-message { display: flex; gap: 8px; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; flex-shrink: 0; }
    .message-content { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .message-header { display: flex; gap: 8px; align-items: baseline; }
    .message-author { font-weight: 600; font-size: 13px; color: var(--chat-text); }
    .message-time { font-size: 11px; color: var(--chat-text-light); }
    .message-text { font-size: 13px; color: var(--chat-text); word-break: break-word; background: var(--chat-secondary); padding: 8px 10px; border-radius: 8px; line-height: 1.4; }
    .chat-active-users { width: 140px; padding: 12px 8px; border-left: 1px solid var(--chat-border); overflow-y: auto; background: #fafafa; display: none; flex-direction: column; gap: 8px; min-width: 0; }
    .chat-panel.show-members .chat-active-users { display: flex; }
    .active-users-header { font-size: 11px; font-weight: 600; color: var(--chat-text-light); padding: 0 4px; text-transform: uppercase; }
    .active-user { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--chat-text); padding: 4px; border-radius: 6px; cursor: pointer; transition: background 0.2s; min-width: 0; }
    .active-user:hover { background: var(--chat-secondary); }
    .active-user-badge { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px; flex-shrink: 0; }
    .active-user span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 11px; }
    .chat-input-area { display: flex; gap: 12px; padding: 12px; border-top: 1px solid var(--chat-border); background: #fafafa; }
    .chat-input { flex: 0.98; border: 1px solid var(--chat-border); border-radius: 8px; padding: 8px 12px; font-size: 13px; font-family: inherit; outline: none; transition: all 0.2s; resize: none; }
    .chat-input:focus { border-color: var(--chat-primary); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
    .chat-send-btn { width: 36px; height: 36px; border: none; background: var(--chat-primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
    .chat-send-btn:hover { transform: scale(1.05); }
    .chat-send-btn:active { transform: scale(0.95); }
    .chat-user-info { padding: 8px 12px; font-size: 11px; color: var(--chat-text-light); border-top: 1px solid var(--chat-border); background: #fafafa; border-radius: 0 0 12px 12px; }
    #current-user-name { color: var(--chat-primary); font-weight: 600; }
    @media (max-width: 600px) {
      .chat-panel { width: calc(100vw - 40px); height: 65vh; bottom: 100px; right: 20px; left: 20px; max-width: none; }
      .chat-active-users { display: none; }
      .chat-panel.show-members .chat-active-users { display: flex; position: absolute; right: 0; top: 75px; bottom: 67px; z-index: 10; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
      .chat-online-count { display: block; }
      .chat-widget { bottom: 10px; right: 10px; }
      .chat-icon { width: 48px; height: 48px; }
    }
    .chat-messages::-webkit-scrollbar, .chat-active-users::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track, .chat-active-users::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb, .chat-active-users::-webkit-scrollbar-thumb { background: var(--chat-border); border-radius: 3px; }
    .chat-messages::-webkit-scrollbar-thumb:hover, .chat-active-users::-webkit-scrollbar-thumb:hover { background: var(--chat-text-light); }
    </style>

    <script>
        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            
            // Find and activate the correct button
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(btn => {
                if (btn.getAttribute('onclick').includes(tabId)) {
                    btn.classList.add('active');
                }
            });
        }

        // Admin button check
        document.addEventListener('DOMContentLoaded', function() {
            const adminButton = document.getElementById('admin-button');
            if (adminButton && window.currentUserPromise) {
            window.currentUserPromise.then(user => {
                if (user && user.isAdmin) {
                adminButton.style.display = 'list-item';
                }
            }).catch(error => {
                console.error("Error checking admin status:", error);
            });
            }
        });
    </script>
<script src="js/mobile-nav.js"></script>
</body>
</html>